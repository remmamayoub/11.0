<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clinique du Val MDT - Gestion des Offres</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #333;
      min-height: 100vh;
      overflow-x: hidden; /* Éviter scroll horizontal global */
    }
    /* === HEADER === */
    header {
      background: linear-gradient(90deg, #1e3d7d, #2a5bb5);
      color: white;
      text-align: center;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    header p {
      font-size: 1rem;
      opacity: 0.9;
      margin-top: 5px;
    }
    /* === CONTAINER === */
    .container {
      display: flex;
      width: 100%;
      margin: 20px auto;
      gap: 20px;
      padding: 0 15px;
    }
    /* === SIDEBAR MENU (Agrandir et centrer) === */
    #sidebar {
      width: 300px; /* Agrandir le panneau de menu */
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      height: fit-content;
      display: flex;
      flex-direction: column;
      align-items: center; /* Centrer les éléments */
    }
    .menu-title {
      font-weight: 600;
      color: #1e3d7d;
      margin-bottom: 20px;
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .menu-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      width: 100%; /* Prendre toute la largeur pour centrer */
      justify-items: center; /* Centrer les boutons */
    }
    .menu-btn {
      background: #f8f9fc;
      border: 2px solid #e0e6ed;
      border-radius: 12px;
      padding: 18px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      color: #444;
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      width: 120px; /* Largeur fixe pour alignement */
    }
    .menu-btn .material-icons {
      font-size: 28px;
      color: #1e3d7d;
      transition: color 0.3s ease; /* Ajouter transition couleur */
    }
    .menu-btn:hover {
      background: #1e3d7d;
      color: white;
      border-color: #1e3d7d;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(30, 61, 125, 0.2);
    }
    .menu-btn:hover .material-icons {
      color: #ffd700; /* Ajouter couleur or sur hover pour symboles */
    }
    .menu-btn.active {
      background: #1e3d7d;
      color: white;
      border-color: #1e3d7d;
    }
    .menu-btn.active .material-icons {
      color: #00ff00; /* Vert pour active */
    }
    /* === CONTENT === */
    #content {
      flex: 1;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      min-height: 80vh;
      overflow-x: auto; /* Activer scroll horizontal dans content */
      width: 100%;
    }
    /* === CARD LAYOUT === */
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid #eef2f7;
    }
    .card h2 {
      color: #1e3d7d;
      margin-bottom: 15px;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card h2 .material-icons {
      font-size: 24px;
      color: #1e3d7d; /* Couleur bleue pour icônes titres */
    }
    /* === FORM ROWS (Aligner et réduire largeur) === */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Réduire largeur champs, auto-align */
      gap: 15px;
      margin-bottom: 15px;
      justify-items: start; /* Aligner à gauche */
    }
    .form-group {
      display: flex;
      flex-direction: column;
      max-width: 250px; /* Diminuer largeur des champs */
      width: 100%;
    }
    .form-group.full {
      grid-column: span 2;
      max-width: 100%;
    }
    label {
      font-weight: 600;
      color: #444;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }
    input, select, textarea {
      padding: 10px 12px;
      border: 1.5px solid #d0d7e0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      max-width: 100%; /* Éviter dépassement */
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #1e3d7d;
      box-shadow: 0 0 0 3px rgba(30, 61, 125, 0.15);
    }
    input.valid {
      border-color: #28a745;
      background: #f8fff9;
    }
    input.invalid {
      border-color: #dc3545;
      background: #fff8f8;
    }
    .validation-icon {
      position: absolute;
      right: 10px;
      top: 38px;
      font-size: 20px;
      color: inherit;
    }
    .input-wrapper {
      position: relative;
    }
    /* === BUTTONS === */
    button {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    .btn-primary {
      background: #1e3d7d;
      color: white;
    }
    .btn-primary:hover {
      background: #152b5a;
      transform: translateY(-2px);
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 0.85rem;
    }
    /* === ACT ROWS (Aligner) === */
    .act-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Alignement auto, réduction largeur */
      gap: 10px;
      align-items: center;
      padding: 10px;
      background: #f8f9fc;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .personnel-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      max-width: 500px; /* Limiter largeur */
    }
    .personnel-row input {
      flex: 1;
      margin-right: 10px;
    }
    .personnel-row .taux-input {
      width: 100px;
      margin-left: 10px;
    }
    .materiel-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .materiel-item input {
      width: auto;
      margin-right: 10px;
    }
    /* === TOTAL BOX (Ajouter "Total Net") === */
    .total-box {
      background: linear-gradient(135deg, #1e3d7d, #2a5bb5);
      color: white;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 15px 0;
    }
    .total-box.good { background: linear-gradient(135deg, #28a745, #218838); }
    .total-box.bad { background: linear-gradient(135deg, #dc3545, #c82333); }
    /* === TABLE (Réduire largeur pour éviter scroll) === */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.9rem;
    }
    th, td {
      padding: 12px;
      text-align: left;
    }
    th {
      background: #1e3d7d;
      color: white;
    }
    td {
      border-bottom: 1px solid #eef2f7;
    }
    tr:hover {
      background: #f8f9fc;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
    }
    .totals-summary {
      margin: 12px 0;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #f8f9fa;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-weight: 600;
    }
    /* === RAPPROCHEMENT GRID === */
    .reconciliation-grid {
      display: grid;
      grid-template-columns: 1.3fr 1fr 1fr 1fr;
      gap: 8px;
      align-items: center;
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fc;
      border: 1px solid #e6e9ef;
      border-radius: 10px;
    }
    .reconciliation-grid .header {
      font-weight: 700;
      color: #1e3d7d;
    }
    .reconciliation-grid .cell {
      padding: 6px 8px;
      border-bottom: 1px solid #e6e9ef;
    }
    .reconciliation-grid .row-title {
      font-weight: 600;
    }
    .reconciliation-grid .delta-positive { color: #28a745; }
    .reconciliation-grid .delta-negative { color: #dc3545; }
    .reconciliation-note {
      margin-top: 10px;
      color: #555;
      font-size: 0.9rem;
    }
    /* === HOME PAGE === */
    #homeTab {
      text-align: center;
      padding: 40px 20px;
    }
    #homeTab img {
      max-width: 100%;
      height: auto;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      margin: 20px 0;
    }
    #homeTab h1 {
      font-size: 2.5rem;
      color: #1e3d7d;
      margin-bottom: 15px;
    }
    #homeTab p {
      font-size: 1.1rem;
      color: #555;
      max-width: 700px;
      margin: 0 auto 30px;
    }
    /* === SUB-TABS FOR SUIVI === */
    .sub-tabs {
      display: flex;
      margin-bottom: 20px;
      gap: 10px;
    }
    .sub-tab-btn {
      padding: 10px 20px;
      border: none;
      background: #f8f9fc;
      color: #444;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .sub-tab-btn.active {
      background: #1e3d7d;
      color: white;
    }
    .sub-tab-content {
      display: none;
    }
    .sub-tab-content.active {
      display: block;
    }
    /* === ERROR / SUCCESS === */
    .alert {
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: fadeIn 0.5s;
    }
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    /* === HIDDEN === */
    .tab { display: none; }
    .tab.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    /* === RESPONSIVE === */
    @media (max-width: 992px) {
      .container { flex-direction: column; }
      #sidebar { width: 100%; }
      .form-row { grid-template-columns: 1fr; }
      .act-row { grid-template-columns: 1fr; }
      .sub-tabs { flex-direction: column; }
    }
    .site-panel {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      background: #f8f9fc;
    }
    .site-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .site-controls-left {
      display: flex;
      gap: 10px;
    }
    .site-controls-right {
      display: flex;
      gap: 10px;
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .pagination button {
      margin: 0 5px;
    }
    .pagination span {
      margin: 0 5px;
      cursor: pointer;
    }
    .pagination .active-page {
      font-weight: bold;
    }
    /* Styles pour Rémunération */
    .remun-personnel {
      cursor: pointer;
      background: #f8f9fc;
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 8px;
    }
    .remun-missions {
      display: none;
      padding-left: 20px;
    }
    .remun-mission-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 5px;
    }
    .remun-section {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      background: #f9f9f9;
    }
    .remun-section h3 {
      margin-bottom: 10px;
      color: #1e3d7d;
    }
    .remun-section .add-btn {
      margin-bottom: 10px;
    }
    .remun-filter {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .observation-section {
      margin-top: 10px;
    }
    .observation-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 6px 0;
      font-weight: 600;
      flex-wrap: wrap;
    }
    .required-observation {
      color: red;
      font-weight: bold;
      font-size: 0.9rem;
      margin-top: 5px;
    }
    .personnel-calcule-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .personnel-calcule-row .form-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .horizontal-scroll {
      overflow-x: auto;
      white-space: nowrap;
    }
    .data-notif {
      color: red;
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    .loader {
      display: none;
      border: 16px solid #f3f3f3;
      border-top: 16px solid #3498db;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .sites-container {
      margin-top: 20px;
    }
    .add-site-btn {
      margin-bottom: 20px;
    }
    .site-navigation {
      display: none;
      margin-bottom: 10px;
      gap: 10px;
    }
    
    /* === ACCORDION COMPACT - NOUVEAU DESIGN === */
    .personnel-row-accordion {
      border: 1px solid #dae8f0;
      border-radius: 8px;
      margin-bottom: 10px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    
    .accordion-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: linear-gradient(90deg, #1e3d7d 0%, #2d5fa3 100%);
      color: white;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }
    
    .accordion-header:hover {
      background: linear-gradient(90deg, #153060 0%, #23468a 100%);
    }
    
    .accordion-toggle {
      font-weight: bold;
      font-size: 0.9rem;
      transition: transform 0.2s ease;
      display: inline-block;
      min-width: 20px;
    }
    
    .accordion-header .name-input {
      flex: 1;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      font-weight: 500;
      background: rgba(255,255,255,0.9);
      color: #1e3d7d;
      font-size: 0.95rem;
    }
    
    .accordion-header .name-input::placeholder {
      color: #9db4d1;
    }
    
    .accordion-distance, .accordion-depl, .accordion-final {
      font-weight: 500;
      font-size: 0.9rem;
      min-width: 60px;
      text-align: right;
    }
    
    .accordion-final {
      color: #ffeb3b;
      font-weight: bold;
      font-size: 0.95rem;
    }
    
    .accordion-header .btn-mini {
      padding: 4px 8px;
      font-size: 0.75rem;
      min-width: 35px;
    }
    
    .accordion-content {
      display: none;
      padding: 20px;
      background: #ffffff;
      border-top: 1px solid #eef2f7;
      animation: slideDown 0.2s ease;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
      }
      to {
        opacity: 1;
        max-height: 2000px;
      }
    }
    
    .accordion-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eef2f7;
    }
    
    .accordion-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .accordion-section h4 {
      color: #1e3d7d;
      margin-bottom: 15px;
      font-size: 1.05rem;
      font-weight: 600;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 15px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: 500;
      margin-bottom: 6px;
      color: #333;
      font-size: 0.9rem;
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group textarea {
      padding: 8px 12px;
      border: 1px solid #dae8f0;
      border-radius: 6px;
      font-size: 0.9rem;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }
    
    .form-group input[type="text"]:focus,
    .form-group input[type="number"]:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #1e3d7d;
      box-shadow: 0 0 4px rgba(30, 61, 125, 0.1);
    }
    
    .radio-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .radio-group input[type="radio"] {
      width: auto;
      margin-right: 4px;
      cursor: pointer;
    }
    
    .radio-group label {
      margin: 0;
      font-weight: normal;
      cursor: pointer;
    }
    
    .summary-row {
      background: #f8f9fc;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #1e3d7d;
      grid-column: 1 / -1;
      align-items: center;
    }
    
    .label-inline {
      font-weight: 500;
      color: #333;
    }
    
    .summary-row span:not(.label-inline) {
      font-weight: bold;
      color: #1e3d7d;
      margin-right: 5px;
    }
    
    .summary-section {
      background: linear-gradient(135deg, #f0f5fb 0%, #e8eef8 100%);
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #1e3d7d;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .summary-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #1e3d7d;
    }
    
    .summary-item.highlight {
      background: linear-gradient(135deg, #fff3cd 0%, #fff9e6 100%);
      border-left-color: #ffeb3b;
      font-weight: bold;
    }
    
    .summary-item label {
      display: block;
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 6px;
    }
    
    .summary-item span {
      display: block;
      font-size: 1.1rem;
      font-weight: bold;
      color: #1e3d7d;
    }
    
    .summary-item.highlight span {
      color: #d39e00;
    }
    
    .observation {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 1px solid #dae8f0;
      border-radius: 6px;
      font-family: inherit;
      resize: vertical;
    }
      gap: 20px;
      margin: 10px 0;
    }
    
    .aller-retour-group input[type="radio"] {
      width: auto;
      cursor: pointer;
    }
    
    .aller-retour-group label {
      margin: 0;
      font-weight: 400;
      cursor: pointer;
    }
    
    .personnel-row-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 15px;
      background: linear-gradient(135deg, #f0f4ff 0%, #e0e6ff 100%);
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid #1e3d7d;
    }
    
    .summary-item {
      text-align: center;
      padding: 10px;
    }
    
    .summary-item label {
      display: block;
      color: #1e3d7d;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .summary-item span {
      display: block;
      font-size: 1.3rem;
      font-weight: 700;
      color: #1e3d7d;
    }
    
    .observation-section {
      margin-bottom: 15px;
    }
    
    .observation-section label {
      font-weight: 600;
      color: #1e3d7d;
      margin-bottom: 8px;
    }
    
    .observation-section textarea {
      width: 100%;
      min-height: 60px;
      resize: vertical;
    }
    
    /* === SYNTHÈSE PAIEMENTS === */
    .synthese-paiements {
      background: linear-gradient(135deg, #e8f4f8 0%, #d4e8f0 100%);
      border: 2px solid #1e3d7d;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .synthese-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #1e3d7d;
      font-weight: 500;
    }
    
    .synthese-item.total {
      background: linear-gradient(135deg, #1e3d7d 0%, #2a5bb5 100%);
      color: white;
      border-left-color: #ffffff;
      font-weight: 700;
      font-size: 1.1rem;
    }
    /* === NOTIFICATIONS === */
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
    }
    .notification-item {
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
      background: #fff3e0;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .notification-item:hover {
      background: #ffe0b2;
      transform: translateX(-3px);
    }
    .notification-item.unread {
      background: #fff3e0;
      border-left-color: #ff9800;
    }
    .notification-item.read {
      background: #f5f5f5;
      border-left-color: #ccc;
    }
    .notification-item.urgent {
      background: #ffebee;
      border-left-color: #f44336;
    }
    .notification-time {
      font-size: 0.8rem;
      color: #666;
      margin-top: 5px;
    }
    /* === DASHBOARD STYLES === */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .dashboard-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    .dashboard-card h3 {
      margin: 0 0 10px 0;
      color: #1e3d7d;
      font-size: 1.1rem;
    }
    .dashboard-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #2a5bb5;
      margin: 10px 0;
    }
    .dashboard-label {
      color: #666;
      font-size: 0.9rem;
    }
    .dashboard-card.success {
      border-left: 4px solid #28a745;
    }
    .dashboard-card.warning {
      border-left: 4px solid #ff9800;
    }
    .dashboard-card.danger {
      border-left: 4px solid #f44336;
    }
    .dashboard-card.info {
      border-left: 4px solid #2196f3;
    }
    .top-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .top-list-item {
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .top-list-item .rank {
      font-weight: bold;
      color: #1e3d7d;
      margin-right: 10px;
    }
    .top-list-item .name {
      flex: 1;
    }
    .top-list-item .value {
      font-weight: bold;
      color: #28a745;
    }
    /* === BADGES === */
    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
    }
    .badge-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .badge-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    /* === AUTH MODAL === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      width: 420px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .modal-content h3 {
      margin-bottom: 15px;
      color: #1e3d7d;
    }
    .modal-content .form-group {
      max-width: 100%;
    }
    .permissions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Clinique du Val MDT</h1>
      <p>Gestion Intelligente des Offres Médicales</p>
    </div>
    <div style="display: flex; gap: 15px; align-items: center;">
      <div id="user-info" style="color: white; font-size: 14px;"></div>
      <div id="notificationBell" style="position: relative; cursor: pointer;" onclick="toggleNotificationPanel()">
        <span class="material-icons" style="font-size: 32px;">notifications</span>
        <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
      </div>
      <button class="btn-primary" onclick="toggleFullScreen()"><span class="material-icons">fullscreen</span> Plein Écran</button>
    </div>
  </header>
  <div id="notificationPanel" style="display: none; position: fixed; top: 80px; right: 20px; width: 350px; max-height: 400px; overflow-y: auto; background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); z-index: 1000; padding: 20px;">
    <h3 style="margin-bottom: 15px; color: #1e3d7d;">Notifications</h3>
    <div id="notificationList"></div>
  </div>
  <div id="loginModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>Connexion</h3>
      <div class="form-group">
        <label for="loginUsername">Nom d'utilisateur</label>
        <input id="loginUsername" type="text">
      </div>
      <div class="form-group">
        <label for="loginPassword">Mot de passe</label>
        <input id="loginPassword" type="password">
      </div>
      <button class="btn-primary" style="margin-top:10px;" onclick="attemptLogin()">Se connecter</button>
    </div>
  </div>
  <div class="container">
    <nav id="sidebar">
      <div class="menu-title">Menu Principal</div>
      <div class="menu-grid">
        <div class="menu-btn" data-tab="homeTab">
          <span class="material-icons">home</span>
          Accueil
        </div>
        <div class="menu-btn" data-tab="packTab">
          <span class="material-icons">inventory_2</span>
          Offre
        </div>
        <div class="menu-btn" data-tab="calculeTab">
          <span class="material-icons">calculate</span>
          R-H
        </div>
        <div class="menu-btn" data-tab="offreTab">
          <span class="material-icons">description</span>
          Programmation
        </div>
        <div class="menu-btn" data-tab="medTab">
          <span class="material-icons">local_hospital</span>
          Médecin
        </div>
        <div class="menu-btn" data-tab="infTab">
          <span class="material-icons">healing</span>
          Infirmier
        </div>
        <div class="menu-btn" data-tab="techTab">
          <span class="material-icons">biotech</span>
          Tech Radio
        </div>
        <div class="menu-btn" data-tab="coordTab">
          <span class="material-icons">supervisor_account</span>
          Coordinateur
        </div>
        <div class="menu-btn" data-tab="matTab">
          <span class="material-icons">build</span>
          Matériel
        </div>
        <div class="menu-btn" data-tab="commercialTab">
          <span class="material-icons">business_center</span>
          Commercial
        </div>
        <div class="menu-btn" data-tab="entrepriseTab">
          <span class="material-icons">apartment</span>
          Entreprise
        </div>
        <div class="menu-btn" data-tab="suiviTab">
          <span class="material-icons">track_changes</span>
          Suivi Missions
        </div>
        <div class="menu-btn" data-tab="editTab">
          <span class="material-icons">edit</span>
          Modifier Mission
        </div>
        <div class="menu-btn" data-tab="acteTab">
          <span class="material-icons">list_alt</span>
          Actes
        </div>
        <div class="menu-btn" data-tab="remunTab">
          <span class="material-icons">attach_money</span>
          Rémunération
        </div>
        <div class="menu-btn" data-tab="paiementsTab">
          <span class="material-icons">payment</span>
          Paiements
        </div>
        <div class="menu-btn" data-tab="dataPackTab">
          <span class="material-icons">data_usage</span>
          Data Offre
        </div>
        <div class="menu-btn" data-tab="dataCalculeTab">
          <span class="material-icons">calculate</span>
          Data Opération R-H
        </div>
        <div class="menu-btn" data-tab="financeTab">
          <span class="material-icons">account_balance</span>
          Finance
        </div>
        <div class="menu-btn" data-tab="dashboardTab">
          <span class="material-icons">dashboard</span>
          Tableau de Bord
        </div>
        <div class="menu-btn" data-tab="progPersonnelTab">
          <span class="material-icons">people</span>
          Prog. Personnel
        </div>
        <div class="menu-btn" data-tab="progMaterielTab">
          <span class="material-icons">build_circle</span>
          Prog. Matériel
        </div>
        <div class="menu-btn" data-tab="renouvellementTab">
          <span class="material-icons">autorenew</span>
          Renouvellement
        </div>
        <div class="menu-btn" data-tab="adminTab">
          <span class="material-icons">admin_panel_settings</span>
          Administration
        </div>
        <div class="menu-btn" data-tab="settingsTab">
          <span class="material-icons">settings</span>
          Paramètres
        </div>
        <div class="menu-btn" data-tab="auditTab">
          <span class="material-icons">history</span>
          Audit Trail
        </div>
      </div>
    </nav>
    <main id="content">
      <div class="loader" id="loader"></div>
      <!-- PAGE D'ACCUEIL -->
      <div id="homeTab" class="tab active">
        <h1>Bienvenue sur la plateforme MDT</h1>
        <p>Gérez vos offres médicales en toute simplicité avec un outil moderne, rapide et sécurisé.</p>
        <div class="dashboard-grid" id="quickStats" style="margin:20px 0;">
          <div class="dashboard-card info">
            <h3>Offres totales</h3>
            <div class="dashboard-value" id="stat-total-offres">0</div>
            <div class="dashboard-label">Enregistrées</div>
          </div>
          <div class="dashboard-card success">
            <h3>Revenu cumulé</h3>
            <div class="dashboard-value" id="stat-total-revenue">0</div>
            <div class="dashboard-label">DA</div>
          </div>
          <div class="dashboard-card warning">
            <h3>Marge nette moyenne</h3>
            <div class="dashboard-value" id="stat-marge-moy">0%</div>
            <div class="dashboard-label">Sur les offres</div>
          </div>
        </div>
        <img src="https://i.imgur.com/4JItl7x.jpg" alt="Clinique du Val MDT">
        <p><strong>Prêt à commencer ?</strong> Sélectionnez une action dans le menu.</p>
      </div>
      <!-- PACK TAB -->
      <div id="packTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">inventory_2</span> Création de Pack</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="packName">Pack:</label>
              <div class="input-wrapper">
                <input id="packName" type="text" oninput="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="commercialPack">Commercial:</label>
              <div class="input-wrapper">
                <input id="commercialPack" list="commercialList" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
              <datalist id="commercialList"></datalist>
            </div>
            <div class="form-group">
              <label for="entreprise">Entreprise:</label>
              <div class="input-wrapper">
                <input id="entreprise" list="entrepriseList" oninput="checkEntrepriseCommercial()" onblur="validateInput(this, v => availableEntreprises.includes(v))">
                <span class="material-icons validation-icon"></span>
              </div>
              <datalist id="entrepriseList"></datalist>
            </div>
          </div>
          <div id="entrepriseAlert" class="alert" style="display:none;"></div>
          <div class="form-row">
            <div class="form-group">
               <label for="nbrEmployePack">Nbr Employée Total:</label>
               <input id="nbrEmployePack" type="number" readonly>
             </div>
            </div>
          <div class="card">
            <h2>Calcules Globaux</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="global-calcule-jour-medecin">Calcule Jour Médecin:</label>
                <div class="input-wrapper">
                  <input id="global-calcule-jour-medecin" type="number" value="20" oninput="recalcAllNbrJour()" onblur="validateInput(this, v => parseInt(v) > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="global-calcule-jour-infirmier">Calcule Jour Infirmier:</label>
                <div class="input-wrapper">
                  <input id="global-calcule-jour-infirmier" type="number" value="30" oninput="recalcAllNbrJour()" onblur="validateInput(this, v => parseInt(v) > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="global-calcule-jour-tech-radio">Calcule Jour Tech-Radio:</label>
                <div class="input-wrapper">
                  <input id="global-calcule-jour-tech-radio" type="number" value="30" oninput="recalcAllNbrJour()" onblur="validateInput(this, v => parseInt(v) > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
          </div>
          <button class="btn-primary add-site-btn" onclick="addSitePanel()"><span class="material-icons">add</span> Ajouter Site</button>
          <div class="site-navigation" id="siteNavigationPack" style="display: none;">
           <button class="btn-primary" onclick="switchSitePack(-1)"><span class="material-icons">arrow_back</span> Précédent</button>
           <button class="btn-primary" onclick="switchSitePack(1)"><span class="material-icons">arrow_forward</span> Suivant</button>
           <button class="btn-danger" onclick="removeActiveSitePack()"><span class="material-icons">delete</span> Supprimer</button>
          </div>
          <div class="sub-tabs" id="siteTabsPack"></div>
          <div id="siteContentsPack"></div>
          <div class="total-box" style="display:none;">Total Revenue: <span id="totalRevenue">0.00</span></div>
          <div class="total-box" style="display:none;">Total Coût Paramètre: <span id="totalCost">0.00</span></div>
          <button class="btn-success" data-permission="ajouter" onclick="if(requirePermission('ajouter')) createPack();"><span class="material-icons">save</span> Enregistrer Pack</button>
          <div id="packError" class="error"></div>
        </div>
      </div>
      <!-- CALCULE TAB -->
      <div id="calculeTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">calculate</span> Calcule d'Offre</h2>
          <div class="card">
            <h2>Calcules Globaux</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="global-calcule-jour-medecin-calcule">Calcule Jour Médecin:</label>
                <div class="input-wrapper">
                  <input id="global-calcule-jour-medecin-calcule" type="number" value="20" oninput="recalcAllNbrJourCalcule()" onblur="validateInput(this, v => parseInt(v) > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="global-calcule-jour-infirmier-calcule">Calcule Jour Infirmier:</label>
                <div class="input-wrapper">
                  <input id="global-calcule-jour-infirmier-calcule" type="number" value="30" oninput="recalcAllNbrJourCalcule()" onblur="validateInput(this, v => parseInt(v) > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="global-calcule-jour-tech-radio-calcule">Calcule Jour Tech-Radio:</label>
                <div class="input-wrapper">
                  <input id="global-calcule-jour-tech-radio-calcule" type="number" value="30" oninput="recalcAllNbrJourCalcule()" onblur="validateInput(this, v => parseInt(v) > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="statutCalcule">Statut:</label>
              <div class="input-wrapper">
                <select id="statutCalcule" onchange="loadEnterprisesByStatus(); applyCalculeFilters()">
                  <option value="à calculer">à calculer</option>
                  <option value="calculer">calculer</option>
                </select>
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="entrepriseCalcule">Entreprise:</label>
              <div class="input-wrapper">
                <input id="entrepriseCalcule" list="entrepriseListCalcule" oninput="loadPacksByEnterpriseAndStatus(); applyCalculeFilters()" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
              <datalist id="entrepriseListCalcule"></datalist>
            </div>
          </div>
          <div class="form-group full">
            <label for="packInputCalcule">Offre:</label>
            <div class="input-wrapper">
              <input id="packInputCalcule" list="packListCalcule" oninput="updateFromPackCalcule()" onchange="updateFromPackCalcule()" onblur="validateInput(this, v => v.trim().length > 0)">
              <span class="material-icons validation-icon"></span>
            </div>
            <datalist id="packListCalcule"></datalist>
          </div>
          <div id="packInfoCalcule">
            <div class="form-row">
              <div class="form-group">
                <label for="nbrEmployeCalcule">Nbr Employée:</label>
                <input id="nbrEmployeCalcule" type="number" readonly>
              </div>
              <div class="form-group">
                <label>Total Prix Pack: <span id="packTotalPrixCalcule">0.00</span></label>
              </div>
            </div>
            <h3>Actes:</h3>
            <div id="actsDisplay"></div>
            <div id="sitesContainerCalcule" style="display:none;">
              <div class="sub-tabs" id="siteTabsCalcule"></div>
              <div id="siteContentsCalcule"></div>
            </div>
           </div>
           <datalist id="wilayaList"></datalist>
           <datalist id="medList"></datalist>
           <datalist id="infList"></datalist>
            <datalist id="techList"></datalist>
          <div class="card" style="margin-top:18px;">
            <h3>Résumé Financier</h3>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Poste</th>
                    <th>Montant (DA)</th>
                  </tr>
                </thead>
                <tbody id="financialSummaryBody">
                  <tr><td colspan="2" style="text-align:center;">Sélectionnez une offre pour voir le résumé.</td></tr>
                </tbody>
              </table>
            </div>
          <button class="btn-primary" style="margin-top:12px;" onclick="renderReconciliationView();"><span class="material-icons">refresh</span> Actualiser le résumé</button>
          </div>
          <div class="alert alert-success" id="autoSaveNotice" style="margin-top:12px; display:none;">
            <span class="material-icons">save</span> Sauvegarde automatique activée
          </div>
          <div id="calculeError" class="error"></div>
        </div>
      </div>
      <!-- OFFRE TAB -->
      <div id="offreTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">description</span> Création d'Offre</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="coordination">Coordination:</label>
              <div class="input-wrapper">
                <input id="coordination" list="coordList" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
              <datalist id="coordList"></datalist>
            </div>
            <div class="form-group">
              <label for="dateOperation">Date Operation:</label>
              <div class="input-wrapper">
                <input id="dateOperation" type="date" oninput="updateDateFinOffre()" onblur="validateInput(this, v => !!v)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="entrepriseOffre">Entreprise:</label>
              <div class="input-wrapper">
                <input id="entrepriseOffre" list="entrepriseList" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
              <datalist id="entrepriseList"></datalist>
            </div>
            <div class="form-group">
              <label for="packInput">Pack:</label>
              <div class="input-wrapper">
                <input id="packInput" list="packList" oninput="updateFromPack('')" onchange="updateFromPack('')" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
              <datalist id="packList"></datalist>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="dateEnreg">Date D'enregistrement:</label>
              <div class="input-wrapper">
                <input id="dateEnreg" type="date" onblur="validateInput(this, v => !!v)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="lieuEntreprise">Lieu d'entreprise (Daira):</label>
              <div class="input-wrapper">
                <input id="lieuEntreprise" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="deplacement">Déplacement:</label>
              <div class="input-wrapper">
                <select id="deplacement" onblur="validateInput(this, v => !!v)">
                </select>
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="nbrJoursOffre">Nbr de Jour Ope:</label>
              <div class="input-wrapper">
                <input id="nbrJoursOffre" type="number" oninput="updateDateFinOffre()" onblur="validateInput(this, v => v > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="dateFinOffre">Date fin Ope:</label>
              <div class="input-wrapper">
                <input id="dateFinOffre" type="date" oninput="updateNbrJoursOffre()" onblur="validateInput(this, v => !!v)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="statut">Statut:</label>
              <div class="input-wrapper">
                <select id="statut" onblur="validateInput(this, v => !!v)">
                  <option value="offre en traitement">Offre en traitement</option>
                  <option value="offre calculé">Offre calculé</option>
                </select>
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="prixVisiteLieux">Prix Visite des Lieux:</label>
              <div class="input-wrapper">
                <input id="prixVisiteLieux" type="number" value="30000" readonly style="background-color: #f0f0f0; cursor: not-allowed;" title="Ce champ ne peut être modifié que par l'administrateur">
                <span class="material-icons validation-icon"></span>
              </div>
              <small style="color: #666;">⚠️ Modifiable uniquement par l'admin</small>
            </div>
            <div class="form-group">
              <label for="chargeSupplementaire">Charge Supplémentaire:</label>
              <div class="input-wrapper">
                <input id="chargeSupplementaire" type="number" value="0">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-group full">
            <label for="observation">Observation:</label>
            <div class="input-wrapper">
              <input id="observation" type="text" onblur="validateInput(this, v => true)"> <!-- Optional -->
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="total-box">Total Pack: <span id="packTotalPrix">0.00</span></div>
          <div class="total-box">Total charge: <span id="totalCharge">0.00</span></div>
          <div class="total-box" id="totalOperationBox">Total Net: <span id="totalOperation">0.00</span></div>
          
          <!-- Financial Summary Table -->
          <div class="card" style="margin-top: 20px;">
            <h3><span class="material-icons">assessment</span> Résumé Financier Détaillé</h3>
            <div style="overflow-x: auto;">
              <table class="data-table" style="width: 100%;">
                <thead>
                  <tr>
                    <th>Catégorie</th>
                    <th>Montant (DA)</th>
                  </tr>
                </thead>
                <tbody id="financialSummaryBody">
                  <tr class="revenue-row">
                    <td><strong>Total Revenu (Chiffre d'Affaires)</strong></td>
                    <td><strong><span id="summaryRevenu">0.00</span> DA</strong></td>
                  </tr>
                  <tr>
                    <td colspan="2" style="background-color: #f8f9fa; font-weight: bold;">Charges:</td>
                  </tr>
                  <tr>
                    <td style="padding-left: 20px;">Rémunération Personnel (Médecin + Infirmier + Tech-Radio)</td>
                    <td><span id="summaryRemuneration">0.00</span> DA</td>
                  </tr>
                  <tr>
                    <td style="padding-left: 20px;">Charge Logistique (Transport + Hébergement)</td>
                    <td><span id="summaryChargeLogistique">0.00</span> DA</td>
                  </tr>
                  <tr>
                    <td style="padding-left: 20px;">Yalidine</td>
                    <td><span id="summaryYalidine">0.00</span> DA</td>
                  </tr>
                  <tr>
                    <td style="padding-left: 20px;">Coût Paramètres</td>
                    <td><span id="summaryCoutParametres">0.00</span> DA</td>
                  </tr>
                  <tr>
                    <td style="padding-left: 20px;">Charge Supplémentaire</td>
                    <td><span id="summaryChargeSupp">0.00</span> DA</td>
                  </tr>
                  <tr>
                    <td style="padding-left: 20px;">Prix Visite des Lieux</td>
                    <td><span id="summaryPrixVisite">0.00</span> DA</td>
                  </tr>
                  <tr class="total-charge-row" style="background-color: #fff3cd;">
                    <td><strong>Total Charges</strong></td>
                    <td><strong><span id="summaryTotalCharge">0.00</span> DA</strong></td>
                  </tr>
                  <tr class="net-row" style="background-color: #d1ecf1;">
                    <td><strong>Net (Revenu - Charges)</strong></td>
                    <td><strong><span id="summaryNet">0.00</span> DA</strong></td>
                  </tr>
                  <tr class="margin-row" style="background-color: #d4edda;">
                    <td><strong>Marge (%)</strong></td>
                    <td><strong><span id="summaryMarge">0.00</span> %</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
              <span class="material-icons" style="vertical-align: middle; font-size: 1rem;">info</span>
              Ce tableau affiche le résumé financier basé sur les données calculées dans l'onglet R-H.
            </p>
          </div>
          
          <button class="btn-success" data-permission="ajouter" onclick="if(requirePermission('ajouter')) createOffre();"><span class="material-icons">save</span> Enregistrer Offre</button>
          <div id="offreError" class="error"></div>
        </div>
      </div>
      <!-- MED TAB -->
      <div id="medTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">local_hospital</span> Ajouter Médecin</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="newMedNom">Nom:</label>
              <div class="input-wrapper">
                <input id="newMedNom" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newMedPrenom">Prénom:</label>
              <div class="input-wrapper">
                <input id="newMedPrenom" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newMedTel">Numéro de téléphone:</label>
              <div class="input-wrapper">
                <input id="newMedTel" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newMedWilaya">Wilaya:</label>
              <div class="input-wrapper">
                <input id="newMedWilaya" type="text" list="wilayaList" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <button class="btn-success" onclick="addMedecin()"><span class="material-icons">add</span> Ajouter</button>
          <div id="medError" class="error"></div>
        </div>
        <div class="card">
          <h2>Liste des Médecins</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="filterMedNom">Filtre Nom:</label>
              <input id="filterMedNom" type="text" oninput="filterMedecins()">
            </div>
            <div class="form-group">
              <label for="filterMedPrenom">Filtre Prénom:</label>
              <input id="filterMedPrenom" type="text" oninput="filterMedecins()">
            </div>
            <div class="form-group">
              <label for="filterMedTel">Filtre Tel:</label>
              <input id="filterMedTel" type="text" oninput="filterMedecins()">
            </div>
            <div class="form-group">
              <label for="filterMedWilaya">Filtre Wilaya:</label>
              <input id="filterMedWilaya" type="text" oninput="filterMedecins()">
            </div>
          </div>
          <div class="table-wrapper">
            <table id="medTable">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Tel</th>
                  <th>Wilaya</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="medBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="medPagination"></div>
        </div>
      </div>
      <!-- INF TAB -->
      <div id="infTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">healing</span> Ajouter Infirmier</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="newInfNom">Nom:</label>
              <div class="input-wrapper">
                <input id="newInfNom" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newInfPrenom">Prénom:</label>
              <div class="input-wrapper">
                <input id="newInfPrenom" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newInfTel">Numéro de téléphone:</label>
              <div class="input-wrapper">
                <input id="newInfTel" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newInfWilaya">Wilaya:</label>
              <div class="input-wrapper">
                <input id="newInfWilaya" type="text" list="wilayaList" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <button class="btn-success" onclick="addInfirmier()"><span class="material-icons">add</span> Ajouter</button>
          <div id="infError" class="error"></div>
        </div>
        <div class="card">
          <h2>Liste des Infirmiers</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="filterInfNom">Filtre Nom:</label>
              <input id="filterInfNom" type="text" oninput="filterInfirmiers()">
            </div>
            <div class="form-group">
              <label for="filterInfPrenom">Filtre Prénom:</label>
              <input id="filterInfPrenom" type="text" oninput="filterInfirmiers()">
            </div>
            <div class="form-group">
              <label for="filterInfTel">Filtre Tel:</label>
              <input id="filterInfTel" type="text" oninput="filterInfirmiers()">
            </div>
            <div class="form-group">
              <label for="filterInfWilaya">Filtre Wilaya:</label>
              <input id="filterInfWilaya" type="text" oninput="filterInfirmiers()">
            </div>
          </div>
          <div class="table-wrapper">
            <table id="infTable">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Tel</th>
                  <th>Wilaya</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="infBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="infPagination"></div>
        </div>
      </div>
      <!-- TECH TAB -->
      <div id="techTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">biotech</span> Ajouter Tech Radio</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="newTechNom">Nom:</label>
              <div class="input-wrapper">
                <input id="newTechNom" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newTechPrenom">Prénom:</label>
              <div class="input-wrapper">
                <input id="newTechPrenom" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newTechTel">Numéro de téléphone:</label>
              <div class="input-wrapper">
                <input id="newTechTel" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newTechWilaya">Wilaya:</label>
              <div class="input-wrapper">
                <input id="newTechWilaya" type="text" list="wilayaList" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <button class="btn-success" onclick="addTechRadio()"><span class="material-icons">add</span> Ajouter</button>
          <div id="techError" class="error"></div>
        </div>
        <div class="card">
          <h2>Liste des Tech Radios</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="filterTechNom">Filtre Nom:</label>
              <input id="filterTechNom" type="text" oninput="filterTechRadios()">
            </div>
            <div class="form-group">
              <label for="filterTechPrenom">Filtre Prénom:</label>
              <input id="filterTechPrenom" type="text" oninput="filterTechRadios()">
            </div>
            <div class="form-group">
              <label for="filterTechTel">Filtre Tel:</label>
              <input id="filterTechTel" type="text" oninput="filterTechRadios()">
            </div>
            <div class="form-group">
              <label for="filterTechWilaya">Filtre Wilaya:</label>
              <input id="filterTechWilaya" type="text" oninput="filterTechRadios()">
            </div>
          </div>
          <div class="table-wrapper">
            <table id="techTable">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Tel</th>
                  <th>Wilaya</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="techBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="techPagination"></div>
        </div>
      </div>
      <!-- COORD TAB -->
      <div id="coordTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">supervisor_account</span> Ajouter Coordinateur</h2>
          <div class="form-group full">
            <label for="newCoordinateur">Nom du Coordinateur:</label>
            <div class="input-wrapper">
              <input id="newCoordinateur" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <button class="btn-success" onclick="addCoordinateur()"><span class="material-icons">add</span> Ajouter</button>
          <div id="coordError" class="error"></div>
        </div>
        <div class="card">
          <h2>Liste des Coordinateurs</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="filterCoordNom">Filtre Nom:</label>
              <input id="filterCoordNom" type="text" oninput="filterCoordinateurs()">
            </div>
          </div>
          <div class="table-wrapper">
            <table id="coordTable">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Nom</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="coordBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="coordPagination"></div>
        </div>
      </div>
      <!-- MAT TAB -->
      <div id="matTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">build</span> Ajouter Matériel</h2>
          <div class="form-group full">
            <label for="newMateriel">Nom du Matériel:</label>
            <div class="input-wrapper">
              <input id="newMateriel" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <button class="btn-success" onclick="addMateriel()"><span class="material-icons">add</span> Ajouter</button>
          <div id="matError" class="error"></div>
        </div>
        <div class="card">
          <h2>Liste des Matériels</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="filterMatNom">Filtre Nom:</label>
              <input id="filterMatNom" type="text" oninput="filterMateriels()">
            </div>
          </div>
          <div class="table-wrapper">
            <table id="matTable">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Nom</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="matBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="matPagination"></div>
        </div>
      </div>
      <!-- ENTREPRISE TAB -->
      <!-- COMMERCIAL TAB -->
      <div id="commercialTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">business_center</span> Gestion Commerciaux</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="newCommercialNom">Nom:</label>
              <div class="input-wrapper">
                <input id="newCommercialNom" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newCommercialPrenom">Prénom:</label>
              <div class="input-wrapper">
                <input id="newCommercialPrenom" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newCommercialEmail">Email:</label>
              <div class="input-wrapper">
                <input id="newCommercialEmail" type="email" onblur="validateInput(this, v => v.trim().length > 0 && v.includes('@'))">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <button class="btn-success" onclick="addCommercial()"><span class="material-icons">add</span> Ajouter Commercial</button>
          <div id="commercialError" class="error"></div>
        </div>
        <div class="card">
          <h2>Liste des Commerciaux</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="filterCommercialNom">Filtre Nom:</label>
              <input id="filterCommercialNom" type="text" oninput="filterCommerciaux()">
            </div>
          </div>
          <div class="table-wrapper">
            <table id="commercialTable">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Email</th>
                  <th>Entreprises Associées</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="commercialBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="commercialPagination"></div>
        </div>
      </div>
      <div id="entrepriseTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">apartment</span> Ajouter Entreprise</h2>
          <div class="form-group full">
            <label for="newEntreprise">Nom de l'Entreprise:</label>
            <div class="input-wrapper">
              <input id="newEntreprise" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <button class="btn-success" onclick="addEntreprise()"><span class="material-icons">add</span> Ajouter</button>
          <div id="entError" class="error"></div>
        </div>
        <div class="card">
          <h2>Liste des Entreprises</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="filterEntNom">Filtre Nom:</label>
              <input id="filterEntNom" type="text" oninput="filterEntreprises()">
            </div>
          </div>
          <div class="table-wrapper">
            <table id="entTable">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Nom</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="entBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="entPagination"></div>
        </div>
      </div>
      <!-- SUIVI TAB -->
      <div id="suiviTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">track_changes</span> Suivi des Missions</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="filterDateExact">Date Exacte Opération:</label>
              <input id="filterDateExact" type="date" oninput="applyFilters()">
            </div>
            <div class="form-group">
              <label for="filterDateStart">Date Début Plage:</label>
              <input id="filterDateStart" type="date" oninput="applyFilters()">
            </div>
            <div class="form-group">
              <label for="filterDateEnd">Date Fin Plage:</label>
              <input id="filterDateEnd" type="date" oninput="applyFilters()">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="filterEntreprise">Entreprise:</label>
              <input id="filterEntreprise" list="entrepriseList" oninput="applyFilters()">
            </div>
            <div class="form-group">
              <label for="filterMedecin">Médecin:</label>
              <input id="filterMedecin" list="medList" oninput="applyFilters()">
            </div>
            <div class="form-group">
              <label for="filterInfirmier">Infirmier:</label>
              <input id="filterInfirmier" list="infList" oninput="applyFilters()">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="filterMateriel">Matériel:</label>
              <input id="filterMateriel" list="matList" oninput="applyFilters()">
              <datalist id="matList"></datalist>
            </div>
            <div class="form-group">
              <label for="filterPack">Pack:</label>
              <input id="filterPack" list="packList" oninput="applyFilters()">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="filterCoordinateur">Coordinateur:</label>
              <input id="filterCoordinateur" list="coordList" oninput="applyFilters()">
            </div>
            <div class="form-group">
              <label for="filterStatut">Statut Mission:</label>
              <select id="filterStatut" onchange="applyFilters()">
                <option value="">Tous</option>
                <option value="programmer">Programmer</option>
                <option value="en cours">En cours</option>
                <option value="Réaliser">Réaliser</option>
              </select>
            </div>
          </div>
          <button class="btn-primary" onclick="clearFilters()"><span class="material-icons">clear</span> Réinitialiser Filtres</button>
          <div class="table-wrapper">
            <table id="missionsTable">
              <thead>
                <tr>
                  <th>Code Ope</th>
                  <th>Coordination</th>
                  <th>Date Operation</th>
                  <th>Date Enreg</th>
                  <th>Entreprise</th>
                  <th>Nbr Employés</th>
                  <th>Lieu</th>
                  <th>Déplacement</th>
                  <th>Médecins</th>
                  <th>Infirmiers</th>
                  <th>Tech Radio</th>
                  <th>Matériels</th>
                  <th>Total Charge</th>
                  <th>Total Net</th>
                  <th>Statut</th>
                  <th>Pack</th>
                  <th>Durée Mission</th>
                  <th>Statut Mission</th>
                  <th>Date Fin Operation</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="missionsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- EDIT TAB -->
      <div id="editTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">edit</span> Modification de Mission</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="editCodeOpe">Code Ope:</label>
              <div class="input-wrapper">
                <input id="editCodeOpe" type="number" oninput="loadMissionForEdit(this.value)" onblur="validateInput(this, v => parseInt(v) > 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div id="editForm" style="display:none;">
            <div class="form-row">
              <div class="form-group">
                <label for="editCoordination">Coordination:</label>
                <div class="input-wrapper">
                  <input id="editCoordination" list="coordList" onblur="validateInput(this, v => v.trim().length > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="editDateOperation">Date Operation:</label>
                <div class="input-wrapper">
                  <input id="editDateOperation" type="date" oninput="updateEditDateFin()" onblur="validateInput(this, v => !!v)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editEntreprise">Entreprise:</label>
                <input id="editEntreprise" readonly>
              </div>
              <div class="form-group">
                <label for="editPack">Pack:</label>
                <input id="editPack" readonly>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editDateEnreg">Date D'enregistrement:</label>
                <input id="editDateEnreg" type="date" readonly>
              </div>
              <div class="form-group">
                <label for="editLieuEntreprise">Lieu d'entreprise (Daira):</label>
                <div class="input-wrapper">
                  <input id="editLieuEntreprise" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editDeplacement">Déplacement:</label>
                <div class="input-wrapper">
                  <select id="editDeplacement" onblur="validateInput(this, v => !!v)">
                  </select>
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="editNbrJours">Nbr de Jour Ope:</label>
                <div class="input-wrapper">
                  <input id="editNbrJours" type="number" oninput="updateEditDateFin()" onblur="validateInput(this, v => v > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editDateFin">Date fin Ope:</label>
                <div class="input-wrapper">
                  <input id="editDateFin" type="date" oninput="updateEditNbrJours()" onblur="validateInput(this, v => !!v)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="editNbrEmploye">Nbr Employée:</label>
                <div class="input-wrapper">
                  <input id="editNbrEmploye" type="number" onblur="validateInput(this, v => parseInt(v) > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editWilayaDepartMedecin">Wilaya Départ Médecin:</label>
                <div class="input-wrapper">
                  <input id="editWilayaDepartMedecin" type="text" list="wilayaList" onblur="validateInput(this, v => v.trim().length > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="editNbrMedecin">Nombre Médecin:</label>
                <div class="input-wrapper">
                  <input id="editNbrMedecin" type="number" min="0" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseInt(v) >= 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <label>Ajouter/Modifier Médecin:</label>
            <div id="editMedecinsContainer"></div>
            <button class="btn-primary" onclick="addPersonnelRow('editMedecinsContainer', 'editMedecin', 'medList', 'Médecin', 'editNbrMedecin')"><span class="material-icons">add</span> Ajouter Médecin</button>
            <div class="form-row">
              <div class="form-group">
                <label for="editWilayaDepartInfirmier">Wilaya Départ Infirmier:</label>
                <div class="input-wrapper">
                  <input id="editWilayaDepartInfirmier" type="text" list="wilayaList" onblur="validateInput(this, v => v.trim().length > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="editNbrInfirmier">Nombre Infirmier:</label>
                <div class="input-wrapper">
                  <input id="editNbrInfirmier" type="number" min="0" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseInt(v) >= 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <label>Ajouter/Modifier Infirmier:</label>
            <div id="editInfirmiersContainer"></div>
            <button class="btn-primary" onclick="addPersonnelRow('editInfirmiersContainer', 'editInfirmier', 'infList', 'Infirmier', 'editNbrInfirmier')"><span class="material-icons">add</span> Ajouter Infirmier</button>
            <div class="form-row">
              <div class="form-group">
                <label for="editWilayaDepartTechRadio">Wilaya Départ Tech-Radio:</label>
                <div class="input-wrapper">
                  <input id="editWilayaDepartTechRadio" type="text" list="wilayaList" onblur="validateInput(this, v => v.trim().length > 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="editNbrTechRadio">Nombre Tech-Radio:</label>
                <div class="input-wrapper">
                  <input id="editNbrTechRadio" type="number" min="0" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseInt(v) >= 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <label>Ajouter/Modifier Tech-Radio:</label>
            <div id="editTechContainer"></div>
            <button class="btn-primary" onclick="addPersonnelRow('editTechContainer', 'editTechRadio', 'techList', 'Tech-Radio', 'editNbrTechRadio')"><span class="material-icons">add</span> Ajouter Tech-Radio</button>
            <div class="form-row">
              <div class="form-group">
                <label for="editDistanceMedecin">Distance Médecin (ex: 12,5):</label>
                <div class="input-wrapper">
                  <input id="editDistanceMedecin" type="text" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseFloat(v.replace(',', '.')) >= 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="editDistanceInfirmier">Distance Infirmier (ex: 12,5):</label>
                <div class="input-wrapper">
                  <input id="editDistanceInfirmier" type="text" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseFloat(v.replace(',', '.')) >= 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editDistanceTechRadio">Distance Tech-Radio (ex: 12,5):</label>
                <div class="input-wrapper">
                  <input id="editDistanceTechRadio" type="text" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseFloat(v.replace(',', '.')) >= 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="editDistanceMateriel">Distance Materiel (ex: 12,5):</label>
                <div class="input-wrapper">
                  <input id="editDistanceMateriel" type="text" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseFloat(v.replace(',', '.')) >= 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <label>Matériel:</label>
            <div id="editMaterielContainer"></div>
            <div class="form-row">
              <div class="form-group">
                <label for="editHebergement">Hébergement:</label>
                <div class="input-wrapper">
                  <select id="editHebergement" onchange="toggleDuree('Edit')" onblur="validateInput(this, v => !!v)">
                    <option value="non">Non</option>
                    <option value="oui">Oui</option>
                  </select>
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div id="editDureeContainer" style="display:none;">
                <div class="form-row">
                  <div class="form-group">
                    <label for="editDureeMed">Durée Médecins (nuits):</label>
                    <div class="input-wrapper">
                      <input id="editDureeMed" type="number" min="0" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseInt(v) >= 0)">
                      <span class="material-icons validation-icon"></span>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editDureeInf">Durée Infirmiers (nuits):</label>
                    <div class="input-wrapper">
                      <input id="editDureeInf" type="number" min="0" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseInt(v) >= 0)">
                      <span class="material-icons validation-icon"></span>
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="editDureeTech">Durée Tech-Radio (nuits):</label>
                    <div class="input-wrapper">
                      <input id="editDureeTech" type="number" min="0" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseInt(v) >= 0)">
                      <span class="material-icons validation-icon"></span>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="editDureeLog">Durée Logistique (nuits):</label>
                    <div class="input-wrapper">
                      <input id="editDureeLog" type="number" min="0" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseInt(v) >= 0)">
                      <span class="material-icons validation-icon"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="editFrais">Frais de Mission (par personne par nuit):</label>
                <div class="input-wrapper">
                  <input id="editFrais" type="number" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseFloat(v) >= 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="editChargeSupp">Charge supp:</label>
                <div class="input-wrapper">
                  <input id="editChargeSupp" type="number" oninput="updateEditCalcule()" onblur="validateInput(this, v => parseFloat(v) >= 0)">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            <div class="form-group full">
              <label for="editObservation">Observation:</label>
              <div class="input-wrapper">
                <input id="editObservation" type="text" onblur="validateInput(this, v => true)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="total-box">Total Charge: <span id="editTotalCharge">0.00</span></div>
            <div class="total-box" id="editTotalOperationBox">Total Net: <span id="editTotalOperation">0.00</span></div>
            <div class="total-box">Marge Net: <span id="margeNetEdit">0%</span></div>
            <button class="btn-success" data-permission="modifier" onclick="if(requirePermission('modifier')) saveEditedMission();"><span class="material-icons">save</span> Enregistrer Modifications</button>
            <div id="editError" class="error"></div>
          </div>
        </div>
      </div>
      <!-- ACTE TAB -->
      <div id="acteTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">list_alt</span> Gestion des Actes</h2>
          <div class="form-group full">
            <label for="newActeParametre">Paramètre:</label>
            <div class="input-wrapper">
              <input id="newActeParametre" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newActeCout">Cout Unitaire:</label>
              <div class="input-wrapper">
                <input id="newActeCout" type="number" step="0.01" onblur="validateInput(this, v => parseFloat(v) >= 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newActeMajoration">Majoration:</label>
              <div class="input-wrapper">
                <input id="newActeMajoration" type="number" step="0.01" onblur="validateInput(this, v => parseFloat(v) >= 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newActePrixPublic">Prix public:</label>
              <div class="input-wrapper">
                <input id="newActePrixPublic" type="number" step="0.01" onblur="validateInput(this, v => parseFloat(v) >= 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
            <div class="form-group">
              <label for="newActeSousTraitance">Sous traitance:</label>
              <div class="input-wrapper">
                <input id="newActeSousTraitance" type="number" step="0.01" onblur="validateInput(this, v => parseFloat(v) >= 0)">
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="newActeFamille">Famille:</label>
            <div class="input-wrapper">
              <input id="newActeFamille" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <button class="btn-success" onclick="addActe()"><span class="material-icons">add</span> Ajouter Acte</button>
          <div id="acteError" class="error"></div>
          <h3>Actes Existants</h3>
          <div class="table-wrapper">
            <table id="actesTable">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Paramètre</th>
                  <th>Cout Unitaire</th>
                  <th>Majoration</th>
                  <th>Prix public</th>
                  <th>Sous traitance</th>
                  <th>Famille</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="actesBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- RÉMUNÉRATION TAB -->
      <div id="remunTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">attach_money</span> Gestion des Rémunérations</h2>
          <div class="remun-filter form-row">
            <div class="form-group">
              <label for="remunMonth">Mois:</label>
              <select id="remunMonth" onchange="loadRemunerations()">
                <option value="1">Janvier</option>
                <option value="2">Février</option>
                <option value="3">Mars</option>
                <option value="4">Avril</option>
                <option value="5">Mai</option>
                <option value="6">Juin</option>
                <option value="7">Juillet</option>
                <option value="8">Août</option>
                <option value="9">Septembre</option>
                <option value="10">Octobre</option>
                <option value="11">Novembre</option>
                <option value="12">Décembre</option>
              </select>
            </div>
            <div class="form-group">
              <label for="remunYear">Année:</label>
              <input id="remunYear" type="number" value="${new Date().getFullYear()}" oninput="loadRemunerations()">
            </div>
            <div class="form-group">
              <label for="filterRemunNom">Filtre Nom:</label>
              <input id="filterRemunNom" type="text" oninput="applyRemunFilters()">
            </div>
            <div class="form-group">
              <label for="filterRemunPrenom">Filtre Prénom:</label>
              <input id="filterRemunPrenom" type="text" oninput="applyRemunFilters()">
            </div>
            <div class="form-group">
              <label for="filterRemunWilaya">Filtre Wilaya:</label>
              <input id="filterRemunWilaya" type="text" oninput="applyRemunFilters()">
            </div>
            <div class="form-group">
              <label for="filterRemunCodeOpe">Filtre Code Op:</label>
              <input id="filterRemunCodeOpe" type="text" oninput="applyRemunFilters()">
            </div>
            <div class="form-group">
              <label for="filterRemunDateStart">Date Début:</label>
              <input id="filterRemunDateStart" type="date" oninput="applyRemunFilters()">
            </div>
            <div class="form-group">
              <label for="filterRemunDateEnd">Date Fin:</label>
              <input id="filterRemunDateEnd" type="date" oninput="applyRemunFilters()">
            </div>
            <div class="form-group">
              <label for="filterRemunEntreprise">Filtre Entreprise:</label>
              <input id="filterRemunEntreprise" type="text" oninput="applyRemunFilters()">
            </div>
            <div class="form-group">
              <label for="filterRemunType">Filtre Fonction:</label>
              <select id="filterRemunType" onchange="applyRemunFilters()">
                <option value="">Tous</option>
                <option value="med">Médecin</option>
                <option value="inf">Infirmier</option>
                <option value="tech">Tech Radio</option>
              </select>
            </div>
          </div>
          <button class="btn-primary" onclick="clearRemunFilters()"><span class="material-icons">clear</span> Réinitialiser Filtres</button>
          <div class="table-wrapper">
            <table id="remunTable">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Full Name</th>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Tel</th>
                  <th>Wilaya</th>
                  <th>Total Mois</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="remunBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="remunPagination"></div>
          <div id="remunError" class="error"></div>
        </div>
      </div>
      <!-- PAIEMENTS TAB -->
      <div id="paiementsTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">payment</span> Data Rémunérations Payées</h2>
          <div class="remun-filter form-row">
            <div class="form-group">
              <label for="paiementsMonth">Mois:</label>
              <select id="paiementsMonth" onchange="loadPaidRemunerations()">
                <option value="1">Janvier</option>
                <option value="2">Février</option>
                <option value="3">Mars</option>
                <option value="4">Avril</option>
                <option value="5">Mai</option>
                <option value="6">Juin</option>
                <option value="7">Juillet</option>
                <option value="8">Août</option>
                <option value="9">Septembre</option>
                <option value="10">Octobre</option>
                <option value="11">Novembre</option>
                <option value="12">Décembre</option>
              </select>
            </div>
            <div class="form-group">
              <label for="paiementsYear">Année:</label>
              <input id="paiementsYear" type="number" value="${new Date().getFullYear()}" oninput="loadPaidRemunerations()">
            </div>
            <div class="form-group">
              <label for="filterPaiementsNom">Filtre Nom:</label>
              <input id="filterPaiementsNom" type="text" oninput="applyPaiementsFilters()">
            </div>
            <div class="form-group">
              <label for="filterPaiementsPrenom">Filtre Prénom:</label>
              <input id="filterPaiementsPrenom" type="text" oninput="applyPaiementsFilters()">
            </div>
            <div class="form-group">
              <label for="filterPaiementsWilaya">Filtre Wilaya:</label>
              <input id="filterPaiementsWilaya" type="text" oninput="applyPaiementsFilters()">
            </div>
            <div class="form-group">
              <label for="filterPaiementsCodeOpe">Filtre Code Op:</label>
              <input id="filterPaiementsCodeOpe" type="text" oninput="applyPaiementsFilters()">
            </div>
            <div class="form-group">
              <label for="filterPaiementsDateStart">Date Début:</label>
              <input id="filterPaiementsDateStart" type="date" oninput="applyPaiementsFilters()">
            </div>
            <div class="form-group">
              <label for="filterPaiementsDateEnd">Date Fin:</label>
              <input id="filterPaiementsDateEnd" type="date" oninput="applyPaiementsFilters()">
            </div>
            <div class="form-group">
              <label for="filterPaiementsEntreprise">Filtre Entreprise:</label>
              <input id="filterPaiementsEntreprise" type="text" oninput="applyPaiementsFilters()">
            </div>
            <div class="form-group">
              <label for="filterPaiementsType">Filtre Fonction:</label>
              <select id="filterPaiementsType" onchange="applyPaiementsFilters()">
                <option value="">Tous</option>
                <option value="med">Médecin</option>
                <option value="inf">Infirmier</option>
                <option value="tech">Tech Radio</option>
              </select>
            </div>
          </div>
          <button class="btn-primary" onclick="clearPaiementsFilters()"><span class="material-icons">clear</span> Réinitialiser Filtres</button>
          <div class="table-wrapper">
            <table id="paiementsTable">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Full Name</th>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Tel</th>
                  <th>Wilaya</th>
                  <th>Total Mois</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="paiementsBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="paiementsPagination"></div>
          <div id="paiementsError" class="error"></div>
        </div>
      </div>
      <!-- DATA PACK TAB -->
      <div id="dataPackTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">data_usage</span> Data Pack</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="filterPackCode">Filtre Code Pack:</label>
              <input id="filterPackCode" type="text" oninput="applyPackFilters()">
            </div>
            <div class="form-group">
              <label for="filterPackName">Filtre Pack:</label>
              <input id="filterPackName" type="text" oninput="applyPackFilters()">
            </div>
            <div class="form-group">
              <label for="filterPackEntreprise">Filtre Entreprise:</label>
              <input id="filterPackEntreprise" type="text" oninput="applyPackFilters()">
            </div>
            <div class="form-group">
              <label for="filterPackStatus">Filtre Statut:</label>
              <select id="filterPackStatus" onchange="applyPackFilters()">
                <option value="">Tous</option>
                <option value="à calculer">à calculer</option>
                <option value="calculer">calculer</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterPackLieu">Filtre Site:</label>
              <input id="filterPackLieu" type="text" oninput="applyPackFilters()">
            </div>
            <div class="form-group">
              <label for="filterPackDateStart">Date Début:</label>
              <input id="filterPackDateStart" type="date" oninput="applyPackFilters()">
            </div>
            <div class="form-group">
              <label for="filterPackDateEnd">Date Fin:</label>
              <input id="filterPackDateEnd" type="date" oninput="applyPackFilters()">
            </div>
            <div class="form-group">
              <label for="filterPackMonth">Mois:</label>
              <select id="filterPackMonth" onchange="applyPackFilters()">
                <option value="">Tous</option>
                <option value="1">Janvier</option>
                <option value="2">Février</option>
                <option value="3">Mars</option>
                <option value="4">Avril</option>
                <option value="5">Mai</option>
                <option value="6">Juin</option>
                <option value="7">Juillet</option>
                <option value="8">Août</option>
                <option value="9">Septembre</option>
                <option value="10">Octobre</option>
                <option value="11">Novembre</option>
                <option value="12">Décembre</option>
              </select>
            </div>
          </div>
          <button class="btn-primary" onclick="clearPackFilters()"><span class="material-icons">clear</span> Réinitialiser Filtres</button>
          <div id="dataPackTotals" class="totals-summary"></div>
          <div class="table-wrapper">
            <table id="dataPackTable">
              <thead>
                <tr>
                  <th>Code Pack</th>
                  <th>Pack Name</th>
                  <th>Entreprise</th>
                  <th>Statut</th>
                  <th>Nbr Employés</th>
                  <th>Lieu</th>
                  <th>Total Revenue</th>
                  <th>Total Charge (estimée)</th>
                  <th>Total Net</th>
                  <th>Date Enreg</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="dataPackBody"></tbody>
            </table>
          </div>
          <div class="pagination" id="dataPackPagination"></div>
        </div>
      </div>
      <!-- DATA CALCULE TAB -->
      <div id="dataCalculeTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">calculate</span> Données Offre</h2>
          <div class="form-row" style="align-items:flex-end;">
            <div class="form-group">
              <label for="filterOffreEntreprise">Filtre Entreprise:</label>
              <input id="filterOffreEntreprise" type="text" oninput="renderDataOffreTable()">
            </div>
            <div class="form-group">
              <label for="filterOffrePack">Filtre Pack:</label>
              <input id="filterOffrePack" type="text" oninput="renderDataOffreTable()">
            </div>
            <div class="form-group">
              <label for="filterOffreDate">Filtre Date Enreg:</label>
              <input id="filterOffreDate" type="date" oninput="renderDataOffreTable()">
            </div>
            <div class="form-group">
              <button class="btn-primary" onclick="exportDataOffreCsv()"><span class="material-icons">download</span> Exporter Excel</button>
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Sel</th>
                  <th>Code Pack</th>
                  <th>Entreprise</th>
                  <th>Date Création</th>
                  <th>Date Enregistrement</th>
                  <th>Écart</th>
                  <th>Total Revenue</th>
                  <th>Coût</th>
                  <th>Total Net</th>
                  <th>Marge %</th>
                  <th>Médecins</th>
                  <th>Infirmiers</th>
                  <th>Tech Radio</th>
                  <th>Détail</th>
                </tr>
              </thead>
              <tbody id="dataOffreBody"></tbody>
            </table>
          </div>
          <div id="dataOffrePagination" class="pagination" style="margin-top:8px;"></div>
        </div>
      </div>
      <!-- DASHBOARD TAB -->
      <!-- FINANCE TAB -->
      <div id="financeTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">account_balance</span> Finance - Gestion Financière</h2>
          
          <!-- Statistics Cards -->
          <div class="dashboard-grid">
            <div class="dashboard-card success">
              <h3>Offres Validées</h3>
              <div class="dashboard-value" id="finance-validated">0</div>
              <div class="dashboard-label">Marge conforme</div>
            </div>
            
            <div class="dashboard-card warning">
              <h3>En Attente Validation</h3>
              <div class="dashboard-value" id="finance-pending">0</div>
              <div class="dashboard-label">Marge < seuil</div>
            </div>
            
            <div class="dashboard-card danger">
              <h3>Non Validées</h3>
              <div class="dashboard-value" id="finance-rejected">0</div>
              <div class="dashboard-label">Nécessite révision</div>
            </div>
            
            <div class="dashboard-card info">
              <h3>Renouvellements</h3>
              <div class="dashboard-value" id="finance-renewals">0</div>
              <div class="dashboard-label">En cours</div>
            </div>
          </div>
          
          <!-- Filters -->
          <div class="card" style="margin-top: 20px;">
            <h3>Filtres</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="filterFinanceEntreprise">Entreprise:</label>
                <input id="filterFinanceEntreprise" type="text" placeholder="Filtrer par entreprise">
              </div>
              <div class="form-group">
                <label for="filterFinanceCommercial">Commercial:</label>
                <input id="filterFinanceCommercial" type="text" placeholder="Filtrer par commercial">
              </div>
              <div class="form-group">
                <label for="filterFinanceCoordination">Coordination:</label>
                <input id="filterFinanceCoordination" type="text" placeholder="Filtrer par coordination">
              </div>
              <div class="form-group">
                <label for="filterFinanceStatus">Statut:</label>
                <select id="filterFinanceStatus">
                  <option value="">Tous</option>
                  <option value="validé">Validé</option>
                  <option value="attente validation">En Attente</option>
                  <option value="non validé">Non Validé</option>
                </select>
              </div>
              <div class="form-group">
                <button class="btn-primary" onclick="applyFinanceFilters()"><span class="material-icons">filter_list</span> Filtrer</button>
                <button class="btn-primary" onclick="clearFinanceFilters()"><span class="material-icons">clear</span> Réinitialiser</button>
              </div>
            </div>
          </div>
          
          <!-- Offers Table -->
          <div class="card" style="margin-top: 20px;">
            <h3>Détails des Offres</h3>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Entreprise</th>
                    <th>Commercial</th>
                    <th>Coordination</th>
                    <th>Date</th>
                    <th>Revenu</th>
                    <th>Charges</th>
                    <th>Net</th>
                    <th>Marge %</th>
                    <th>Statut Finance</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="financeTableBody"></tbody>
              </table>
            </div>
            <div id="financePagination" class="pagination"></div>
          </div>
          
          <!-- Validation Panel -->
          <div id="financeValidationPanel" class="card" style="margin-top: 20px; display: none;">
            <h3>Validation de l'Offre</h3>
            <div id="financeOffreDetails"></div>
            <div class="form-row" style="margin-top: 15px;">
              <div class="form-group">
                <label>Décision:</label>
                <button class="btn-success" onclick="validateOffer()"><span class="material-icons">check_circle</span> Valider</button>
                <button class="btn-danger" onclick="rejectOffer()"><span class="material-icons">cancel</span> Rejeter</button>
                <button class="btn-primary" onclick="reviewOffer()"><span class="material-icons">rate_review</span> Réviser</button>
              </div>
              <div class="form-group full">
                <label for="financeComment">Commentaire:</label>
                <textarea id="financeComment" rows="3" placeholder="Ajouter un commentaire..."></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="dashboardTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">dashboard</span> Tableau de Bord</h2>
          
          <div class="dashboard-grid">
            <div class="dashboard-card success">
              <h3>Offres du Mois</h3>
              <div class="dashboard-value" id="dash-offres-mois">0</div>
              <div class="dashboard-label">Nouvelles offres créées</div>
            </div>
            
            <div class="dashboard-card info">
              <h3>Offres de l'Année</h3>
              <div class="dashboard-value" id="dash-offres-annee">0</div>
              <div class="dashboard-label">Total annuel</div>
            </div>
            
            <div class="dashboard-card success">
              <h3>Marge Moyenne</h3>
              <div class="dashboard-value" id="dash-marge-moyenne">0%</div>
              <div class="dashboard-label">Sur offres calculées</div>
            </div>
            
            <div class="dashboard-card warning">
              <h3>En Attente <24h</h3>
              <div class="dashboard-value" id="dash-alerte-24h">0</div>
              <div class="dashboard-label">Offres non calculées</div>
            </div>
            
            <div class="dashboard-card danger">
              <h3>Alertes >24h</h3>
              <div class="dashboard-value" id="dash-alerte-plus24h">0</div>
              <div class="dashboard-label">Action requise</div>
            </div>
            
            <div class="dashboard-card info">
              <h3>Renouvellements</h3>
              <div class="dashboard-value" id="dash-renouvellements">0</div>
              <div class="dashboard-label">Ce mois</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="card">
              <h3>Top 10 Entreprises (Marge la plus élevée)</h3>
              <ul class="top-list" id="top-entreprises-high"></ul>
            </div>
            
            <div class="card">
              <h3>5 Entreprises (Marge la plus basse)</h3>
              <ul class="top-list" id="top-entreprises-low"></ul>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="card">
              <h3>Top 5 Commerciaux</h3>
              <ul class="top-list" id="top-commerciaux"></ul>
            </div>
            
            <div class="card">
              <h3>Top 5 Coordinateurs</h3>
              <ul class="top-list" id="top-coordinateurs"></ul>
            </div>
          </div>
          
          <div class="card" style="margin-top: 20px;">
            <h3>Évolution Mensuelle</h3>
            <canvas id="monthlyChart" width="400" height="100"></canvas>
          </div>
        </div>
      </div>
      
      <!-- PROGRAMMATION PERSONNEL TAB -->
      <div id="progPersonnelTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">people</span> Programmation Personnel</h2>
          <p>Vue d'ensemble de la disponibilité du personnel médical</p>
          
          <div class="form-row">
            <div class="form-group">
              <label for="filterProgPersonnelDate">Date:</label>
              <input id="filterProgPersonnelDate" type="date">
            </div>
            <div class="form-group">
              <label for="filterProgPersonnelType">Type:</label>
              <select id="filterProgPersonnelType">
                <option value="">Tous</option>
                <option value="med">Médecin</option>
                <option value="inf">Infirmier</option>
                <option value="tech">Tech Radio</option>
              </select>
            </div>
            <div class="form-group">
              <button class="btn-primary" onclick="loadProgPersonnel()"><span class="material-icons">search</span> Rechercher</button>
            </div>
          </div>
          
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Personnel</th>
                  <th>Type</th>
                  <th>Opération</th>
                  <th>Entreprise</th>
                  <th>Site</th>
                  <th>Date Début</th>
                  <th>Date Fin</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody id="progPersonnelBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- PROGRAMMATION MATERIEL TAB -->
      <div id="progMaterielTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">build_circle</span> Programmation Matériel</h2>
          <p>Vue d'ensemble de la disponibilité du matériel</p>
          
          <div class="form-row">
            <div class="form-group">
              <label for="filterProgMaterielDate">Date:</label>
              <input id="filterProgMaterielDate" type="date">
            </div>
            <div class="form-group">
              <label for="filterProgMaterielNom">Matériel:</label>
              <input id="filterProgMaterielNom" type="text" list="materielListProg">
              <datalist id="materielListProg"></datalist>
            </div>
            <div class="form-group">
              <button class="btn-primary" onclick="loadProgMateriel()"><span class="material-icons">search</span> Rechercher</button>
            </div>
          </div>
          
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Matériel</th>
                  <th>Opération</th>
                  <th>Entreprise</th>
                  <th>Site</th>
                  <th>Date Début</th>
                  <th>Date Fin</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody id="progMaterielBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- RENOUVELLEMENT TAB -->
      <div id="renouvellementTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">autorenew</span> Renouvellement d'Offres</h2>
          <p>Sélectionnez une entreprise et une offre existante pour renouveler</p>
          
          <div class="form-row">
            <div class="form-group">
              <label for="renouvelEntreprise">Entreprise:</label>
              <div class="input-wrapper">
                <input id="renouvelEntreprise" list="entrepriseListRenouvellement" oninput="loadOffresForRenewal()">
                <span class="material-icons validation-icon"></span>
              </div>
              <datalist id="entrepriseListRenouvellement"></datalist>
            </div>
            
            <div class="form-group">
              <label for="renouvelOffre">Offre à renouveler:</label>
              <div class="input-wrapper">
                <select id="renouvelOffre" onchange="loadOffreDetailsForRenewal()">
                  <option value="">-- Sélectionner une offre --</option>
                </select>
                <span class="material-icons validation-icon"></span>
              </div>
            </div>
          </div>
          
          <div id="renouvelOffreDetails" style="display: none;">
            <div class="card" style="background: #f8f9fa; margin-top: 20px;">
              <h3>Détails de l'offre sélectionnée</h3>
              <div id="renouvelOffreInfo"></div>
              
              <div class="form-row" style="margin-top: 20px;">
                <div class="form-group">
                  <label for="renouvelNewDateDebut">Nouvelle Date Début:</label>
                  <input id="renouvelNewDateDebut" type="date" required>
                </div>
                <div class="form-group">
                  <label for="renouvelNewDateFin">Nouvelle Date Fin:</label>
                  <input id="renouvelNewDateFin" type="date" required>
                </div>
              </div>
              
              <div class="form-row">
                <button class="btn-success" onclick="processRenewal(false)"><span class="material-icons">autorenew</span> Renouveler Sans Modification</button>
                <button class="btn-primary" onclick="processRenewal(true)"><span class="material-icons">edit</span> Modifier et Renouveler</button>
              </div>
            </div>
          </div>
          
          <div id="renouvelError" class="error"></div>
        </div>
      </div>
      
      <!-- ADMIN TAB -->
      <div id="adminTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">admin_panel_settings</span> Administration des Utilisateurs</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="adminUsername">Nom d'utilisateur</label>
              <input id="adminUsername" type="text">
            </div>
            <div class="form-group">
              <label for="adminPassword">Mot de passe</label>
              <input id="adminPassword" type="password">
            </div>
            <div class="form-group">
              <label for="adminRole">Rôle</label>
              <select id="adminRole">
                <option value="admin">Admin</option>
                <option value="rh">R-H</option>
                <option value="commerciale">Commerciale</option>
                <option value="coordination">Coordination</option>
                <option value="tresorier">Trésorier</option>
                <option value="financier">Financier</option>
              </select>
            </div>
          </div>
          <div class="form-group full">
            <label>Onglets accessibles</label>
            <div class="permissions-grid" id="adminTabsList">
              <label><input type="checkbox" id="tabsSelectAll"> Tous</label>
              <label><input type="checkbox" value="homeTab"> Accueil</label>
              <label><input type="checkbox" value="packTab"> Offre</label>
              <label><input type="checkbox" value="calculeTab"> R-H</label>
              <label><input type="checkbox" value="offreTab"> Programmation</label>
              <label><input type="checkbox" value="medTab"> Médecin</label>
              <label><input type="checkbox" value="infTab"> Infirmier</label>
              <label><input type="checkbox" value="techTab"> Tech Radio</label>
              <label><input type="checkbox" value="coordTab"> Coordinateur</label>
              <label><input type="checkbox" value="matTab"> Matériel</label>
              <label><input type="checkbox" value="commercialTab"> Commercial</label>
              <label><input type="checkbox" value="entrepriseTab"> Entreprise</label>
              <label><input type="checkbox" value="suiviTab"> Suivi Missions</label>
              <label><input type="checkbox" value="editTab"> Modifier Mission</label>
              <label><input type="checkbox" value="acteTab"> Actes</label>
              <label><input type="checkbox" value="remunTab"> Rémunération</label>
              <label><input type="checkbox" value="paiementsTab"> Paiements</label>
              <label><input type="checkbox" value="dataPackTab"> Data Offre</label>
              <label><input type="checkbox" value="dataCalculeTab"> Data R-H</label>
              <label><input type="checkbox" value="financeTab"> Finance</label>
              <label><input type="checkbox" value="dashboardTab"> Tableau de Bord</label>
              <label><input type="checkbox" value="progPersonnelTab"> Prog. Personnel</label>
              <label><input type="checkbox" value="progMaterielTab"> Prog. Matériel</label>
              <label><input type="checkbox" value="renouvellementTab"> Renouvellement</label>
              <label><input type="checkbox" value="adminTab"> Administration</label>
              <label><input type="checkbox" value="settingsTab"> Paramètres</label>
              <label><input type="checkbox" value="auditTab"> Audit</label>
            </div>
          </div>
          <div class="form-group full">
            <label>Permissions</label>
            <div class="permissions-grid" id="adminPermissionsList">
              <label><input type="checkbox" id="permsSelectAll"> Tous</label>
              <label><input type="checkbox" value="consulter"> Consulter</label>
              <label><input type="checkbox" value="ajouter"> Ajouter</label>
              <label><input type="checkbox" value="modifier"> Modifier</label>
              <label><input type="checkbox" value="supprimer"> Supprimer</label>
            </div>
          </div>
          <button class="btn-success" onclick="saveAdminUser()"><span class="material-icons">save</span> Enregistrer l'utilisateur</button>
          <div id="adminUserMessage" class="alert" style="display:none; margin-top:10px;"></div>
        </div>
        <div class="card">
          <h3><span class="material-icons">people</span> Utilisateurs enregistrés</h3>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Rôle</th>
                  <th>Onglets</th>
                  <th>Permissions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr><td colspan="4" style="text-align:center;">Chargement...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- SETTINGS TAB -->
      <div id="settingsTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">settings</span> Paramètres Système</h2>
          
          <div class="card" style="margin-top: 20px;">
            <h3>Validation Automatique</h3>
            <p>Configurer le seuil de marge pour la validation automatique des offres</p>
            <div class="form-row">
              <div class="form-group">
                <label for="marginThreshold">Seuil de Marge (%) :</label>
                <div class="input-wrapper">
                  <input id="marginThreshold" type="number" min="0" max="100" step="1" value="70">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Les offres avec une marge ≥ ce seuil seront validées automatiquement</small>
              </div>
            </div>
            <button class="btn-success" onclick="saveMarginThreshold()"><span class="material-icons">save</span> Sauvegarder Seuil</button>
            <div id="settingsSuccess" class="alert alert-success" style="display:none; margin-top:10px;"></div>
          </div>
          
          <div class="card" style="margin-top: 20px;">
            <h3>Paramètres de Calcul</h3>
            <p>Configurer les valeurs par défaut utilisées dans les calculs</p>
            
            <h4 style="margin-top: 20px; color: #2196F3;">Calculs Globaux</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="paramCalculeJourMedecin">Calcul Jour Médecin:</label>
                <div class="input-wrapper">
                  <input id="paramCalculeJourMedecin" type="number" min="1" value="20">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Nombre d'employés par médecin par jour</small>
              </div>
              <div class="form-group">
                <label for="paramCalculeJourInfirmier">Calcul Jour Infirmier:</label>
                <div class="input-wrapper">
                  <input id="paramCalculeJourInfirmier" type="number" min="1" value="30">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Nombre d'employés par infirmier par jour</small>
              </div>
              <div class="form-group">
                <label for="paramCalculeJourTechRadio">Calcul Jour Tech-Radio:</label>
                <div class="input-wrapper">
                  <input id="paramCalculeJourTechRadio" type="number" min="1" value="30">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Nombre d'employés par tech-radio par jour</small>
              </div>
            </div>
            
            <h4 style="margin-top: 20px; color: #2196F3;">Tarifs Personnel (DA)</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="paramTauxJourMedecin">Taux/Jour Médecin (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTauxJourMedecin" type="number" min="0" value="5000">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="paramTauxJourInfirmier">Taux/Jour Infirmier (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTauxJourInfirmier" type="number" min="0" value="4000">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="paramTauxJourTechRadio">Taux/Jour Tech-Radio (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTauxJourTechRadio" type="number" min="0" value="4000">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            
            <h4 style="margin-top: 20px; color: #2196F3;">Tarifs Transport & Logistique</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="paramTarifKm">Tarif/km Personnel (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTarifKm" type="number" min="0" value="15">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Coût par kilomètre pour déplacement personnel</small>
              </div>
              <div class="form-group">
                <label for="paramTarifKmMateriel">Tarif/km Matériel (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTarifKmMateriel" type="number" min="0" value="25">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Coût par kilomètre pour transport matériel</small>
              </div>
              <div class="form-group">
                <label for="paramTarifAvion">Tarif Avion (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTarifAvion" type="number" min="0" value="13500">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Coût par personne en avion</small>
              </div>
            </div>
            
            <h4 style="margin-top: 20px; color: #2196F3;">Tarifs Hébergement (DA)</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="paramTarifNuitMedecin">Tarif/Nuit Médecin (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTarifNuitMedecin" type="number" min="0" value="5000">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="paramTarifNuitInfirmier">Tarif/Nuit Infirmier (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTarifNuitInfirmier" type="number" min="0" value="4000">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="paramTarifNuitTechRadio">Tarif/Nuit Tech-Radio (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTarifNuitTechRadio" type="number" min="0" value="4000">
                  <span class="material-icons validation-icon"></span>
                </div>
              </div>
            </div>
            
            <h4 style="margin-top: 20px; color: #2196F3;">Autres Paramètres</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="paramTarifYalidine">Tarif Yalidine (DA):</label>
                <div class="input-wrapper">
                  <input id="paramTarifYalidine" type="number" min="0" value="950">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Tarif journalier Yalidine</small>
              </div>
              <div class="form-group">
                <label for="paramPrixVisiteLieux">Prix Visite Lieux (DA):</label>
                <div class="input-wrapper">
                  <input id="paramPrixVisiteLieux" type="number" min="0" value="30000">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Prix fixe pour visite des lieux</small>
              </div>
              <div class="form-group">
                <label for="paramDeplacementLogistique">Déplacement Logistique (DA):</label>
                <div class="input-wrapper">
                  <input id="paramDeplacementLogistique" type="number" min="0" value="1500">
                  <span class="material-icons validation-icon"></span>
                </div>
                <small>Coût transport + panier par personne</small>
              </div>
            </div>
            
            <button class="btn-success" onclick="saveCalculationParameters()"><span class="material-icons">save</span> Sauvegarder Paramètres</button>
            <div id="calcParamSuccess" class="alert alert-success" style="display:none; margin-top:10px;"></div>
          </div>
          
          <div class="card" style="margin-top: 20px;">
            <h3>Notifications</h3>
            <p>Configuration des notifications (à venir)</p>
            <div class="form-row">
              <div class="form-group">
                <label>
                  <input type="checkbox" id="emailNotifications" checked>
                  Activer les notifications par email
                </label>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="notificationDelay">Délai d'alerte (heures) :</label>
                <input id="notificationDelay" type="number" min="1" max="72" value="24">
                <small>Alerte si offre non calculée après ce délai</small>
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 20px;">
            <h3>Informations Système</h3>
            <p><strong>Version:</strong> MDT v5.0</p>
            <p><strong>Date de dernière mise à jour:</strong> 2025</p>
            <p><strong>Utilisateurs actifs:</strong> <span id="activeUsers">-</span></p>
          </div>
        </div>
      </div>
      
      <!-- AUDIT TAB -->
      <div id="auditTab" class="tab">
        <div class="card">
          <h2><span class="material-icons">history</span> Journal d'Audit (Traçabilité Simplifiée)</h2>
          <p style="color: #dc3545; font-weight: 500;">
            <span class="material-icons" style="vertical-align: middle;">warning</span>
            AVERTISSEMENT: Ce journal peut être modifié ou supprimé directement dans Google Sheets. Il ne garantit pas l'intégrité des données.
          </p>
          
          <div style="margin: 20px 0;">
            <button class="btn-primary" onclick="loadAuditLogs()">
              <span class="material-icons">refresh</span> Actualiser
            </button>
            <label style="margin-left: 20px;">
              Afficher les 
              <select id="auditLimit" onchange="loadAuditLogs()" style="padding: 5px; border-radius: 4px;">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
                <option value="500">500</option>
              </select>
              dernières entrées
            </label>
          </div>
          
          <div style="overflow-x: auto;">
            <table class="data-table" style="width: 100%;">
              <thead>
                <tr>
                  <th>Horodatage</th>
                  <th>Utilisateur</th>
                  <th>Rôle</th>
                  <th>Action</th>
                  <th>Détails</th>
                </tr>
              </thead>
              <tbody id="auditTableBody">
                <tr>
                  <td colspan="5" style="text-align: center; padding: 20px;">
                    Cliquez sur "Actualiser" pour charger les logs d'audit
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    // === SYSTÈME DE RÔLES SIMULÉ ===
    // AVERTISSEMENT: Ce système utilise localStorage et peut être facilement contourné
    // Il offre uniquement une simulation d'interface utilisateur, pas de vraie sécurité
    
    let currentUser = {
      name: '',
      role: '',
      tabs: [],
      permissions: []
    };
    let usersCache = [];
    
    function initUserSession() {
      const saved = localStorage.getItem('currentUserData');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          currentUser = Object.assign({}, currentUser, parsed);
          updateUIForRole();
          applyAccessControl();
          return true;
        } catch (e) {
          localStorage.removeItem('currentUserData');
        }
      }
      return false;
    }
    
    function openLoginModal() {
      const modal = document.getElementById('loginModal');
      if (modal) modal.style.display = 'flex';
    }
    
    function closeLoginModal() {
      const modal = document.getElementById('loginModal');
      if (modal) modal.style.display = 'none';
    }
    
    function showLoginDialog() {
      const modal = document.getElementById('loginModal');
      if (modal) {
        const lastUser = localStorage.getItem('lastLoginUsername') || '';
        const lastPass = localStorage.getItem('lastLoginPassword') || '';
        const userInput = document.getElementById('loginUsername');
        const passInput = document.getElementById('loginPassword');
        if (userInput) userInput.value = lastUser;
        if (passInput) passInput.value = lastPass;
        modal.style.display = 'flex';
      }
    }
    
    function attemptLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!username || !password) {
        showAlert('Utilisateur et mot de passe requis', 'error');
        return;
      }
      google.script.run
        .withSuccessHandler(user => {
          if (user) {
            setCurrentUser(user);
            closeLoginModal();
            logAudit('Connexion', `${user.username || user.name} connecté avec rôle ${user.role}`);
            loadAllPacksData();
            loadUsersAdmin();
            showTab('homeTab');
          } else {
            showAlert('Identifiants invalides', 'error');
          }
        })
        .withFailureHandler(onFailure)
        .authenticateUser(username, password);
    }
    
    function setCurrentUser(user) {
      currentUser = {
        name: user.username || user.name || '',
        role: user.role || '',
        tabs: user.tabs || [],
        permissions: user.permissions || []
      };
      localStorage.setItem('lastLoginUsername', user.username || user.name || '');
      if (user.password) {
        localStorage.setItem('lastLoginPassword', user.password);
      }
      localStorage.setItem('currentUserData', JSON.stringify(currentUser));
      updateUIForRole();
      applyAccessControl();
    }
    
    function logout() {
      if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
        logAudit('Déconnexion', `${currentUser.name} déconnecté`);
        localStorage.removeItem('currentUserData');
        // Préremplir avec dernier login
        const userInput = document.getElementById('loginUsername');
        const passInput = document.getElementById('loginPassword');
        if (userInput) userInput.value = localStorage.getItem('lastLoginUsername') || '';
        if (passInput) passInput.value = localStorage.getItem('lastLoginPassword') || '';
        currentUser = {name: '', role: '', tabs: [], permissions: []};
        showLoginDialog();
      }
    }
    
    function updateUIForRole() {
      const userInfo = document.getElementById('user-info');
      if (userInfo && currentUser.name) {
        userInfo.innerHTML = `
          <span style="margin-right: 15px;">
            <span class="material-icons" style="vertical-align: middle; font-size: 20px;">person</span>
            ${currentUser.name} (${(currentUser.role || '').toUpperCase()})
          </span>
          <button onclick="logout()" style="padding: 5px 15px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; cursor: pointer;">
            Déconnexion
          </button>
        `;
      }
    }
    
    function applyAccessControl() {
      const allowedTabs = (currentUser.tabs && currentUser.tabs.length) ? currentUser.tabs : null;
      document.querySelectorAll('.menu-btn').forEach(btn => {
        const tab = btn.dataset.tab;
        if (!allowedTabs || currentUser.role === 'admin') {
          btn.style.display = '';
          return;
        }
        btn.style.display = allowedTabs.includes(tab) ? '' : 'none';
      });
      if (allowedTabs && !allowedTabs.includes(getActiveTabId()) && allowedTabs.length) {
        showTab(allowedTabs[0]);
      }
    }
    
    function hasRole(...roles) {
      if (currentUser.role === 'admin') return true;
      return roles.includes(currentUser.role);
    }
    
    function hasPermission(action) {
      if (currentUser.role === 'admin') return true;
      if (!currentUser.permissions || currentUser.permissions.length === 0) return true;
      return currentUser.permissions.includes(action);
    }
    
    function requirePermission(action) {
      if (!hasPermission(action)) {
        showAlert(`Action "${action}" non autorisée pour cet utilisateur`, 'error');
        return false;
      }
      return true;
    }
    
    let availableEntreprises = [];
    let allMissions = []; // Stocke toutes les données des missions pour filtrage
    let allActes = [];
    let siteCount = 0;
    let medecinsData = [];
    let infirmiersData = [];
    let techRadiosData = [];
    let coordinateursData = [];
    let materielsData = [];
    let entreprisesData = [];
    let allRemunData = []; // Pour stocker les données de rémunération pour filtrage
    let allPaidRemunData = []; // Pour paiements
    let allPackData = [];
    let allCalculeData = [];
    let allOffreData = [];
    let reconciliationPackTotals = null;
    let selectedRecRowIds = new Set();
    let recTablePage = 1;
    let selectedOffreRowId = null;
    let currentOffreRows = [];
    // === FONCTIONS DE VALIDATION VISUELLE ===
    function validateInput(input, validator) {
      const icon = input.parentElement.querySelector('.validation-icon');
      const value = input.value;
      if (validator(value)) {
        input.classList.add('valid');
        input.classList.remove('invalid');
        icon.textContent = 'check_circle';
        icon.style.color = '#28a745';
      } else if (value) {
        input.classList.add('invalid');
        input.classList.remove('valid');
        icon.textContent = 'error';
        icon.style.color = '#dc3545';
      } else {
        input.classList.remove('valid', 'invalid');
        icon.textContent = '';
      }
    }
    // === SHOW TAB & MENU ACTIVE ===
    function getActiveTabId() {
      const active = document.querySelector('.tab.active');
      return active ? active.id : null;
    }
    
    function showTab(tabId) {
      if (!currentUser.name) {
        showLoginDialog();
        return;
      }
      if (currentUser.role !== 'admin' && currentUser.tabs && currentUser.tabs.length && !currentUser.tabs.includes(tabId)) {
        showAlert('Onglet non autorisé pour cet utilisateur.', 'error');
        return;
      }
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.querySelector(`.menu-btn[data-tab="${tabId}"]`);
      if (activeBtn) activeBtn.classList.add('active');
      if (tabId === 'packTab') {
        loadOptions();
        loadBilans();
      }
      if (tabId === 'calculeTab') {
        loadEnterprisesByStatus();
        loadBilans();
      }
      if (tabId === 'offreTab') {
        google.script.run.withSuccessHandler(populatePacksForOffre).getPacksByStatus('validé');
        updatePrixVisitePermissions();
        updateFinancialSummaryTable();
      }
      if (tabId === 'suiviTab') {
        loadMissions();
      }
      if (tabId === 'editTab') {
        document.getElementById('editForm').style.display = 'none';
        document.getElementById('editCodeOpe').value = '';
      }
      if (tabId === 'acteTab') {
        loadActesTable();
      }
      if (tabId === 'medTab') {
        loadMedecinsTable();
      }
      if (tabId === 'infTab') {
        loadInfirmiersTable();
      }
      if (tabId === 'techTab') {
        loadTechRadiosTable();
      }
      if (tabId === 'coordTab') {
        loadCoordinateursTable();
      }
      if (tabId === 'matTab') {
        loadMaterielsTable();
      }
      if (tabId === 'entrepriseTab') {
        loadEntreprisesTable();
      }
      if (tabId === 'remunTab') {
        loadRemunerations();
      }
      if (tabId === 'paiementsTab') {
        loadPaidRemunerations();
      }
      if (tabId === 'dataPackTab') {
        loadAllPacksData();
      }
      if (tabId === 'dataCalculeTab') {
        loadAllPacksData();
        loadAllCalculeData();
        renderDataOffreTable();
      }
      if (tabId === 'financeTab') {
        loadFinanceTab();
      }
      if (tabId === 'dashboardTab') {
        loadDashboard();
      }
      if (tabId === 'adminTab') {
        loadUsersAdmin();
      }
      if (tabId === 'progPersonnelTab') {
        loadProgPersonnel();
      }
      if (tabId === 'progMaterielTab') {
        loadProgMateriel();
      }
      if (tabId === 'renouvellementTab') {
        // Populate entreprise list
        if (availableEntreprises && availableEntreprises.length > 0) {
          populateDataList('entrepriseListRenouvellement', availableEntreprises);
        }
      }
      if (tabId === 'commercialTab') {
        loadCommerciauxTable();
      }
    }
    function bindMenuDelegation() {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar) return;
      sidebar.addEventListener('click', evt => {
        const btn = evt.target.closest('.menu-btn');
        if (!btn) return;
        const tabId = btn.dataset.tab;
        if (!tabId) return;
        console.log('Clic détecté sur menu-btn, ouverture de tab:', tabId); // Log pour debug
        showTab(tabId);
      });
    }

    // === AUDIT TRAIL (JOURNALISATION SIMPLIFIÉE) ===
    function logAudit(action, details) {
      const timestamp = new Date().toISOString();
      const logEntry = {
        timestamp: timestamp,
        user: currentUser.name || 'Anonyme',
        role: currentUser.role || 'N/A',
        action: action,
        details: details
      };
      
      // Envoyer au backend pour stockage dans feuille Audit
      google.script.run
        .withSuccessHandler(() => console.log('Audit log enregistré'))
        .withFailureHandler((err) => console.error('Erreur audit log:', err))
        .logAuditTrail(logEntry);
    }
    
    window.onload = () => {
      // Initialiser la session utilisateur
      if (!initUserSession()) {
        showLoginDialog();
      } else {
        updateUIForRole();
        applyAccessControl();
        loadAllPacksData();
        loadUsersAdmin();
      }
      
      bindMenuDelegation();
      loadOptions();
      loadMarginThreshold();
      loadCalculationParameters();
      initAdminSelectAll();
      showTab('homeTab');
      
      // Charger notifications
      updateNotifications();
      setInterval(updateNotifications, 60000);
    };
    // === ALERTES MODERNES ===
    function showAlert(message, type = 'success', id) {
      const errorDiv = id ? document.getElementById(id) : null;
      if (errorDiv) {
        errorDiv.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
        errorDiv.innerHTML = `<span class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</span> ${message}`;
        errorDiv.style.display = 'block';
        setTimeout(() => errorDiv.innerHTML = '', 5000);
      } else {
        alert(message);
      }
    }
    // === ON SUCCESS / ERROR ===
    function onSuccess(message) {
      showAlert(message, 'success');
    }
    function onFailure(error) {
      showAlert('Erreur: ' + (error ? error.message || error : 'Erreur inconnue'), 'error');
    }
    // === FONCTIONS POUR BILANS ET AUTRES ACTES (Reformulées) ===
    function loadBilans() {
      showLoader(true);
      google.script.run.withSuccessHandler(actes => {
        allActes = actes;
        document.querySelectorAll('.bilans-panel-site').forEach(container => populateBilans([container]));
        document.querySelectorAll('.others-panel-site').forEach(container => populateOthers([container]));
        showLoader(false);
      }).withFailureHandler(onFailure).getActes();
    }
    function populateBilans(containers) {
      const bilans = allActes.filter(act => act.famille.toLowerCase() === 'bilan');
      containers.forEach(container => {
        container.innerHTML = '';
        bilans.forEach(act => {
          const div = document.createElement('div');
          div.innerHTML = `
            <input type="checkbox" class="bilan-param" onchange="toggleUnitSpan(this); calcBilanTotalSite(this.closest('.site-panel'))" data-unitprice="${act.prixPublic}" data-coutunitaire="${act.coutUnitaire}" data-majoration="${act.majoration}" data-soustraittance="${act.sousTraitance}">
            <label>${act.parametre}</label>
            <span class="unit-price" style="display:none"> ( (Prix Public: ${act.prixPublic})</span>
          `;
          container.appendChild(div);
        });
        calcBilanTotalSite(container.closest('.site-panel'));
      });
    }
    function populateOthers(containers) {
      const others = allActes.filter(act => act.famille.toLowerCase() !== 'bilan');
      containers.forEach(container => {
        container.innerHTML = '';
        others.forEach(act => {
          const div = document.createElement('div');
          div.innerHTML = `
            <input type="checkbox" class="other-param" onchange="toggleOtherFields(this); calcOtherTotalSite(this.closest('.site-panel'))" data-unitprice="${act.prixPublic}" data-parametre="${act.parametre}" data-coutunitaire="${act.coutUnitaire}" data-majoration="${act.majoration}" data-soustraittance="${act.sousTraitance}">
            <label>${act.parametre}</label>
            <span class="unit-price" style="display:none"> (Prix Public: ${act.prixPublic})</span>
            <input type="number" class="nbr-other-param" style="display:none; width:100px;" min="0" oninput="calcOtherTotalSite(this.closest('.site-panel'))" placeholder="Nbr Employés" onblur="enforceSiteNbrLimit(this); validateInput(this, v => parseInt(v) >= 0)">
            <input type="number" class="prix-u-other-param" style="display:none; width:100px;" step="0.01" value="${act.prixPublic}" placeholder="Prix U" oninput="calcOtherTotalSite(this.closest('.site-panel'))" onblur="validateInput(this, v => parseFloat(v) >= 0)">
          `;
          container.appendChild(div);
        });
        calcOtherTotalSite(container.closest('.site-panel'));
      });
    }
    function toggleUnitSpan(cb) {
      const unitSpan = cb.nextElementSibling.nextElementSibling;
      unitSpan.style.display = cb.checked ? 'inline' : 'none';
    }
    function toggleOtherFields(cb) {
      const unitSpan = cb.nextElementSibling.nextElementSibling;
      const nbrInput = unitSpan.nextElementSibling;
      const prixInput = nbrInput.nextElementSibling;
      unitSpan.style.display = cb.checked ? 'inline' : 'none';
      nbrInput.style.display = cb.checked ? 'inline' : 'none';
      prixInput.style.display = cb.checked ? 'inline' : 'none';
      if (!cb.checked) {
        nbrInput.value = 0;
        prixInput.value = cb.dataset.unitprice; // Reset to default
      }
      calcOtherTotalSite(cb.closest('.site-panel'));
    }
    function calcBilanTotalSite(panel) {
      let sumUnit = 0;
      let totalCout = 0;
      panel.querySelectorAll('.bilan-param:checked').forEach(cb => {
        sumUnit += parseFloat(cb.dataset.unitprice) || 0;
        totalCout += parseFloat(cb.dataset.majoration) || 0;
      });
      const nbr = parseInt(panel.querySelector('.nbr-bilan-site').value) || 0;
      const totalClinique = sumUnit * nbr;
      totalCout *= nbr;
      panel.querySelector('.total-clinique-bilan-site').textContent = totalClinique.toFixed(2);
      panel.querySelector('.total-cout-bilan-site').textContent = totalCout.toFixed(2);
      const remise = parseFloat(panel.querySelector('.remise-bilan-site').value) || 0;
      let totalOffre = totalClinique * (1 - remise / 100);
      const prixU = parseFloat(panel.querySelector('.prix-unitaire-bilan-site').value) || 0;
      if (prixU > 0) {
        totalOffre = prixU * nbr;
      }
      panel.querySelector('.total-offre-bilan-site').value = totalOffre.toFixed(2);
      panel.querySelector('.total-bilan-site').textContent = totalOffre.toFixed(2);
      const newPrixU = nbr > 0 ? (totalOffre / nbr).toFixed(2) : 0;
      panel.querySelector('.prix-unitaire-bilan-site').value = newPrixU;
      calcTotalSite(panel);
    }
    function calcRemiseBilanSite(panel) {
      const totalClinique = parseFloat(panel.querySelector('.total-clinique-bilan-site').textContent) || 0;
      const totalOffre = parseFloat(panel.querySelector('.total-offre-bilan-site').value) || 0;
      if (totalClinique > 0) {
        const remise = ((totalClinique - totalOffre) / totalClinique * 100).toFixed(2);
        panel.querySelector('.remise-bilan-site').value = remise;
      } else {
        panel.querySelector('.remise-bilan-site').value = 0;
      }
      panel.querySelector('.total-bilan-site').textContent = totalOffre.toFixed(2);
      const nbr = parseInt(panel.querySelector('.nbr-bilan-site').value) || 0;
      const prixU = nbr > 0 ? (totalOffre / nbr).toFixed(2) : 0;
      panel.querySelector('.prix-unitaire-bilan-site').value = prixU;
      calcTotalSite(panel);
    }
    function calcTotalOffreFromRemiseBilanSite(panel) {
      const totalClinique = parseFloat(panel.querySelector('.total-clinique-bilan-site').textContent) || 0;
      const remise = parseFloat(panel.querySelector('.remise-bilan-site').value) || 0;
      const totalOffre = totalClinique * (1 - remise / 100);
      panel.querySelector('.total-offre-bilan-site').value = totalOffre.toFixed(2);
      panel.querySelector('.total-bilan-site').textContent = totalOffre.toFixed(2);
      const nbr = parseInt(panel.querySelector('.nbr-bilan-site').value) || 0;
      const prixU = nbr > 0 ? (totalOffre / nbr).toFixed(2) : 0;
      panel.querySelector('.prix-unitaire-bilan-site').value = prixU;
      calcTotalSite(panel);
    }
    function calcFromPrixUnitaireBilanSite(panel) {
      const prixU = parseFloat(panel.querySelector('.prix-unitaire-bilan-site').value) || 0;
      const nbr = parseInt(panel.querySelector('.nbr-bilan-site').value) || 0;
      const totalOffre = prixU * nbr;
      panel.querySelector('.total-offre-bilan-site').value = totalOffre.toFixed(2);
      panel.querySelector('.total-bilan-site').textContent = totalOffre.toFixed(2);
      calcRemiseBilanSite(panel);
      calcTotalSite(panel);
    }
    function calcOtherTotalSite(panel) {
      let totalClinique = 0;
      let totalCout = 0;
      let totalNbr = 0;
      panel.querySelectorAll('.other-param:checked').forEach(cb => {
        const nbrInput = cb.parentElement.querySelector('.nbr-other-param');
        const prixInput = cb.parentElement.querySelector('.prix-u-other-param');
        const nbr = parseInt(nbrInput.value) || 0;
        const prixU = parseFloat(prixInput.value) || 0;
        totalNbr += nbr;
        totalClinique += prixU * nbr;
        totalCout += (parseFloat(cb.dataset.majoration) || 0) * nbr;
      });
      panel.querySelector('.total-clinique-other-site').textContent = totalClinique.toFixed(2);
      panel.querySelector('.total-cout-other-site').textContent = totalCout.toFixed(2);
      const remiseOther = parseFloat(panel.querySelector('.remise-other-site').value) || 0;
      let totalOffre = totalClinique * (1 - remiseOther / 100);
      const prixU = parseFloat(panel.querySelector('.prix-unitaire-other-site').value) || 0;
      if (prixU > 0) {
        totalOffre = prixU * totalNbr;
      }
      panel.querySelector('.total-offre-other-site').value = totalOffre.toFixed(2);
      panel.querySelector('.total-other-site').textContent = totalOffre.toFixed(2);
      const newPrixU = totalNbr > 0 ? (totalOffre / totalNbr).toFixed(2) : 0;
      panel.querySelector('.prix-unitaire-other-site').value = newPrixU;
      calcTotalSite(panel);
    }
    function calcRemiseOtherSite(panel) {
      const totalClinique = parseFloat(panel.querySelector('.total-clinique-other-site').textContent) || 0;
      const totalOffre = parseFloat(panel.querySelector('.total-offre-other-site').value) || 0;
      if (totalClinique > 0) {
        const remise = ((totalClinique - totalOffre) / totalClinique * 100).toFixed(2);
        panel.querySelector('.remise-other-site').value = remise;
      } else {
        panel.querySelector('.remise-other-site').value = 0;
      }
      panel.querySelector('.total-other-site').textContent = totalOffre.toFixed(2);
      let totalNbr = 0;
      panel.querySelectorAll('.other-param:checked').forEach(cb => {
        const nbrInput = cb.parentElement.querySelector('.nbr-other-param');
        totalNbr += parseInt(nbrInput.value) || 0;
      });
      const prixU = totalNbr > 0 ? (totalOffre / totalNbr).toFixed(2) : 0;
      panel.querySelector('.prix-unitaire-other-site').value = prixU;
      calcTotalSite(panel);
    }
    function calcTotalOffreFromRemiseSite(panel) {
      const totalClinique = parseFloat(panel.querySelector('.total-clinique-other-site').textContent) || 0;
      const remise = parseFloat(panel.querySelector('.remise-other-site').value) || 0;
      const totalOffre = totalClinique * (1 - remise / 100);
      panel.querySelector('.total-offre-other-site').value = totalOffre.toFixed(2);
      panel.querySelector('.total-other-site').textContent = totalOffre.toFixed(2);
      let totalNbr = 0;
      panel.querySelectorAll('.other-param:checked').forEach(cb => {
        const nbrInput = cb.parentElement.querySelector('.nbr-other-param');
        totalNbr += parseInt(nbrInput.value) || 0;
      });
      const prixU = totalNbr > 0 ? (totalOffre / totalNbr).toFixed(2) : 0;
      panel.querySelector('.prix-unitaire-other-site').value = prixU;
      calcTotalSite(panel);
    }
    function calcFromPrixUnitaireOtherSite(panel) {
      const prixU = parseFloat(panel.querySelector('.prix-unitaire-other-site').value) || 0;
      let totalNbr = 0;
      panel.querySelectorAll('.other-param:checked').forEach(cb => {
        const nbrInput = cb.parentElement.querySelector('.nbr-other-param');
        totalNbr += parseInt(nbrInput.value) || 0;
      });
      const totalOffre = prixU * totalNbr;
      panel.querySelector('.total-offre-other-site').value = totalOffre.toFixed(2);
      panel.querySelector('.total-other-site').textContent = totalOffre.toFixed(2);
      calcRemiseOtherSite(panel);
      calcTotalSite(panel);
    }
    function addTauxRow(section, type, defaultTaux) {
      const container = section.querySelector('.taux-container');
      const panel = section.closest('.site-panel');
      const nbrPers = parseInt(panel.querySelector('.nbr-' + (type === 'medecin' ? 'med' : type === 'infirmier' ? 'inf' : 'tech') + '-site').value) || 1;
      const jourClass = type === 'medecin' ? 'medecin' : type === 'infirmier' ? 'infirmier' : 'tech-radio';
      const nbrJour = parseInt(panel.querySelector('.nbr-jour-' + jourClass).value) || 0;
      const count = container.children.length;
      const isExtra = count >= nbrPers;
      const row = document.createElement('div');
      row.className = 'personnel-row';
      let html = `
        <input class="taux-input" type="number" value="${defaultTaux}" placeholder="Taux/Jour" oninput="calcRemunSite(this.closest('.site-panel'), '${type}')">
        <button class="btn-danger btn-small" onclick="removeTauxRow(this, '${type}')"><span class="material-icons">delete</span> Supprimer</button>
      `;
      if (isExtra) {
        html += `
          <label>Nbr Jours:</label>
          <input class="nbr-jours-input" type="number" value="${nbrJour}" oninput="calcRemunSite(this.closest('.site-panel'), '${type}')">
          <div class="observation-section">
            <label>Observation:</label>
            <textarea class="observation"></textarea>
          </div>
        `;
      }
      row.innerHTML = html;
      container.appendChild(row);
      calcRemunSite(panel, type);
    }
    function removeTauxRow(button, type) {
      button.parentElement.remove();
      calcRemunSite(button.closest('.site-panel'), type);
    }
    function calcRemunSite(panel, type) {
      // Rémunération panel removed from Pack tab, now in R-H only
      if (!panel) return;
      const remunSpan = panel.querySelector(`.remun-${type}`);
      if (!remunSpan) return; // Panel doesn't exist in Pack tab anymore
      const section = remunSpan.closest('.remun-section');
      if (!section) return;
      let totalRemunType = 0;
      const rows = section.querySelectorAll('.personnel-row');
      const nbrJourInput = panel.querySelector(`.nbr-jour-${type}`);
      const defaultNbrJour = nbrJourInput ? parseInt(nbrJourInput.value) || 0 : 0;
      rows.forEach(row => {
        const taux = parseFloat(row.querySelector('.taux-input').value) || 0;
        const nbrJourInput = row.querySelector('.nbr-jours-input');
        const nbrJour = nbrJourInput ? parseInt(nbrJourInput.value) || 0 : defaultNbrJour;
        totalRemunType += nbrJour * taux;
      });
      remunSpan.textContent = totalRemunType.toFixed(2);
      calcTotalRemunSite(panel);
    }
    function calcTotalRemunSite(panel) {
      // Rémunération panel removed from Pack tab, now in R-H only
      if (!panel) return;
      const totalRemunSpan = panel.querySelector('.total-remun-site');
      if (!totalRemunSpan) return; // Panel doesn't exist in Pack tab anymore
      let totalRemun = 0;
      const medSpan = panel.querySelector('.remun-medecin');
      const infSpan = panel.querySelector('.remun-infirmier');
      const techSpan = panel.querySelector('.remun-tech-radio');
      const techCheckbox = panel.querySelector('.ajoute-tech-radio');
      if (medSpan) totalRemun += parseFloat(medSpan.textContent) || 0;
      if (infSpan) totalRemun += parseFloat(infSpan.textContent) || 0;
      if (techCheckbox && techCheckbox.checked && techSpan) {
        totalRemun += parseFloat(techSpan.textContent) || 0;
      }
      totalRemunSpan.textContent = totalRemun.toFixed(2);
      calcTotalSite(panel);
    }
    function calcYalidineTotalSite(panel) {
      // Yalidine panel removed from Pack tab, now in R-H only
      if (!panel) return;
      const nbrJourInput = panel.querySelector('.nbr-jour-yalidine');
      const tarifInput = panel.querySelector('.tarif-yalidine');
      const totalSpan = panel.querySelector('.total-yalidine-site');
      if (!nbrJourInput || !tarifInput || !totalSpan) return; // Panel doesn't exist in Pack tab anymore
      const nbrJour = parseInt(nbrJourInput.value) || 0;
      const tarif = parseFloat(tarifInput.value) || 0;
      const totalYalidine = nbrJour * tarif;
      totalSpan.textContent = totalYalidine.toFixed(2);
      calcTotalSite(panel);
    }
    function recalcYalidineSite(panel) {
      // Yalidine panel removed from Pack tab, now in R-H only
      if (!panel) return;
      const nbrJourInfInput = panel.querySelector('.nbr-jour-infirmier');
      const nbrJourYalidineInput = panel.querySelector('.nbr-jour-yalidine');
      if (!nbrJourInfInput || !nbrJourYalidineInput) return; // Panel doesn't exist in Pack tab anymore
      const nbrJourInf = parseInt(nbrJourInfInput.value) || 0;
      nbrJourYalidineInput.value = nbrJourInf;
      calcYalidineTotalSite(panel);
    }
    function checkAvion(input, role) {
      // Charge panel removed from Pack tab, now in R-H only
      const panel = input.closest('.site-panel');
      if (!panel) return;
      const hebergSelect = panel.querySelector('.hebergement-site');
      const fraisInput = panel.querySelector('.frais-' + role + '-site');
      // These elements don't exist in Pack tab anymore
      if (!hebergSelect || !fraisInput) return;
      const distance = parseFloat(input.value.replace(',', '.')) || 0;
      const avionDiv = panel.querySelector(`.avion-${role}`);
      if (avionDiv && role !== 'mat' && distance > 400) {
        avionDiv.style.display = 'block';
      } else if (avionDiv) {
        avionDiv.style.display = 'none';
      }
      if (distance > 120 && role !== 'mat') {
        hebergSelect.value = 'oui';
        toggleDureeSite(panel);
        if (!fraisInput.value) {
          fraisInput.value = 5000;
        }
      }
      calcChargeSite(panel);
    }
    function toggleCheckbox(cb, otherClass) {
      const other = cb.closest('.form-row').querySelector(`.${otherClass}`);
      if (other && cb.checked) other.checked = false;
    }
    function calcChargeSite(panel) {
      // Charge panel removed from Pack tab, now in R-H only
      if (!panel) return;
      const totalChargeSpan = panel.querySelector('.total-charge-site');
      if (!totalChargeSpan) return; // Panel doesn't exist in Pack tab anymore
      
      console.log('calcChargeSite called for panel', panel);
      const tarifKlmInput = panel.querySelector('.tarif-klm-site');
      const tarifKlmMatInput = panel.querySelector('.tarif-klm-materiel');
      if (!tarifKlmInput) return; // Elements don't exist in Pack tab anymore
      
      const tarifKlm = parseFloat(tarifKlmInput.value) || 0;
      const tarifKlmMat = tarifKlmMatInput ? parseFloat(tarifKlmMatInput.value) || 0 : 0;
      let transportCost = 0;
      
      const nbrJourMed = panel.querySelector('.nbr-jour-medecin');
      const nbrJourInf = panel.querySelector('.nbr-jour-infirmier');
      const nbrJourTech = panel.querySelector('.nbr-jour-tech-radio');
      if (!nbrJourMed || !nbrJourInf) return; // Elements don't exist in Pack tab anymore
      
      const nbrJourMedecin = parseInt(nbrJourMed.value) || 0;
      const nbrJourInfirmier = parseInt(nbrJourInf.value) || 0;
      const nbrJourTechRadio = nbrJourTech ? parseInt(nbrJourTech.value) || 0 : 0;
      const nbrMed = parseInt(panel.querySelector('.nbr-med-site').value) || 1;
      const nbrInf = parseInt(panel.querySelector('.nbr-inf-site').value) || 1;
      const nbrTech = parseInt(panel.querySelector('.nbr-tech-site').value) || 1;
      const roles = [
        {role: 'med', distanceClass: '.distance-medecin-site', chaqueJourClass: '.aller-retour-chaque-jour-med', uneFoisClass: '.aller-retour-1fois-med', avionClass: '.avion-med', useAvionClass: '.use-avion-med', nbrJour: nbrJourMedecin, nbrPers: nbrMed},
        {role: 'inf', distanceClass: '.distance-infirmier-site', chaqueJourClass: '.aller-retour-chaque-jour-inf', uneFoisClass: '.aller-retour-1fois-inf', avionClass: '.avion-inf', useAvionClass: '.use-avion-inf', nbrJour: nbrJourInfirmier, nbrPers: nbrInf},
        {role: 'tech', distanceClass: '.distance-tech-radio-site', chaqueJourClass: '.aller-retour-chaque-jour-tech', uneFoisClass: '.aller-retour-1fois-tech', avionClass: '.avion-tech', useAvionClass: '.use-avion-tech', nbrJour: nbrJourTechRadio, nbrPers: nbrTech}
      ];
      roles.forEach(({role, distanceClass, chaqueJourClass, uneFoisClass, avionClass, useAvionClass, nbrJour, nbrPers}) => {
        const distanceInput = panel.querySelector(distanceClass);
        if (!distanceInput) return;
        const distance = parseFloat(distanceInput.value.replace(',', '.') || 0);
        let cost = 0;
        if (distance > 0) {
          if (avionClass && distance > 400 && panel.querySelector(useAvionClass)?.checked) {
            cost = (parseFloat(panel.querySelector(avionClass).value) || 13500) * nbrPers;
          } else {
            let baseCost = distance * (role === 'mat' ? tarifKlmMat : tarifKlm);
            let multiplier = 2; // Aller-retour de base
            const chaqueJour = panel.querySelector(chaqueJourClass)?.checked || false;
            const uneFois = panel.querySelector(uneFoisClass)?.checked || false;
            if (chaqueJour) {
              multiplier *= nbrJour; // * jours
            } else if (uneFois) {
              multiplier *= 1; // Une fois seulement
            }
            cost = baseCost * multiplier * nbrPers;
          }
        }
        transportCost += cost;
      });
      const hebergSelect = panel.querySelector('.hebergement-site');
      const hebergement = hebergSelect ? hebergSelect.value : 'non';
      let hebergCost = 0;
      if (hebergement === 'oui') {
        const dureeMedInput = panel.querySelector('.duree-med-site');
        const dureeInfInput = panel.querySelector('.duree-inf-site');
        const dureeTechInput = panel.querySelector('.duree-tech-site');
        const fraisMedInput = panel.querySelector('.frais-med-site');
        const fraisInfInput = panel.querySelector('.frais-inf-site');
        const fraisTechInput = panel.querySelector('.frais-tech-site');
        if (dureeMedInput && dureeInfInput && fraisMedInput && fraisInfInput) {
          const dureeMed = parseInt(dureeMedInput.value) || 0;
          const dureeInf = parseInt(dureeInfInput.value) || 0;
          const dureeTech = dureeTechInput ? parseInt(dureeTechInput.value) || 0 : 0;
          const fraisMed = parseFloat(fraisMedInput.value) || 0;
          const fraisInf = parseFloat(fraisInfInput.value) || 0;
          const fraisTech = fraisTechInput ? parseFloat(fraisTechInput.value) || 0 : 0;
          hebergCost = dureeMed * nbrMed * fraisMed + dureeInf * nbrInf * fraisInf + dureeTech * nbrTech * fraisTech;
        }
      }
      const chargeSuppInput = panel.querySelector('.charge-supp-site');
      const chargeSupp = chargeSuppInput ? parseFloat(chargeSuppInput.value) || 0 : 0;
      const ajouterLogCheckbox = panel.querySelector('.ajouter-charge-logistique');
      const ajouterLog = ajouterLogCheckbox ? ajouterLogCheckbox.checked : false;
      let logCost = 0;
      if (ajouterLog) {
        const deplacementInput = panel.querySelector('.deplacement-transport-panier');
        const nombrePersInput = panel.querySelector('.nombre-personnel');
        const fourgonCheckbox = panel.querySelector('.fourgon-checkbox');
        if (deplacementInput && nombrePersInput) {
          const deplacement = parseFloat(deplacementInput.value) || 0;
          const nombrePers = parseInt(nombrePersInput.value) || 0;
          const fourgon = fourgonCheckbox ? fourgonCheckbox.checked : false;
          logCost = (deplacement * nombrePers) * 2;
          if (fourgon) {
            const distanceMatInput = panel.querySelector('.distance-materiel-site');
            if (distanceMatInput) {
              const distanceMat = parseFloat(distanceMatInput.value.replace(',', '.') || 0);
              logCost += (tarifKlmMat * distanceMat) * 2;
            }
          }
        }
      }
      const totalCharge = transportCost + hebergCost + chargeSupp + logCost;
      totalChargeSpan.textContent = totalCharge.toFixed(2);
      calcTotalSite(panel);
    }
    function calcTotalSite(panel) {
      if (!panel) return;
      const totalRevenueSpan = panel.querySelector('.total-revenue-site');
      const totalCostSpan = panel.querySelector('.total-cost-site');
      const totalNetSpan = panel.querySelector('.total-net-site');
      if (!totalRevenueSpan || !totalCostSpan || !totalNetSpan) return;
      
      const totalBilanSpan = panel.querySelector('.total-bilan-site');
      const totalOtherSpan = panel.querySelector('.total-other-site');
      const totalRemunSpan = panel.querySelector('.total-remun-site');
      const totalYalidineSpan = panel.querySelector('.total-yalidine-site');
      const totalChargeSpan = panel.querySelector('.total-charge-site');
      const totalCoutBilanSpan = panel.querySelector('.total-cout-bilan-site');
      const totalCoutOtherSpan = panel.querySelector('.total-cout-other-site');
      const totalCoutParamSpan = panel.querySelector('.total-cout-parametre-site');
      
      const totalBilan = totalBilanSpan ? parseFloat(totalBilanSpan.textContent) || 0 : 0;
      const totalOther = totalOtherSpan ? parseFloat(totalOtherSpan.textContent) || 0 : 0;
      const totalRemun = totalRemunSpan ? parseFloat(totalRemunSpan.textContent) || 0 : 0;
      const totalYalidine = totalYalidineSpan ? parseFloat(totalYalidineSpan.textContent) || 0 : 0;
      const totalCharge = totalChargeSpan ? parseFloat(totalChargeSpan.textContent) || 0 : 0;
      const totalCoutBilan = totalCoutBilanSpan ? parseFloat(totalCoutBilanSpan.textContent) || 0 : 0;
      const totalCoutOther = totalCoutOtherSpan ? parseFloat(totalCoutOtherSpan.textContent) || 0 : 0;
      const totalCout = totalCoutBilan + totalCoutOther;
      if (totalCoutParamSpan) totalCoutParamSpan.textContent = totalCout.toFixed(2);
      const totalRevenue = totalBilan + totalOther;
      const totalCost = totalRemun + totalYalidine + totalCharge + totalCout;
      const totalNet = totalRevenue - totalCost;
      totalRevenueSpan.textContent = totalRevenue.toFixed(2);
      totalCostSpan.textContent = totalCost.toFixed(2);
      totalNetSpan.textContent = totalNet.toFixed(2);
      calcGlobalTotal();
    }
    function calcGlobalTotal() {
      let totalRevenue = 0;
      let totalCost = 0;
      let totalNet = 0;
      document.querySelectorAll('.site-panel').forEach(panel => {
        totalRevenue += parseFloat(panel.querySelector('.total-revenue-site').textContent) || 0;
        totalCost += parseFloat(panel.querySelector('.total-cost-site').textContent) || 0;
        totalNet += parseFloat(panel.querySelector('.total-net-site').textContent) || 0;
      });
      document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);
      document.getElementById('totalCost').textContent = totalCost.toFixed(2);
      document.getElementById('totalNet').textContent = totalNet.toFixed(2);
      if (typeof renderReconciliationView === 'function') renderReconciliationView();
    }
    function updateNbrEmployePack(changedInput = null) {
      let sum = 0;
      document.querySelectorAll('.nbr-employe-site').forEach(inp => {
        sum += parseInt(inp.value) || 0;
      });
      const totalInput = document.getElementById('nbrEmployePack');
      if (totalInput) totalInput.value = sum > 0 ? sum : '';
    }
    function updateNbrBilanSite(input) {
      const panel = input.closest('.site-panel');
      const nbr = parseInt(input.value) || 0;
      panel.querySelector('.nbr-bilan-site').value = nbr;
      calcBilanTotalSite(panel);
    }
    function enforceSiteNbrLimit(input) {
      const panel = input.closest('.site-panel');
      if (!panel) return;
      const max = parseInt(panel.querySelector('.nbr-employe-site')?.value) || 0;
      const val = parseInt(input.value) || 0;
      if (max > 0 && val > max) {
        input.value = max;
        showAlert(`Le nombre d'employés a été ajusté à ${max}.`, 'warning');
      }
      if (input.classList.contains('nbr-bilan-site')) {
        calcBilanTotalSite(panel);
      } else if (input.classList.contains('nbr-other-param')) {
        calcOtherTotalSite(panel);
      }
    }
    function calcNbrJourMedecinSite(panel) {
      const nbrEmploye = parseInt(panel.querySelector('.nbr-employe-site').value) || 0;
      const calcule = parseInt(document.getElementById('global-calcule-jour-medecin').value) || 1;
      const val = Math.ceil(nbrEmploye / calcule) + 1; // Add +1 day as requested
      // Note: Rémunération, Yalidine and Charge panels are now in R-H tab
    }
    function calcNbrJourInfirmierSite(panel) {
      const nbrEmploye = parseInt(panel.querySelector('.nbr-employe-site').value) || 0;
      const calcule = parseInt(document.getElementById('global-calcule-jour-infirmier').value) || 1;
      const val = Math.ceil(nbrEmploye / calcule) + 1; // Add +1 day as requested
      // Note: Rémunération, Yalidine and Charge panels are now in R-H tab
    }
    function calcNbrJourTechRadioSite(panel) {
      const nbrEmploye = parseInt(panel.querySelector('.nbr-employe-site').value) || 0;
      const calcule = parseInt(document.getElementById('global-calcule-jour-tech-radio').value) || 1;
      const val = Math.ceil(nbrEmploye / calcule) + 1; // Add +1 day as requested
      // Note: Rémunération, Yalidine and Charge panels are now in R-H tab
    }
    function toggleTechFieldsSite(panel) {
      const checked = panel.querySelector('.ajoute-tech-radio').checked;
      panel.querySelector('.tech-fields').style.display = checked ? 'block' : 'none';
      panel.querySelector('.nbr-tech-fields').style.display = checked ? 'block' : 'none';
      panel.querySelector('.tech-remun-fields').style.display = checked ? 'block' : 'none';
      panel.querySelector('.tech-distance-row').style.display = checked ? 'flex' : 'none';
      if (!checked) {
        panel.querySelectorAll('.nbr-jour-tech-radio').forEach(inp => inp.value = 0);
        panel.querySelector('.remun-tech-radio').textContent = '0.00';
      } else {
        calcNbrJourTechRadioSite(panel);
      }
      calcTotalRemunSite(panel);
    }
    function recalcAllNbrJour() {
      document.querySelectorAll('.site-panel').forEach(panel => {
        calcNbrJourMedecinSite(panel);
        calcNbrJourInfirmierSite(panel);
        if (panel.querySelector('.ajoute-tech-radio').checked) calcNbrJourTechRadioSite(panel);
      });
    }
    function toggleDureeSite(panel) {
      const hebergement = panel.querySelector('.hebergement-site').value;
      panel.querySelector('.duree-container-site').style.display = hebergement === 'oui' ? 'block' : 'none';
      if (hebergement === 'oui') {
        calcNbrJourMedecinSite(panel);
        calcNbrJourInfirmierSite(panel);
        if (panel.querySelector('.ajoute-tech-radio').checked) calcNbrJourTechRadioSite(panel);
      } else {
        panel.querySelector('.duree-med-site').value = 0;
        panel.querySelector('.duree-inf-site').value = 0;
        panel.querySelector('.duree-tech-site').value = 0;
      }
      calcChargeSite(panel);
    }
    function toggleChargeLogistique(panel) {
      const checked = panel.querySelector('.ajouter-charge-logistique').checked;
      panel.querySelector('.charge-logistique-container').style.display = checked ? 'block' : 'none';
      calcChargeSite(panel);
    }
    function addSitePanel() {
      siteCount++;
      const siteTabsPack = document.getElementById('siteTabsPack');
      const siteContentsPack = document.getElementById('siteContentsPack');
      const tabBtn = document.createElement('button');
      tabBtn.className = 'sub-tab-btn';
      tabBtn.dataset.siteId = siteCount;
      tabBtn.textContent = `Site ${siteCount}`;
      tabBtn.onclick = function() { showSiteTabPack(siteCount); };
      siteTabsPack.appendChild(tabBtn);
      const contentDiv = document.createElement('div');
      contentDiv.className = 'sub-tab-content';
      contentDiv.id = `siteContentPack-${siteCount}`;
      const panel = document.createElement('div');
      panel.className = 'site-panel';
      panel.innerHTML = `
        <div class="form-row">
          <div class="form-group">
            <label>Wilaya:</label>
            <div class="input-wrapper">
              <input class="site-wilaya" list="wilayaList" onblur="validateInput(this, v => v.trim().length > 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Nbr Employée:</label>
            <input class="nbr-employe-site" type="number" oninput="updateNbrEmployePack(this); updateNbrBilanSite(this); calcNbrJourMedecinSite(this.closest('.site-panel')); calcNbrJourInfirmierSite(this.closest('.site-panel')); if(this.closest('.site-panel').querySelector('.ajoute-tech-radio').checked) calcNbrJourTechRadioSite(this.closest('.site-panel')); recalcYalidineSite(this.closest('.site-panel'));" onblur="validateInput(this, v => parseInt(v) > 0)">
            <span class="material-icons validation-icon"></span>
          </div>
          <div class="form-group">
            <label>Lieu (Daira):</label>
            <div class="input-wrapper">
              <input class="lieu-site" type="text" onblur="validateInput(this, v => v.trim().length > 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full">
            <label>
              <input type="checkbox" class="visite-lieux-site" checked disabled>
              Visite des lieux (obligatoire)
            </label>
            <small style="display: block; color: #666; margin-top: 5px;">Au moins un site doit avoir la visite des lieux</small>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <input type="checkbox" class="ajoute-tech-radio" onchange="toggleTechFieldsSite(this.closest('.site-panel'));">
            <label for="ajoute-tech-radio">Ajouté Tech-Radio</label>
          </div>
        </div>
        <div class="tech-fields" style="display:none;">
          <div class="form-row">
            <div class="form-group">
              <label>Nbr Jour Tech-Radio:</label>
              <input class="nbr-jour-tech-radio" type="number" readonly>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Nombre de Médecin:</label>
            <div class="input-wrapper">
              <input class="nbr-med-site" type="number" value="1" min="1" onblur="validateInput(this, v => parseInt(v) >= 1)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-group">
            <label>Nombre d'Infirmier:</label>
            <div class="input-wrapper">
              <input class="nbr-inf-site" type="number" value="1" min="1" oninput="recalcYalidineSite(this.closest('.site-panel'));" onblur="validateInput(this, v => parseInt(v) >= 1)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-group nbr-tech-fields" style="display:none;">
            <label>Nombre Tech-Radio:</label>
            <div class="input-wrapper">
              <input class="nbr-tech-site" type="number" value="1" min="1" onblur="validateInput(this, v => parseInt(v) >= 1)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
        </div>
        <h3>Bilans (sélectionnez paramètres):</h3>
        <div class="bilans-panel-site" style="border: 1px solid #ccc; padding: 10px; border-radius: 8px; margin-bottom: 15px;"></div>
        <div class="form-row">
          <div class="form-group">
            <label>Nbr Employés pour Bilan:</label>
            <div class="input-wrapper">
            <input class="nbr-bilan-site" type="number" oninput="calcBilanTotalSite(this.closest('.site-panel'))" onblur="enforceSiteNbrLimit(this); validateInput(this, v => parseInt(v) >= 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-group">
            <label>Total Clinique: <span class="total-clinique-bilan-site">0.00</span></label>
          </div>
          <div class="form-group">
            <label>Total Offre:</label>
            <div class="input-wrapper">
              <input class="total-offre-bilan-site" type="number" step="0.01" oninput="calcRemiseBilanSite(this.closest('.site-panel'))" onblur="validateInput(this, v => parseFloat(v) >= 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-group">
            <label>Prix Unitaire:</label>
            <div class="input-wrapper">
              <input class="prix-unitaire-bilan-site" type="number" step="0.01" oninput="calcFromPrixUnitaireBilanSite(this.closest('.site-panel'))" onblur="validateInput(this, v => parseFloat(v) >= 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-group">
            <label>Remise (%):</label>
            <div class="input-wrapper">
              <input class="remise-bilan-site" type="number" step="0.01" oninput="calcTotalOffreFromRemiseBilanSite(this.closest('.site-panel'))" onblur="validateInput(this, v => parseFloat(v) >= 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-group">
            <label>Total Bilan: <span class="total-bilan-site">0.00</span></label>
          </div>
        </div>
        <div class="form-group">
          <label>Total Cout: <span class="total-cout-bilan-site">0.00</span></label>
        </div>
        <h3>Autres Paramètres (sélectionnez paramètres):</h3>
        <div class="others-panel-site" style="border: 1px solid #ccc; padding: 10px; border-radius: 8px; margin-bottom: 15px;"></div>
        <div class="form-row">
          <div class="form-group">
            <label>Total Clinique: <span class="total-clinique-other-site">0.00</span></label>
          </div>
          <div class="form-group">
            <label>Total Offre:</label>
            <div class="input-wrapper">
              <input class="total-offre-other-site" type="number" step="0.01" oninput="calcRemiseOtherSite(this.closest('.site-panel'))" onblur="validateInput(this, v => parseFloat(v) >= 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-group">
            <label>Prix Unitaire global:</label>
            <div class="input-wrapper">
              <input class="prix-unitaire-other-site" type="number" step="0.01" oninput="calcFromPrixUnitaireOtherSite(this.closest('.site-panel'))" onblur="validateInput(this, v => parseFloat(v) >= 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-group">
            <label>Remise (%):</label>
            <div class="input-wrapper">
              <input class="remise-other-site" type="number" step="0.01" oninput="calcTotalOffreFromRemiseSite(this.closest('.site-panel'))" onblur="validateInput(this, v => parseFloat(v) >= 0)">
              <span class="material-icons validation-icon"></span>
            </div>
          </div>
          <div class="form-group">
            <label>Total Autres: <span class="total-other-site">0.00</span></label>
          </div>
        </div>
        <div class="form-group">
          <label>Total Cout: <span class="total-cout-other-site">0.00</span></label>
        </div>
        <!-- Panels Rémunération, Yalidine et Charge déplacés vers l'onglet R-H -->
        <div class="total-box">Total Revenue: <span class="total-revenue-site">0.00</span></div>
        <div class="total-box">Total Coût Paramètre: <span class="total-cost-site">0.00</span></div>
      `;
      contentDiv.appendChild(panel);
      populateBilans([panel.querySelector('.bilans-panel-site')]);
      populateOthers([panel.querySelector('.others-panel-site')]);
      siteContentsPack.appendChild(contentDiv);
      showSiteTabPack(siteCount);
      updateSiteNavigation();
    }
    function removeActiveSitePack() {
      const activeBtn = document.querySelector('#siteTabsPack .sub-tab-btn.active');
      if (!activeBtn) return;
      const siteId = activeBtn.dataset.siteId;
      activeBtn.remove();
      document.getElementById(`siteContentPack-${siteId}`).remove();
      siteCount--;
      updateNbrEmployePack();
      calcGlobalTotal();
      const remainingTabs = document.querySelectorAll('#siteTabsPack .sub-tab-btn');
      if (remainingTabs.length > 0) {
        showSiteTabPack(remainingTabs[0].dataset.siteId);
      }
      updateSiteNavigation();
    }
    function showSiteTabPack(siteId) {
      document.querySelectorAll('#siteTabsPack .sub-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('#siteContentsPack .sub-tab-content').forEach(content => content.classList.remove('active'));
      const btn = document.querySelector(`#siteTabsPack [data-site-id="${siteId}"]`);
      if (btn) btn.classList.add('active');
      const content = document.getElementById(`siteContentPack-${siteId}`);
      if (content) content.classList.add('active');
    }
    function switchSitePack(delta) {
      const activeBtn = document.querySelector('#siteTabsPack .sub-tab-btn.active');
      if (!activeBtn) return;
      let currentId = parseInt(activeBtn.dataset.siteId);
      let newId = currentId + delta;
      if (newId < 1 || newId > siteCount) return;
      showSiteTabPack(newId);
    }
    function updateSiteNavigation() {
      const navigation = document.getElementById('siteNavigationPack');
      navigation.style.display = siteCount > 1 ? 'flex' : 'none';
      updateVisiteLieuxCheckboxes();
    }
    
    function updateVisiteLieuxCheckboxes() {
      const allSites = document.querySelectorAll('#siteContentsPack .site-panel');
      
      if (allSites.length === 1) {
        // Single site: checkbox checked and disabled
        const checkbox = allSites[0].querySelector('.visite-lieux-site');
        if (checkbox) {
          checkbox.checked = true;
          checkbox.disabled = true;
        }
      } else if (allSites.length > 1) {
        // Multiple sites: enable all checkboxes, ensure at least one is checked
        allSites.forEach((site, index) => {
          const checkbox = site.querySelector('.visite-lieux-site');
          if (checkbox) {
            checkbox.disabled = false;
            checkbox.onchange = function() {
              validateVisiteLieuxMinimum();
            };
            // Check first one by default
            if (index === 0) {
              checkbox.checked = true;
            }
          }
        });
      }
    }
    
    function validateVisiteLieuxMinimum() {
      const allCheckboxes = document.querySelectorAll('.visite-lieux-site');
      const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
      
      if (checkedCount === 0) {
        showAlert('Au moins un site doit avoir la visite des lieux.', 'error', 'packError');
        // Re-check the first one
        if (allCheckboxes.length > 0) {
          allCheckboxes[0].checked = true;
        }
      }
    }
    
    function createPack() {
      try {
        const packNameInput = document.getElementById('packName');
        const entrepriseInput = document.getElementById('entreprise');
        const commercialInput = document.getElementById('commercialPack');
        if (!packNameInput || !entrepriseInput || !commercialInput) {
          showAlert('Onglet Pack non chargé : rouvrez l’onglet Pack puis réessayez.', 'error', 'packError');
          return;
        }
        const packName = packNameInput.value.trim();
        const entreprise = entrepriseInput.value.trim();
        const commercial = commercialInput.value.trim();
        let nbrEmployePack = 0;
        const acts = [];
        let nbrMed = 0;
        let nbrInf = 0;
        let nbrTech = 0;
        let totalParamPack = 0;
        let totalYalidinePack = 0;
        let totalRemunPack = 0;
        let totalTransportPack = 0;
        // Vérifier la présence des éléments critiques (cas onglet non chargé)
        const requiredIds = [
          'global-calcule-jour-medecin',
          'global-calcule-jour-infirmier',
          'global-calcule-jour-tech-radio',
          'siteTabsPack',
          'totalCost',
          'totalRevenue',
          'totalNet'
        ];
        const missing = requiredIds.filter(id => !document.getElementById(id));
        if (missing.length) {
          showAlert('Onglet Pack non chargé : rouvrez l’onglet Pack puis réessayez.', 'error', 'packError');
          return;
        }
      if (!packName || !entreprise || !commercial) {
        showAlert('Tous les champs obligatoires doivent être remplis (Pack, Commercial, Entreprise).', 'error', 'packError');
        return;
      }
      if (!availableEntreprises.includes(entreprise)) {
        showAlert('Sélectionnez une entreprise valide de la liste.', 'error', 'packError');
        return;
      }
      let lieux = [];
      let totalEmployesSite = 0;
      let hasError = false;
      let hasCheckboxError = false;
      let calculeJourMedecin = parseInt(document.getElementById('global-calcule-jour-medecin')?.value) || 20;
      let nbrJourMedecin = 0;
      let calculeJourInfirmier = parseInt(document.getElementById('global-calcule-jour-infirmier')?.value) || 30;
      let nbrJourInfirmier = 0;
      let calculeJourTechRadio = parseInt(document.getElementById('global-calcule-jour-tech-radio')?.value) || 30;
      let nbrJourTechRadio = 0;
      document.querySelectorAll('#siteTabsPack .sub-tab-btn').forEach((btn, index) => {
        const siteId = btn.dataset.siteId;
        const content = document.getElementById(`siteContentPack-${siteId}`);
        const panel = content && content.querySelector('.site-panel');
        const siteStr = `Site ${index + 1}`;
        const lieuEntreprise = panel.querySelector('.lieu-site')?.value.trim();
        if (!lieuEntreprise) {
          showAlert('Lieu (Daira) obligatoire pour ' + siteStr, 'error', 'packError');
          hasError = true;
          return;
        }
        lieux.push(lieuEntreprise);
        const nbrSite = parseInt(panel.querySelector('.nbr-employe-site')?.value) || 0;
        if (nbrSite <= 0) {
          showAlert('Nombre d\'employés positif obligatoire pour ' + siteStr, 'error', 'packError');
          hasError = true;
          return;
        }
        totalEmployesSite += nbrSite;
        
        // Validation visite des lieux
        const visiteLieuxCheckbox = panel.querySelector('.visite-lieux-site');
        if (!visiteLieuxCheckbox?.checked) {
          showAlert('La visite des lieux est obligatoire pour au moins un site.', 'error', 'packError');
          hasError = true;
          return;
        }
        
        const roles = [
          {role: 'med', distanceClass: '.distance-medecin-site', chaqueJourClass: '.aller-retour-chaque-jour-med', uneFoisClass: '.aller-retour-1fois-med'},
          {role: 'inf', distanceClass: '.distance-infirmier-site', chaqueJourClass: '.aller-retour-chaque-jour-inf', uneFoisClass: '.aller-retour-1fois-inf'},
          {role: 'tech', distanceClass: '.distance-tech-radio-site', chaqueJourClass: '.aller-retour-chaque-jour-tech', uneFoisClass: '.aller-retour-1fois-tech'},
          {role: 'mat', distanceClass: '.distance-materiel-site', chaqueJourClass: '.aller-retour-chaque-jour-mat', uneFoisClass: '.aller-retour-1fois-mat'}
        ];
        roles.forEach(({role, distanceClass, chaqueJourClass, uneFoisClass}) => {
          const distanceInput = panel.querySelector(distanceClass);
          const distance = parseFloat((distanceInput?.value || '0').replace(',', '.')) || 0;
          if (distance > 0 && !panel.querySelector(chaqueJourClass)?.checked && !panel.querySelector(uneFoisClass)?.checked) {
            hasCheckboxError = true;
          }
        });
        if (hasCheckboxError) {
          showAlert('Sélectionnez une option de voyage pour chaque distance dans ' + siteStr, 'error', 'packError');
          hasError = true;
        }
        const siteNbrMed = parseInt(panel.querySelector('.nbr-med-site')?.value) || 1;
        const siteNbrInf = parseInt(panel.querySelector('.nbr-inf-site')?.value) || 1;
        const siteNbrTech = panel.querySelector('.ajoute-tech-radio')?.checked ? parseInt(panel.querySelector('.nbr-tech-site')?.value) || 1 : 0;
        const remunSections = panel.querySelectorAll('.remun-section').length;
        const medCount = panel.querySelectorAll('.remun-section:nth-of-type(1) .taux-container .personnel-row').length;
        const infCount = panel.querySelectorAll('.remun-section:nth-of-type(2) .taux-container .personnel-row').length;
        const techCount = panel.querySelectorAll('.remun-section.tech-remun-fields .taux-container .personnel-row').length;
        if (remunSections > 0 && medCount + infCount === 0) {
          showAlert('Ajoutez au moins un médecin ou un infirmier pour ' + siteStr, 'error', 'packError');
          hasError = true;
          return;
        }
        if (panel.querySelector('.ajoute-tech-radio')?.checked && remunSections > 0 && techCount === 0) {
          showAlert('Ajoutez au moins un tech-radio pour ' + siteStr, 'error', 'packError');
          hasError = true;
          return;
        }
        nbrMed += siteNbrMed;
        nbrInf += siteNbrInf;
        nbrTech += siteNbrTech;
        nbrJourMedecin += parseInt(panel.querySelector('.nbr-jour-medecin')?.value) || 0;
        nbrJourInfirmier += parseInt(panel.querySelector('.nbr-jour-infirmier')?.value) || 0;
        if (panel.querySelector('.ajoute-tech-radio')?.checked) {
          nbrJourTechRadio += parseInt(panel.querySelector('.nbr-jour-tech-radio')?.value) || 0;
        }
        const totalCliniqueBilanSite = parseFloat(panel.querySelector('.total-clinique-bilan-site')?.textContent || '0') || 0;
        const totalOffreBilanSite = parseFloat(panel.querySelector('.total-offre-bilan-site')?.value || '0') || totalCliniqueBilanSite;
        const nbrBilanSite = parseInt(panel.querySelector('.nbr-bilan-site')?.value) || 0;
        const remiseBilanSite = parseFloat(panel.querySelector('.remise-bilan-site')?.value) || 0;
        const siteRevenue = parseFloat(panel.querySelector('.total-revenue-site')?.textContent || '0') || 0;
        const siteCost = parseFloat(panel.querySelector('.total-cost-site')?.textContent || '0') || 0;
        const siteNet = parseFloat(panel.querySelector('.total-net-site')?.textContent || '0') || 0;
        const siteParam = parseFloat(panel.querySelector('.total-cout-parametre-site')?.textContent || '0') || 0;
        const siteYalidine = parseFloat(panel.querySelector('.total-yalidine-site')?.textContent || '0') || 0;
        const siteRemun = parseFloat(panel.querySelector('.total-remun-site')?.textContent || '0') || 0;
        const siteTransport = parseFloat(panel.querySelector('.total-charge-site')?.textContent || '0') || 0;
        totalParamPack += siteParam;
        totalYalidinePack += siteYalidine;
        totalRemunPack += siteRemun;
        totalTransportPack += siteTransport;
        if (totalCliniqueBilanSite > 0 && nbrBilanSite > 0) {
          const prixUSite = totalOffreBilanSite / nbrBilanSite;
          acts.push({site: siteStr, lieu: lieuEntreprise, acte: 'bilan', nbrEmploye: nbrBilanSite, prixU: prixUSite, remise: remiseBilanSite, nbrMed: siteNbrMed, nbrInf: siteNbrInf, nbrTech: siteNbrTech, siteCost, siteNet, siteRevenue});
        }
        const remiseOtherSite = parseFloat(panel.querySelector('.remise-other-site')?.value) || 0;
        panel.querySelectorAll('.other-param:checked').forEach(cb => {
          const nbrInput = cb.parentElement.querySelector('.nbr-other-param');
          const prixInput = cb.parentElement.querySelector('.prix-u-other-param');
          const nbr = parseInt(nbrInput?.value) || 0;
          const prixU = parseFloat(prixInput?.value) || 0;
          if (nbr > 0) {
            acts.push({site: siteStr, lieu: lieuEntreprise, acte: cb.dataset.parametre, nbrEmploye: nbr, prixU: prixU, remise: remiseOtherSite, nbrMed: siteNbrMed, nbrInf: siteNbrInf, nbrTech: siteNbrTech, siteCost, siteNet, siteRevenue});
          }
        });
      });
      if (hasError) return;
      if (acts.length === 0) {
        showAlert('Ajoutez au moins un acte valide (bilan ou autres).', 'error', 'packError');
        return;
      }
      nbrEmployePack = totalEmployesSite;
      document.getElementById('nbrEmployePack').value = nbrEmployePack || '';
      const totalChargeEstPanel = parseFloat(document.getElementById('totalCost').textContent) || 0;
      const totalRevenuePack = parseFloat(document.getElementById('totalRevenue').textContent) || 0;
      const totalCostPack = parseFloat(document.getElementById('totalCost').textContent) || 0;
      const totalNetPack = parseFloat(document.getElementById('totalNet').textContent) || 0;
      const estimation = {tauxMedEst: 0, tauxInfEst: 0, tauxTechEst: 0, tauxLogEst: 0, distanceEst: 0, tarifKlmEst: 0, dureeEst: 0, fraisNuitEst: 0, chargeSuppEst: 0, totalChargeEstPanel, totalParamPack, totalYalidinePack, totalRemunPack, totalTransportPack};
      showLoader(true);
      google.script.run.withSuccessHandler(function(message) { 
        showLoader(false);
        onSuccess(message); 
        clearPackForm(); 
        loadOptions();
        // Log audit trail
        logAudit('Création Pack', `Pack "${packName}" créé pour ${entreprise}`);
      }).withFailureHandler(err => {
        showLoader(false);
        showAlert('Erreur lors de l’enregistrement du pack: ' + (err && err.message ? err.message : 'Erreur inconnue'), 'error', 'packError');
        console.error('Erreur savePack:', err);
      })
        .savePack(packName, entreprise, commercial, nbrEmployePack, acts, calculeJourMedecin, nbrJourMedecin, calculeJourInfirmier, nbrJourInfirmier, calculeJourTechRadio, nbrJourTechRadio, nbrMed, nbrInf, nbrTech, estimation, totalRevenuePack, totalCostPack, totalNetPack);
      } catch (e) {
        showLoader(false);
        showAlert('Erreur interne avant sauvegarde pack: ' + e, 'error', 'packError');
        console.error('Erreur createPack:', e);
      }
    }
    function clearPackForm() {
      document.getElementById('packName').value = '';
      document.getElementById('commercialPack').value = '';
      document.getElementById('entreprise').value = '';
      document.getElementById('nbrEmployePack').value = '';
      document.getElementById('siteTabsPack').innerHTML = '';
      document.getElementById('siteContentsPack').innerHTML = '';
      document.getElementById('siteNavigationPack').style.display = 'none';
      siteCount = 0;
      document.getElementById('totalRevenue').textContent = '0.00';
      document.getElementById('totalCost').textContent = '0.00';
      document.getElementById('totalNet').textContent = '0.00';
    }
    // === FONCTIONS POUR ACTE TAB ===
    function loadActesTable() {
      google.script.run.withSuccessHandler(populateActesTable).withFailureHandler(onFailure).getActes();
    }
    function populateActesTable(actes) {
      const body = document.getElementById('actesBody');
      body.innerHTML = '';
      actes.forEach(act => {
        const row = document.createElement('tr');
        row.dataset.code = act.code;
        row.innerHTML = `
          <td>${act.code}</td>
          <td><input type="text" value="${act.parametre}"></td>
          <td><input type="number" step="0.01" value="${act.coutUnitaire}"></td>
          <td><input type="number" step="0.01" value="${act.majoration}"></td>
          <td><input type="number" step="0.01" value="${act.prixPublic}"></td>
          <td><input type="number" step="0.01" value="${act.sousTraitance}"></td>
          <td><input type="text" value="${act.famille}"></td>
          <td>
            <button class="btn-primary btn-small" onclick="saveActeEdit(this)"><span class="material-icons">save</span> Sauvegarder</button>
            <button class="btn-danger btn-small" onclick="deleteActe(this)"><span class="material-icons">delete</span> Supprimer</button>
          </td>
        `;
        body.appendChild(row);
      });
    }
    function addActe() {
      const parametre = document.getElementById('newActeParametre').value.trim();
      const coutUnitaire = parseFloat(document.getElementById('newActeCout').value) || 0;
      const majoration = parseFloat(document.getElementById('newActeMajoration').value) || 0;
      const prixPublic = parseFloat(document.getElementById('newActePrixPublic').value) || 0;
      const sousTraitance = parseFloat(document.getElementById('newActeSousTraitance').value) || 0;
      const famille = document.getElementById('newActeFamille').value.trim();
      if (!parametre) {
        showAlert('Le paramètre est obligatoire.', 'error', 'acteError');
        return;
      }
      google.script.run.withSuccessHandler(message => {
        onSuccess(message);
        document.getElementById('newActeParametre').value = '';
        document.getElementById('newActeCout').value = '';
        document.getElementById('newActeMajoration').value = '';
        document.getElementById('newActePrixPublic').value = '';
        document.getElementById('newActeSousTraitance').value = '';
        document.getElementById('newActeFamille').value = '';
        loadActesTable();
        loadBilans();
      }).withFailureHandler(onFailure).addActe(parametre, coutUnitaire, majoration, prixPublic, sousTraitance, famille);
    }
    function saveActeEdit(button) {
      const row = button.closest('tr');
      const code = row.dataset.code;
      const inputs = row.querySelectorAll('input');
      const parametre = inputs[0].value.trim();
      const coutUnitaire = parseFloat(inputs[1].value) || 0;
      const majoration = parseFloat(inputs[2].value) || 0;
      const prixPublic = parseFloat(inputs[3].value) || 0;
      const sousTraitance = parseFloat(inputs[4].value) || 0;
      const famille = inputs[5].value.trim();
      if (!parametre) {
        showAlert('Le paramètre est obligatoire.', 'error', 'acteError');
        return;
      }
      google.script.run.withSuccessHandler(message => {
        onSuccess(message);
        loadActesTable();
        loadBilans();
      }).withFailureHandler(onFailure).updateActe(code, parametre, coutUnitaire, majoration, prixPublic, sousTraitance, famille);
    }
    function deleteActe(button) {
      const row = button.closest('tr');
      const code = row.dataset.code;
      if (confirm('Voulez-vous vraiment supprimer cet acte ?')) {
        google.script.run.withSuccessHandler(message => {
          onSuccess(message);
          loadActesTable();
          loadBilans();
        }).withFailureHandler(onFailure).deleteActe(code);
      }
    }
    // === FONCTIONS POUR SUIVI DES MISSIONS ===
    function loadMissions() {
      google.script.run.withSuccessHandler(data => {
        allMissions = data;
        applyFilters();
      }).withFailureHandler(onFailure).getData();
    }
    function displayMissions(missions) {
      const body = document.getElementById('missionsBody');
      body.innerHTML = '';
      missions.forEach(mission => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${mission.codeOpe}</td>
          <td>${mission.coordination}</td>
          <td>${mission.dateOperation}</td>
          <td>${mission.dateEnreg}</td>
          <td>${mission.entreprise}</td>
          <td>${mission.nbrEmployes}</td>
          <td>${mission.lieu}</td>
          <td>${mission.deplacement}</td>
          <td>${mission.medecins}</td>
          <td>${mission.infirmiers}</td>
          <td>${mission.techRadio}</td>
          <td>${mission.materiels}</td>
          <td>${mission.totalCharge}</td>
          <td>${mission.totalNet}</td>
          <td>${mission.statut}</td>
          <td>${mission.pack}</td>
          <td>${mission.dureeMission}</td>
          <td>${mission.statutMission}</td>
          <td>${mission.dateFin}</td>
          <td>
            ${mission.statutMission !== 'Réaliser' ? `<button class="btn-primary btn-small" onclick="editMission(${mission.codeOpe})"><span class="material-icons">edit</span> Éditer</button>` : ''}
          </td>
        `;
        body.appendChild(row);
      });
    }
    function editMission(codeOpe) {
      showTab('editTab');
      document.getElementById('editCodeOpe').value = codeOpe;
      loadMissionForEdit(codeOpe);
    }
    function loadMissionForEdit(codeOpe) {
      if (codeOpe) {
        google.script.run.withSuccessHandler(mission => {
          if (mission) {
            if (mission.statutMission === 'Réaliser') {
              showAlert('Les missions réalisées ne peuvent pas être modifiées.', 'error', 'editError');
              document.getElementById('editForm').style.display = 'none';
              return;
            }
            currentEditCodeOpe = codeOpe;
            document.getElementById('editCoordination').value = mission.coordination;
            document.getElementById('editDateOperation').value = mission.dateOperation;
            document.getElementById('editEntreprise').value = mission.entreprise;
            document.getElementById('editPack').value = mission.pack;
            document.getElementById('editDateEnreg').value = mission.dateEnreg;
            document.getElementById('editLieuEntreprise').value = mission.lieu;
            document.getElementById('editDeplacement').value = mission.deplacement;
            document.getElementById('editNbrJours').value = mission.dureeMission;
            document.getElementById('editDateFin').value = mission.dateFin;
            document.getElementById('editNbrEmploye').value = mission.nbrEmployes;
            document.getElementById('editWilayaDepartMedecin').value = mission.wilayaDepartMedecin;
            document.getElementById('editWilayaDepartInfirmier').value = mission.wilayaDepartInfirmier;
            document.getElementById('editWilayaDepartTechRadio').value = mission.wilayaDepartTechRadio;
            document.getElementById('editDistanceMedecin').value = mission.distanceMedecin;
            document.getElementById('editDistanceInfirmier').value = mission.distanceInfirmier;
            document.getElementById('editDistanceTechRadio').value = mission.distanceTechRadio;
            document.getElementById('editDistanceMateriel').value = mission.distanceMateriel;
            document.getElementById('editNbrInfirmier').value = mission.nbrInfirmier;
            document.getElementById('editNbrMedecin').value = mission.nbrMedecin;
            document.getElementById('editNbrTechRadio').value = mission.nbrTechRadio;
            document.getElementById('editHebergement').value = mission.hebergement;
            toggleDuree('Edit');
            document.getElementById('editDureeMed').value = mission.dureeMed;
            document.getElementById('editDureeInf').value = mission.dureeInf;
            document.getElementById('editDureeTech').value = mission.dureeTech;
            document.getElementById('editDureeLog').value = mission.dureeLog || 0;
            document.getElementById('editChargeSupp').value = mission.chargeSupp;
            document.getElementById('editObservation').value = mission.observation;
            document.getElementById('editFrais').value = mission.frais;
            editPackTotalPrix = mission.packTotalPrix;
            const medecins = mission.medecins ? mission.medecins.split(',') : [];
            document.getElementById('editMedecinsContainer').innerHTML = '';
            medecins.forEach(med => {
              if (med.trim()) {
                addPersonnelRow('editMedecinsContainer', 'editMedecin', 'medList', 'Médecin', 'editNbrMedecin');
                const lastInput = document.querySelector('#editMedecinsContainer .personnel-row:last-child input');
                lastInput.value = med.trim();
              }
            });
            const infirmiers = mission.infirmiers ? mission.infirmiers.split(',') : [];
            document.getElementById('editInfirmiersContainer').innerHTML = '';
            infirmiers.forEach(inf => {
              if (inf.trim()) {
                addPersonnelRow('editInfirmiersContainer', 'editInfirmier', 'infList', 'Infirmier', 'editNbrInfirmier');
                const lastInput = document.querySelector('#editInfirmiersContainer .personnel-row:last-child input');
                lastInput.value = inf.trim();
              }
            });
            const techs = mission.techRadio ? mission.techRadio.split(',') : [];
            document.getElementById('editTechContainer').innerHTML = '';
            techs.forEach(tech => {
              if (tech.trim()) {
                addPersonnelRow('editTechContainer', 'editTechRadio', 'techList', 'Tech-Radio', 'editNbrTechRadio');
                const lastInput = document.querySelector('#editTechContainer .personnel-row:last-child input');
                lastInput.value = tech.trim();
              }
            });
            const materiels = mission.materiels ? mission.materiels.split(',') : [];
            document.querySelectorAll('#editMaterielContainer input[type="checkbox"]').forEach(checkbox => {
              checkbox.checked = materiels.includes(checkbox.value.trim());
            });
            updateEditCalcule();
            document.getElementById('editForm').style.display = 'block';
          } else {
            showAlert('Mission non trouvée.', 'error', 'editError');
            document.getElementById('editForm').style.display = 'none';
          }
        }).withFailureHandler(onFailure).getMissionDetails(codeOpe);
      }
    }
    function updateEditDateFin() {
      const dateDepart = document.getElementById('editDateOperation').value;
      const nbrJours = parseInt(document.getElementById('editNbrJours').value) || 0;
      if (dateDepart && nbrJours > 0) {
        const startDate = new Date(dateDepart);
        startDate.setDate(startDate.getDate() + nbrJours);
        document.getElementById('editDateFin').value = startDate.toISOString().split('T')[0];
      }
    }
    function updateEditNbrJours() {
      const dateDepart = document.getElementById('editDateOperation').value;
      const dateFin = document.getElementById('editDateFin').value;
      if (dateDepart && dateFin) {
        const start = new Date(dateDepart);
        const end = new Date(dateFin);
        const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        document.getElementById('editNbrJours').value = diff > 0 ? diff : 0;
      }
    }
    function updateEditCalcule() {
      const distanceMed = parseFloat(document.getElementById('editDistanceMedecin').value.replace(',', '.') || 0);
      const distanceInf = parseFloat(document.getElementById('editDistanceInfirmier').value.replace(',', '.') || 0);
      const distanceTech = parseFloat(document.getElementById('editDistanceTechRadio').value.replace(',', '.') || 0);
      const distanceMat = parseFloat(document.getElementById('editDistanceMateriel').value.replace(',', '.') || 0);
      const chargeSupp = parseFloat(document.getElementById('editChargeSupp').value) || 0;
      const dureeMed = parseInt(document.getElementById('editDureeMed').value) || 0;
      const dureeInf = parseInt(document.getElementById('editDureeInf').value) || 0;
      const dureeTech = parseInt(document.getElementById('editDureeTech').value) || 0;
      const dureeLog = parseInt(document.getElementById('editDureeLog').value) || 0;
      const nbrMed = parseInt(document.getElementById('editNbrMedecin').value) || 0;
      const nbrInf = parseInt(document.getElementById('editNbrInfirmier').value) || 0;
      const nbrTech = parseInt(document.getElementById('editNbrTechRadio').value) || 0;
      const nbrLogistique = nbrMed + nbrInf + nbrTech;
      const hebergement = document.getElementById('editHebergement').value;
      let hebergCost = 0;
      if (hebergement === 'oui') {
        hebergCost = (dureeMed * nbrMed + dureeInf * nbrInf + dureeTech * nbrTech + dureeLog * nbrLogistique) * frais;
      }
      const totalDistance = distanceMed + distanceInf + distanceTech + distanceMat;
      google.script.run.withSuccessHandler(rate => {
        const totalCharge = totalDistance * rate + hebergCost + chargeSupp;
        document.getElementById('editTotalCharge').textContent = totalCharge.toFixed(2);
        const total = editPackTotalPrix - totalCharge;
        document.getElementById('editTotalOperation').textContent = total.toFixed(2);
        const box = document.getElementById('editTotalOperationBox');
        box.classList.toggle('good', total > 0);
        box.classList.toggle('bad', total <= 0);
        const marge = editPackTotalPrix > 0 ? ((total / editPackTotalPrix) * 100).toFixed(2) + '%' : '0%';
        document.getElementById('margeNetEdit').textContent = marge;
      }).withFailureHandler(onFailure).getBaremeRate();
    }
    function toggleDuree(suffix) {
      const hebergement = document.getElementById('hebergement' + suffix).value;
      document.getElementById('dureeContainer' + suffix).style.display = hebergement === 'oui' ? 'block' : 'none';
      updateCalcule(suffix);
    }
    function loadEnterprisesByStatus() {
      const status = document.getElementById('statutCalcule').value;
      google.script.run.withSuccessHandler(enterprises => {
        populateDataList('entrepriseListCalcule', enterprises);
        document.getElementById('entrepriseCalcule').value = '';
        document.getElementById('packInputCalcule').value = '';
        document.getElementById('packListCalcule').innerHTML = '';
        clearCalculeDisplay();
        
        // Afficher un message si aucune entreprise n'a d'offres à calculer
        if (enterprises.length === 0) {
          showAlert(`Aucune entreprise avec des offres "${status}" trouvée. Créez d'abord une offre dans l'onglet Offre.`, 'error');
        }
      }).withFailureHandler(onFailure).getEnterprisesByPackStatus(status);
    }
    function loadPacksByEnterpriseAndStatus() {
      const enterprise = document.getElementById('entrepriseCalcule').value.trim();
      const status = document.getElementById('statutCalcule').value;
      if (enterprise) {
        google.script.run.withSuccessHandler(packs => {
          const packListCalcule = document.getElementById('packListCalcule');
          packListCalcule.innerHTML = '';
          packs.forEach(pack => {
            const opt = document.createElement('option');
            opt.value = `${pack.codePack} - ${pack.packName}`;
            packListCalcule.appendChild(opt);
          });
          document.getElementById('packInputCalcule').value = '';
          clearCalculeDisplay();
          
          // Afficher un message si aucune offre n'est trouvée pour cette entreprise
          if (packs.length === 0) {
            showAlert(`Aucune offre "${status}" trouvée pour l'entreprise "${enterprise}".`, 'error');
          }
        }).withFailureHandler(onFailure).getPacksByEnterpriseAndStatus(enterprise, status);
      } else {
        document.getElementById('packListCalcule').innerHTML = '';
        clearCalculeDisplay();
      }
    }
    function clearCalculeDisplay() {
      document.getElementById('nbrEmployeCalcule').value = '';
      document.getElementById('packTotalPrixCalcule').textContent = '0.00';
      const packRev = document.getElementById('packTotalRevenueEst');
      const packCost = document.getElementById('packTotalCostEst');
      const packNet = document.getElementById('packTotalNetEst');
      const packMarge = document.getElementById('packMargeEst');
      const offreRev = document.getElementById('offreTotalRevenue');
      if (packRev) packRev.textContent = '0.00';
      if (packCost) packCost.textContent = '0.00';
      if (packNet) packNet.textContent = '0.00';
      if (packMarge) packMarge.textContent = '0%';
      if (offreRev) offreRev.textContent = '0.00';
      reconciliationPackTotals = null;
      document.getElementById('actsDisplay').innerHTML = '';
      document.getElementById('siteTabsCalcule').innerHTML = '';
      document.getElementById('siteContentsCalcule').innerHTML = '';
      document.getElementById('sitesContainerCalcule').style.display = 'none';
    }
    function updateFromPackCalcule() {
      const packValue = document.getElementById('packInputCalcule').value.trim();
      const parts = packValue.split(' - ');
      const codePack = parts[0] ? parseInt(parts[0].trim()) : NaN;
      if (!isNaN(codePack) ) {
        google.script.run.withSuccessHandler(details => {
          document.getElementById('entrepriseCalcule').value = details.entreprise;
          document.getElementById('nbrEmployeCalcule').value = details.totalEmployes;
          document.getElementById('packTotalPrixCalcule').textContent = details.totalPrix.toFixed(2);
          const packRevenueEst = document.getElementById('packTotalRevenueEst');
          const packCostEst = document.getElementById('packTotalCostEst');
          const packNetEst = document.getElementById('packTotalNetEst');
          const packMargeEst = document.getElementById('packMargeEst');
          const revenuePackVal = details.totalRevenuePack || details.totalPrix || 0;
          const costPackVal = details.totalCostPack || 0;
          const netPackVal = details.totalNetPack || (revenuePackVal - costPackVal);
          reconciliationPackTotals = {
            revenue: revenuePackVal,
            remun: Number(details.totalRemunPack || 0),
            transport: Number(details.totalTransportPack || 0),
            paramYalidine: Number(details.totalParamPack || details.totalParamYalidinePack || 0) + Number(details.totalYalidinePack || 0),
          };
          reconciliationPackTotals.net = reconciliationPackTotals.revenue - reconciliationPackTotals.remun - reconciliationPackTotals.transport - reconciliationPackTotals.paramYalidine;
          if (packRevenueEst) packRevenueEst.textContent = revenuePackVal.toFixed(2);
          if (packCostEst) packCostEst.textContent = costPackVal.toFixed(2);
          if (packNetEst) packNetEst.textContent = netPackVal.toFixed(2);
          if (packMargeEst) {
            const margePack = revenuePackVal > 0 ? ((netPackVal / revenuePackVal) * 100).toFixed(2) + '%' : '0%';
            packMargeEst.textContent = margePack;
          }
          let siteActs = {};
          details.acts.forEach(act => {
            let site = act.site || 'Site 1';
            if (!siteActs[site]) siteActs[site] = [];
            siteActs[site].push(act);
          });
          let sites = Object.keys(siteActs);
          document.getElementById('sitesContainerCalcule').style.display = 'block';
          let siteTabsCalcule = document.getElementById('siteTabsCalcule');
          let siteContentsCalcule = document.getElementById('siteContentsCalcule');
          siteTabsCalcule.innerHTML = '';
          siteContentsCalcule.innerHTML = '';
          sites.forEach((site, index) => {
            let siteId = index + 1;
            const tabBtn = document.createElement('button');
            tabBtn.className = 'sub-tab-btn';
            tabBtn.dataset.siteId = siteId;
            tabBtn.textContent = site;
            tabBtn.onclick = function() { showSiteTabCalcule(siteId); };
            siteTabsCalcule.appendChild(tabBtn);
            const contentDiv = document.createElement('div');
            contentDiv.className = 'sub-tab-content';
            contentDiv.id = `siteContentCalcule-${siteId}`;
            let html = '<h3>Actes:</h3>';
            let subtotal = 0;
            let totalEmployesSite = 0;
            let nbrMedRequired = 0;
            let nbrInfRequired = 0;
            let nbrTechRequired = 0;
            let totalCout = 0;
            siteActs[site].forEach(act => {
              html += `<p>Acte: ${act.acte}, Nbr Employé: ${act.nbrEmploye}, Prix U: ${act.prixU}, Prix: ${act.prix}</p>`;
              subtotal += act.prix;
              totalEmployesSite += act.nbrEmploye;
              nbrMedRequired += act.nbrMed || 0;
              nbrInfRequired += act.nbrInf || 0;
              nbrTechRequired += act.nbrTech || 0;
              const actData = allActes.find(a => a.parametre === act.acte);
              if (actData) {
                totalCout += (parseFloat(actData.majoration) || 0) * act.nbrEmploye;
              }
            });
            contentDiv.dataset.coutParam = totalCout.toFixed(2);
            html += `<p>Total Revenue: <span id="revenueCalcule${siteId}">${subtotal.toFixed(2)}</span></p>`;
            html += `
              <div class="form-row">
                <div class="form-group">
                  <label>Nbr Employée:</label>
                  <input id="nbrEmployeCalculeSite${siteId}" type="number" readonly value="${totalEmployesSite}">
                </div>
                <div class="form-group">
                  <label>Lieu Entreprise:</label>
                  <input id="lieuEntrepriseCalcule${siteId}" type="text" value="${siteActs[site][0].lieu || ''}" readonly>
                </div>
              </div>
              <div class="card">
                <h2>Rémunérations</h2>
                <div class="remun-section remun-section-medecin">
                  <h3>Médecins</h3>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Nbr Jours Médecin:</label>
                      <input id="nbr-jour-medecin-calcule${siteId}" type="number" readonly>
                    </div>
                  </div>
                  <p class="required-observation">Nombre médecin demandé est : ${nbrMedRequired}</p>
                  <button class="btn-primary add-btn" onclick="addRemunRowCalcule(this.closest('.remun-section'), 'medecin', 5000, 'medList', ${siteId}, ${nbrMedRequired})"><span class="material-icons">add</span> Ajouter Médecin</button>
                  <div class="taux-container"></div>
                  <div class="form-group">
                    <label>Rémunération Médecins (DA):</label>
                    <span id="remun-medecin-calcule${siteId}">0.00</span>
                  </div>
                </div>
                <div class="remun-section remun-section-infirmier">
                  <h3>Infirmiers</h3>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Nbr Jours Infirmier:</label>
                      <input id="nbr-jour-infirmier-calcule${siteId}" type="number" readonly>
                    </div>
                  </div>
                  <p class="required-observation">Nombre infirmier demandé est : ${nbrInfRequired}</p>
                  <button class="btn-primary add-btn" onclick="addRemunRowCalcule(this.closest('.remun-section'), 'infirmier', 4000, 'infList', ${siteId}, ${nbrInfRequired})"><span class="material-icons">add</span> Ajouter Infirmier</button>
                  <div class="taux-container"></div>
                  <div class="form-group">
                    <label>Rémunération Infirmiers (DA):</label>
                    <span id="remun-infirmier-calcule${siteId}">0.00</span>
                  </div>
                </div>
                <div class="remun-section remun-section-tech-radio tech-remun-fields" style="display: ${nbrTechRequired > 0 ? 'block' : 'none'};">
                  <h3>Tech-Radio</h3>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Nbr Jours Tech-Radio:</label>
                      <input id="nbr-jour-tech-radio-calcule${siteId}" type="number" readonly>
                    </div>
                  </div>
                  <p class="required-observation">Nombre tech-radio demandé est : ${nbrTechRequired}</p>
                  <button class="btn-primary add-btn" onclick="addRemunRowCalcule(this.closest('.remun-section'), 'tech-radio', 4000, 'techList', ${siteId}, ${nbrTechRequired})"><span class="material-icons">add</span> Ajouter Tech-Radio</button>
                  <div class="taux-container"></div>
                  <div class="form-group">
                    <label>Rémunération Tech-Radio (DA):</label>
                    <span id="remun-tech-radio-calcule${siteId}">0.00</span>
                  </div>
                </div>
                 <p class="observation-row"><span>Total Rémunération Site: <span id="total-remun-site-calcule${siteId}">0.00</span></span></p>
                 <div class="synthese-paiements" id="synthese-paiements-site-${siteId}">
                   <div class="synthese-item">Déplacement sur place: <strong>0.00</strong> DA</div>
                   <div class="synthese-item">Hébergement sur place: <strong>0.00</strong> DA</div>
                   <div class="synthese-item total">À payer FIN OPÉRATION: <strong>0.00</strong> DA</div>
                 </div>
               </div>
               <div class="card">
                 <h2>Yalidine</h2>
                 <div class="form-row">
                   <div class="form-group">
                     <label>Nbr Jour Yalidine:</label>
                     <div class="input-wrapper">
                       <input id="nbr-jour-yalidine-calcule${siteId}" type="number" value="0" oninput="calcYalidineCalcule(${siteId})">
                       <span class="material-icons validation-icon"></span>
                     </div>
                   </div>
                   <div class="form-group">
                     <label>Tarif Yalidine:</label>
                     <div class="input-wrapper">
                       <input id="tarif-yalidine-calcule${siteId}" type="number" value="950" oninput="calcYalidineCalcule(${siteId})">
                       <span class="material-icons validation-icon"></span>
                     </div>
                   </div>
                   <div class="form-group">
                     <label>Total Yalidine: <span id="total-yalidine-calcule${siteId}">0.00</span></label>
                   </div>
                 </div>
               </div>
               <div class="card">
                 <h2>Charge Logistique</h2>
                 <div class="form-row">
                   <div class="form-group">
                     <label>Distance Médecin (km):</label>
                     <div class="input-wrapper">
                       <input id="distance-medecin-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                       <span class="material-icons validation-icon"></span>
                     </div>
                   </div>
                   <div class="form-group">
                     <label>Distance Infirmier (km):</label>
                     <div class="input-wrapper">
                       <input id="distance-infirmier-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                       <span class="material-icons validation-icon"></span>
                     </div>
                   </div>
                   <div class="form-group">
                     <label>Distance Tech-Radio (km):</label>
                     <div class="input-wrapper">
                       <input id="distance-tech-radio-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                       <span class="material-icons validation-icon"></span>
                     </div>
                   </div>
                 </div>
                 <div class="form-row">
                   <div class="form-group">
                     <label>Tarif/km:</label>
                     <div class="input-wrapper">
                       <input id="tarif-km-calcule${siteId}" type="number" value="15" oninput="calcChargeLogistiqueCalcule(${siteId})">
                       <span class="material-icons validation-icon"></span>
                     </div>
                   </div>
                   <div class="form-group">
                     <label>Hébergement:</label>
                     <div class="input-wrapper">
                       <select id="hebergement-calcule${siteId}" onchange="calcChargeLogistiqueCalcule(${siteId})">
                         <option value="non">Non</option>
                         <option value="oui">Oui</option>
                       </select>
                       <span class="material-icons validation-icon"></span>
                     </div>
                   </div>
                 </div>
                 <div id="hebergement-container-calcule${siteId}" style="display:none;">
                   <div class="form-row">
                     <div class="form-group">
                       <label>Durée Médecin (nuits):</label>
                       <input id="duree-med-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                     </div>
                     <div class="form-group">
                       <label>Frais Hébergement Médecin:</label>
                       <input id="frais-med-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                     </div>
                   </div>
                   <div class="form-row">
                     <div class="form-group">
                       <label>Durée Infirmier (nuits):</label>
                       <input id="duree-inf-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                     </div>
                     <div class="form-group">
                       <label>Frais Hébergement Infirmier:</label>
                       <input id="frais-inf-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                     </div>
                   </div>
                   <div class="form-row">
                     <div class="form-group">
                       <label>Durée Tech-Radio (nuits):</label>
                       <input id="duree-tech-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                     </div>
                     <div class="form-group">
                       <label>Frais Hébergement Tech-Radio:</label>
                       <input id="frais-tech-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                     </div>
                   </div>
                 </div>
                 <div class="form-row">
                   <div class="form-group">
                     <label>Charge Supplémentaire:</label>
                     <div class="input-wrapper">
                       <input id="charge-supp-calcule${siteId}" type="number" value="0" oninput="calcChargeLogistiqueCalcule(${siteId})">
                       <span class="material-icons validation-icon"></span>
                     </div>
                   </div>
                 </div>
                 <p class="observation-row"><span>Total Charge Logistique: <span id="total-charge-logistique-calcule${siteId}">0.00</span></span></p>
               </div>
              <div class="observation-row"><span>Total Revenue : <span id="total-revenue-site-calcule${siteId}">${subtotal.toFixed(2)}</span></span><span>Total Cost (estimé): <span id="total-cost-site-calcule${siteId}">0.00</span></span></div>
              <div class="observation-row"><span>Total Net (réelle): <span id="totalOperationCalcule${siteId}">0.00</span></span><span>Marge Net: <span id="margeNetCalcule${siteId}">0%</span></span></div>
              <div class="observation-row"><span>Paramètres: <span id="recap-param-site-${siteId}">${totalCout.toFixed(2)}</span></span><span>Rémunérations (réelle): <span id="recap-remun-site-${siteId}">0.00</span></span></div>
              <div class="observation-row"><span>Charges (transport+hébergement+supp) (réelle): <span id="recap-charge-site-${siteId}">0.00</span></span></div>
            `;
            contentDiv.dataset.coutParam = totalCout.toFixed(2);
            contentDiv.innerHTML = html;
            siteContentsCalcule.appendChild(contentDiv);
            recalcAllNbrJourCalcule();
            calcGlobalCalcule();
          });
          showSiteTabCalcule(1);
          calcGlobalCalcule();
          const autoNotice = document.getElementById('autoSaveNotice');
          if (autoNotice) autoNotice.style.display = 'block';
          scheduleAutoSaveCalcule();
        }).withFailureHandler(onFailure).getPackDetails(codePack);
      } else {
        document.getElementById('packTotalPrixCalcule').textContent = '0.00';
        calcGlobalCalcule();
      }
    }
    function showSiteTabCalcule(siteId) {
      document.querySelectorAll('#siteTabsCalcule .sub-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('#siteContentsCalcule .sub-tab-content').forEach(content => content.classList.remove('active'));
      const btn = document.querySelector(`#siteTabsCalcule [data-site-id="${siteId}"]`);
      if (btn) btn.classList.add('active');
      const content = document.getElementById(`siteContentCalcule-${siteId}`);
      if (content) content.classList.add('active');
    }
    function switchSiteCalcule(delta) {
      const activeBtn = document.querySelector('#siteTabsCalcule .sub-tab-btn.active');
      if (!activeBtn) return;
      let currentId = parseInt(activeBtn.dataset.siteId);
      let newId = currentId + delta;
      if (newId < 1 || newId > document.querySelectorAll('#siteTabsCalcule .sub-tab-btn').length) return;
      showSiteTabCalcule(newId);
    }
    function addRemunRowCalcule(section, type, defaultTaux, listId, siteId, nbrPersRequired) {
      const container = section.querySelector('.taux-container');
      const count = container.children.length;
      const isExtra = count >= nbrPersRequired;
      const defaultNbrJour = parseInt(document.getElementById(`nbr-jour-${type === 'logistique' ? 'logistique' : type}-calcule${siteId}`)?.value) || 0;
      const tarifKlmEl = document.getElementById(`tarif-klm-site-calcule${siteId}`);
      const tarifKlm = tarifKlmEl ? parseFloat(tarifKlmEl.value) : 15;
      const rowId = `personnel-row-${type}-${siteId}-${count}`;
      
      const row = document.createElement('div');
      row.className = 'personnel-row-accordion';
      row.id = rowId;
      row.innerHTML = `
        <!-- En-tête Accordion (Compact) -->
        <div class="accordion-header" onclick="toggleAccordion('${rowId}')">
          <span class="accordion-toggle">▶</span>
          <div style="flex: 1; display: flex; gap: 10px; align-items: center;">
            <input class="name-input" list="${listId}" placeholder="Nom..." onblur="validateInput(this, v => v.trim().length > 0); loadWilayaForPersonnel(this, '${type}'); calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})" onclick="event.stopPropagation();" style="flex: 1; min-width: 150px;">
            <span class="material-icons validation-icon" style="font-size: 22px; color: #999;"></span>
            <input class="wilaya-input" list="wilayaList" placeholder="Wilaya..." style="flex: 0.8; background-color: #e8f4f8; color: #333; border: 2px solid #0066cc; font-weight: 500; padding: 8px;">
          </div>
          <span class="accordion-distance">-</span> km
          <span class="accordion-depl">-</span> DA
          <span class="accordion-final">-</span> DA
          <button class="btn-danger btn-mini" onclick="removeRemunRowCalcule(this, '${type}', ${siteId}); event.stopPropagation()"><span class="material-icons">delete</span></button>
        </div>

        <!-- Contenu Accordion (Détails Masqués) -->
        <div class="accordion-content" style="display:none;">
          <!-- Section Infos Générales -->
          <div class="accordion-section">
            <h4>📋 Informations Générales</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Taux/Jour (DA):</label>
                <input class="taux-input" type="number" value="${defaultTaux}" oninput="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})" onblur="validateInput(this, v => parseFloat(v) >= 0)">
              </div>
              ${isExtra ? `
              <div class="form-group">
                <label>Nbr Jours:</label>
                <input class="nbr-jours-input" type="number" value="${defaultNbrJour}" oninput="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})" onblur="validateInput(this, v => parseInt(v) >= 0)">
              </div>
              ` : `<div class="form-group">
                <label>Nbr Jours:</label>
                <input class="nbr-jours-input" type="number" value="${defaultNbrJour}" readonly>
              </div>`}
            </div>
          </div>

          <!-- Section Déplacement -->
          <div class="accordion-section">
            <h4>📍 Déplacement</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Distance (km):</label>
                <input class="distance-input" type="text" placeholder="ex: 50" oninput="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})" onblur="validateInput(this, v => parseFloat(v.replace(',', '.')) >= 0)">
              </div>
              <div class="form-group">
                <label>Aller-Retour:</label>
                <div class="radio-group">
                  <input type="radio" class="ar-chaque-jour" name="ar-${type}-${siteId}-${count}" value="chaque" onchange="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})">
                  <label>Chaque jour</label>
                  <input type="radio" class="ar-une-fois" name="ar-${type}-${siteId}-${count}" value="une-fois" onchange="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})">
                  <label>1 fois</label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>
                  <input type="checkbox" class="use-avion-checkbox" onchange="toggleAvionPrice(this); calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})">
                  Utiliser avion (>400km) ?
                </label>
              </div>
              <div class="form-group" style="display:none;">
                <label>Tarif Avion (DA):</label>
                <input class="avion-price-input" type="number" value="13500" placeholder="13500" oninput="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})">
              </div>
            </div>

            <div class="form-row summary-row">
              <span class="label-inline">Coût Déplacement:</span>
              <span class="depl-cost">0.00</span> DA
              <label style="margin-left:20px;">
                <input type="checkbox" class="depl-paid-onsite" onchange="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})">
                Payé sur place
              </label>
            </div>
          </div>

          <!-- Section Hébergement -->
          <div class="accordion-section">
            <h4>🏨 Hébergement</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Durée (nuits):</label>
                <input class="hebergement-duree-input" type="number" value="0" min="0" oninput="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})" onblur="validateInput(this, v => parseInt(v) >= 0)">
              </div>
              <div class="form-group">
                <label>Tarif/Nuit (DA):</label>
                <input class="hebergement-tarif-input" type="number" value="4000" oninput="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})" onblur="validateInput(this, v => parseFloat(v) >= 0)">
              </div>
            </div>

            <div class="form-row summary-row">
              <span class="label-inline">Coût Hébergement:</span>
              <span class="heberg-cost">0.00</span> DA
              <label style="margin-left:20px;">
                <input type="checkbox" class="heberg-paid-onsite" onchange="calcRemunSiteCalcule(this.closest('.remun-section'), '${type}', ${siteId})">
                Payé sur place
              </label>
            </div>
          </div>

          <!-- Section Résumé -->
          <div class="accordion-section summary-section">
            <h4>💰 Résumé Financier</h4>
            <div class="summary-grid">
              <div class="summary-item">
                <label>Taux/Jour:</label>
                <span class="remun-cost">0.00</span> DA
              </div>
              <div class="summary-item">
                <label>Déplacement:</label>
                <span class="depl-cost-summary">0.00</span> DA
              </div>
              <div class="summary-item">
                <label>Hébergement:</label>
                <span class="heberg-cost-summary">0.00</span> DA
              </div>
              <div class="summary-item highlight">
                <label>À payer FIN:</label>
                <span class="final-amount">0.00</span> DA
              </div>
            </div>
          </div>

          <!-- Section Observation -->
          <div class="accordion-section">
            <label>📝 Observation:</label>
            <textarea class="observation" placeholder="Notes..."></textarea>
          </div>
        </div>
      `;
      container.appendChild(row);
      calcRemunSiteCalcule(row.closest('.remun-section'), type, siteId);
    }

    function toggleAccordion(rowId) {
      const row = document.getElementById(rowId);
      const content = row.querySelector('.accordion-content');
      const toggle = row.querySelector('.accordion-toggle');
      const isOpen = content.style.display === 'block';
      content.style.display = isOpen ? 'none' : 'block';
      toggle.textContent = isOpen ? '▶' : '▼';
    }

    function toggleAvionPrice(checkbox) {
      // Chercher le form-group du tarif avion (plus robuste)
      const parentRow = checkbox.closest('.form-row');
      if (parentRow) {
        const priceGroup = parentRow.querySelector('.form-group:has(.avion-price-input)') || 
                          parentRow.querySelectorAll('.form-group')[1]; // 2ème form-group si pas trouvé
        if (priceGroup) {
          priceGroup.style.display = checkbox.checked ? 'block' : 'none';
        }
      }
    }
    function removeRemunRowCalcule(button, type, siteId) {
      button.parentElement.remove();
      const section = button.closest('.remun-section');
      calcRemunSiteCalcule(section, type, siteId);
    }
    function calcRemunSiteCalcule(section, type, siteId) {
      let totalRemunType = 0;
      let totalDeplType = 0;
      let totalHebergType = 0;
      let totalDeplPaidType = 0;
      let totalHebergPaidType = 0;
      const rows = section.querySelectorAll('.personnel-row-accordion, .personnel-row');
      const defaultNbrJour = parseInt(document.getElementById(`nbr-jour-${type}-calcule${siteId}`)?.value) || 0;
      // Panel charge supprimé - tarif KLM par défaut 15
      const tarifKlmEl = document.getElementById(`tarif-klm-site-calcule${siteId}`);
      const tarifKlm = tarifKlmEl ? parseFloat(tarifKlmEl.value) : 15;

      rows.forEach(row => {
        // === RÉMUNÉRATION ===
        const taux = parseFloat(row.querySelector('.taux-input').value) || 0;
        const nbrJourInput = row.querySelector('.nbr-jours-input');
        const nbrJour = nbrJourInput ? parseInt(nbrJourInput.value) || 0 : defaultNbrJour;
        const remunPers = nbrJour * taux;
        totalRemunType += remunPers;

        // === DÉPLACEMENT ===
        const distance = parseFloat(row.querySelector('.distance-input')?.value.replace(',', '.') || 0) || 0;
        const arChaqueJour = row.querySelector('.ar-chaque-jour')?.checked || false;
        const arUneFois = row.querySelector('.ar-une-fois')?.checked || false;
        const useAvion = row.querySelector('.use-avion-checkbox')?.checked || false;
        
        let deplCost = 0;
        if (distance > 0) {
          // ✅ SI avion cochée → utiliser tarif avion (peu importe distance)
          if (useAvion) {
            const avionPrice = parseFloat(row.querySelector('.avion-price-input').value) || 13500;
            deplCost = avionPrice;
          } else {
            // Sinon calculer à partir de distance
            let baseCost = distance * tarifKlm;
            let multiplier = 2; // aller-retour de base
            if (arChaqueJour) {
              multiplier = 2 * nbrJour;
            } else if (arUneFois) {
              multiplier = 2;
            }
            deplCost = baseCost * multiplier;
          }
        }
        totalDeplType += deplCost;

        // === HÉBERGEMENT ===
        const hDuree = parseInt(row.querySelector('.hebergement-duree-input').value) || 0;
        const hTarif = parseFloat(row.querySelector('.hebergement-tarif-input').value) || 4000;
        const hCost = hDuree * hTarif;
        totalHebergType += hCost;

        // === AFFICHAGE LIGNE PERSONNELLE ===
        // Mettre à jour les spans de coûts
        const deplCostSpans = row.querySelectorAll('.depl-cost');
        const hebergCostSpans = row.querySelectorAll('.heberg-cost');
        deplCostSpans.forEach(span => span.textContent = deplCost.toFixed(2));
        hebergCostSpans.forEach(span => span.textContent = hCost.toFixed(2));
        
        const remnCostSpans = row.querySelectorAll('.remun-cost');
        remnCostSpans.forEach(span => span.textContent = remunPers.toFixed(2));
        
        const totalBrutSpans = row.querySelectorAll('.total-brut');
        totalBrutSpans.forEach(span => span.textContent = (remunPers + deplCost + hCost).toFixed(2));
        
        // Calcul montant final selon paiements sur place
        const deplPaidOnsite = row.querySelector('.depl-paid-onsite').checked;
        const hebergPaidOnsite = row.querySelector('.heberg-paid-onsite').checked;
        let finalAmount = remunPers; // Rémunération toujours à payer
        if (!deplPaidOnsite) finalAmount += deplCost;
        if (!hebergPaidOnsite) finalAmount += hCost;

        totalDeplPaidType += deplPaidOnsite ? deplCost : 0;
        totalHebergPaidType += hebergPaidOnsite ? hCost : 0;
        
        const finalSpans = row.querySelectorAll('.final-amount');
        finalSpans.forEach(span => span.textContent = finalAmount.toFixed(2));
        
        // === METTRE À JOUR EN-TÊTE ACCORDION ===
        const header = row.querySelector('.accordion-header');
        if (header) {
          header.querySelector('.accordion-distance').textContent = distance.toFixed(0);
          header.querySelector('.accordion-depl').textContent = deplCost.toFixed(0);
          header.querySelector('.accordion-final').textContent = finalAmount.toFixed(0);
        }
      });

      const remunElement = document.getElementById(`remun-${type}-calcule${siteId}`);
      if (remunElement) {
        remunElement.textContent = totalRemunType.toFixed(2);
      }

      // Mise à jour du résumé financier de la section (déplacement/hébergement/fin)
      const sectionSummary = section.querySelector('.summary-section');
      if (sectionSummary) {
        const deplSummary = sectionSummary.querySelector('.depl-cost-summary');
        const hebergSummary = sectionSummary.querySelector('.heberg-cost-summary');
        const remunSummary = sectionSummary.querySelector('.remun-cost');
        const finalSummary = sectionSummary.querySelector('.final-amount');
        if (remunSummary) remunSummary.textContent = totalRemunType.toFixed(2);
        if (deplSummary) deplSummary.textContent = totalDeplType.toFixed(2);
        if (hebergSummary) hebergSummary.textContent = totalHebergType.toFixed(2);
        if (finalSummary) {
          const finalType = totalRemunType + (totalDeplType - totalDeplPaidType) + (totalHebergType - totalHebergPaidType);
          finalSummary.textContent = finalType.toFixed(2);
        }
      }
      calcTotalRemunSiteCalcule(siteId);
    }
    function calcTotalRemunSiteCalcule(siteId) {
      let totalRemun = 0;
      let totalDeplPersonnes = 0;
      let totalHebergPersonnes = 0;
      let totalDeplPaidOnsite = 0;
      let totalHebergPaidOnsite = 0;
      
      // Calcul rémunération + déplacement + hébergement par type de personnel
      ['medecin', 'infirmier', 'tech-radio'].forEach(type => {
        const remunSpan = document.getElementById(`remun-${type}-calcule${siteId}`);
        if (remunSpan) {
          totalRemun += parseFloat(remunSpan.textContent) || 0;
        }
        
        // Calcul déplacement et hébergement individuels
        const section = document.getElementById(`siteContentCalcule-${siteId}`).querySelector(`.remun-section-${type}`);
        if (section) {
          const rows = section.querySelectorAll('.personnel-row-accordion, .personnel-row');
          rows.forEach(row => {
            const deplCost = parseFloat(row.querySelector('.depl-cost').textContent) || 0;
            const hebergCost = parseFloat(row.querySelector('.heberg-cost').textContent) || 0;
            const deplPaidOnsite = row.querySelector('.depl-paid-onsite').checked;
            const hebergPaidOnsite = row.querySelector('.heberg-paid-onsite').checked;
            
            totalDeplPersonnes += deplCost;
            totalHebergPersonnes += hebergCost;
            
            if (deplPaidOnsite) totalDeplPaidOnsite += deplCost;
            if (hebergPaidOnsite) totalHebergPaidOnsite += hebergCost;
          });
        }
      });
      
      // Charges additionnelles (logistique, supp) - Panel charge supprimé, donc pas de charges additionnelles
      let additionalCharges = 0;
      // Les éléments du panel charge n'existent plus, donc on ignore ces charges
      
      const totalCharge = totalDeplPersonnes + totalHebergPersonnes + additionalCharges;
      
      document.getElementById(`total-remun-site-calcule${siteId}`).textContent = totalRemun.toFixed(2);
      document.getElementById(`total-charge-site-calcule${siteId}`).textContent = totalCharge.toFixed(2);
      
      // Affichage synthèse paiements partiels
      const synthInfo = document.getElementById(`synthese-paiements-site-${siteId}`);
      if (synthInfo) {
        const deplSurPlace = totalDeplPaidOnsite.toFixed(2);
        const hebergSurPlace = totalHebergPaidOnsite.toFixed(2);
        const montantFinal = (totalRemun + totalDeplPersonnes - totalDeplPaidOnsite + totalHebergPersonnes - totalHebergPaidOnsite + additionalCharges).toFixed(2);
        synthInfo.innerHTML = `
          <div class="synthese-item">Déplacement sur place: <strong>${deplSurPlace}</strong> DA</div>
          <div class="synthese-item">Hébergement sur place: <strong>${hebergSurPlace}</strong> DA</div>
          <div class="synthese-item total">À payer FIN OPÉRATION: <strong>${montantFinal}</strong> DA</div>
        `;
      }
      
      calcSiteCalcule(siteId);
    }
    function recalcAllNbrJourCalcule() {
      const siteCountCalcule = document.querySelectorAll('#siteTabsCalcule .sub-tab-btn').length;
      for (let i = 1; i <= siteCountCalcule; i++) {
        const nbrEmploye = parseInt(document.getElementById(`nbrEmployeCalculeSite${i}`).value) || 0;
        const calculeMed = parseInt(document.getElementById('global-calcule-jour-medecin-calcule').value) || 20;
        const nbrJourMed = Math.ceil(nbrEmploye / calculeMed) + 1; // Add +1 day as requested
        document.getElementById(`nbr-jour-medecin-calcule${i}`).value = nbrJourMed;
        const calculeInf = parseInt(document.getElementById('global-calcule-jour-infirmier-calcule').value) || 30;
        const nbrJourInf = Math.ceil(nbrEmploye / calculeInf) + 1; // Add +1 day as requested
        document.getElementById(`nbr-jour-infirmier-calcule${i}`).value = nbrJourInf;
        const calculeTech = parseInt(document.getElementById('global-calcule-jour-tech-radio-calcule').value) || 30;
        const nbrJourTech = Math.ceil(nbrEmploye / calculeTech) + 1; // Add +1 day as requested
        document.getElementById(`nbr-jour-tech-radio-calcule${i}`).value = nbrJourTech;
        // Panel charge supprimé - ignorer hébergement et durée
        ['medecin', 'infirmier', 'tech-radio'].forEach(type => {
          const section = document.getElementById(`siteContentCalcule-${i}`).querySelector(`.remun-section-${type}`);
          if (section) calcRemunSiteCalcule(section, type, i);
        });
      }
      calcGlobalCalcule();
    }
    function toggleDureeCalcule(siteId) {
      // Panel charge supprimé - cette fonction n'est plus utile
      // Garder la structure pour compatibilité mais ne rien faire
      return;
    }
    function calcSiteCalcule(siteId) {
      // Calcul du coût total du site et résultats nets
      const revenue = parseFloat(document.getElementById(`revenueCalcule${siteId}`).textContent) || 0;
      const contentEl = document.getElementById(`siteContentCalcule-${siteId}`);
      const coutParam = parseFloat(contentEl?.dataset.coutParam) || 0;
      const totalRemun = parseFloat(document.getElementById(`total-remun-site-calcule${siteId}`).textContent) || 0;
      const totalCharge = parseFloat(document.getElementById(`total-charge-site-calcule${siteId}`).textContent) || 0;
      
      // Coût total = paramètres + rémunérations + charges
      const totalCost = totalRemun + totalCharge + coutParam;
      const totalNet = revenue - totalCost;
      
      // Mise à jour affichage
      const recapParam = document.getElementById(`recap-param-site-${siteId}`);
      const recapRemun = document.getElementById(`recap-remun-site-${siteId}`);
      const recapCharge = document.getElementById(`recap-charge-site-${siteId}`);
      if (recapParam) recapParam.textContent = coutParam.toFixed(2);
      if (recapRemun) recapRemun.textContent = totalRemun.toFixed(2);
      if (recapCharge) recapCharge.textContent = totalCharge.toFixed(2);
      document.getElementById(`total-cost-site-calcule${siteId}`).textContent = totalCost.toFixed(2);
      document.getElementById(`totalOperationCalcule${siteId}`).textContent = totalNet.toFixed(2);
      const marge = revenue > 0 ? ((totalNet / revenue) * 100).toFixed(2) + '%' : '0%';
      document.getElementById(`margeNetCalcule${siteId}`).textContent = marge;
      calcGlobalCalcule();
    }
    
    // Function to calculate Yalidine in R-H tab
    function calcYalidineCalcule(siteId) {
      const nbrJour = parseFloat(document.getElementById(`nbr-jour-yalidine-calcule${siteId}`).value) || 0;
      const tarif = parseFloat(document.getElementById(`tarif-yalidine-calcule${siteId}`).value) || 0;
      const total = nbrJour * tarif;
      document.getElementById(`total-yalidine-calcule${siteId}`).textContent = total.toFixed(2);
      recalcSiteCalcule(siteId);
    }
    
    // Function to calculate Charge Logistique in R-H tab
    function calcChargeLogistiqueCalcule(siteId) {
      const distMed = parseFloat(document.getElementById(`distance-medecin-calcule${siteId}`).value) || 0;
      const distInf = parseFloat(document.getElementById(`distance-infirmier-calcule${siteId}`).value) || 0;
      const distTech = parseFloat(document.getElementById(`distance-tech-radio-calcule${siteId}`).value) || 0;
      const tarifKm = parseFloat(document.getElementById(`tarif-km-calcule${siteId}`).value) || 0;
      
      let totalCharge = (distMed + distInf + distTech) * tarifKm;
      
      const hebergement = document.getElementById(`hebergement-calcule${siteId}`).value;
      const hebergementContainer = document.getElementById(`hebergement-container-calcule${siteId}`);
      
      if (hebergement === 'oui') {
        hebergementContainer.style.display = 'block';
        const dureeMed = parseFloat(document.getElementById(`duree-med-calcule${siteId}`).value) || 0;
        const fraisMed = parseFloat(document.getElementById(`frais-med-calcule${siteId}`).value) || 0;
        const dureeInf = parseFloat(document.getElementById(`duree-inf-calcule${siteId}`).value) || 0;
        const fraisInf = parseFloat(document.getElementById(`frais-inf-calcule${siteId}`).value) || 0;
        const dureeTech = parseFloat(document.getElementById(`duree-tech-calcule${siteId}`).value) || 0;
        const fraisTech = parseFloat(document.getElementById(`frais-tech-calcule${siteId}`).value) || 0;
        
        totalCharge += (dureeMed * fraisMed) + (dureeInf * fraisInf) + (dureeTech * fraisTech);
      } else {
        hebergementContainer.style.display = 'none';
      }
      
      const chargeSupp = parseFloat(document.getElementById(`charge-supp-calcule${siteId}`).value) || 0;
      totalCharge += chargeSupp;
      
      document.getElementById(`total-charge-logistique-calcule${siteId}`).textContent = totalCharge.toFixed(2);
      recalcSiteCalcule(siteId);
    }
    
    // Update recalcSiteCalcule to include Yalidine and Charge Logistique
    function recalcSiteCalcule(siteId) {
      const revenue = parseFloat(document.getElementById(`revenueCalcule${siteId}`).textContent) || 0;
      const remun = parseFloat(document.getElementById(`total-remun-site-calcule${siteId}`).textContent) || 0;
      const yalidine = parseFloat(document.getElementById(`total-yalidine-calcule${siteId}`).textContent) || 0;
      const chargeLog = parseFloat(document.getElementById(`total-charge-logistique-calcule${siteId}`).textContent) || 0;
      const coutParam = parseFloat(document.getElementById(`recap-param-site-${siteId}`).textContent) || 0;
      
      const totalCost = remun + yalidine + chargeLog + coutParam;
      const totalNet = revenue - totalCost;
      
      document.getElementById(`recap-remun-site-${siteId}`).textContent = remun.toFixed(2);
      document.getElementById(`recap-charge-site-${siteId}`).textContent = (yalidine + chargeLog).toFixed(2);
      document.getElementById(`total-cost-site-calcule${siteId}`).textContent = totalCost.toFixed(2);
      document.getElementById(`totalOperationCalcule${siteId}`).textContent = totalNet.toFixed(2);
      const marge = revenue > 0 ? ((totalNet / revenue) * 100).toFixed(2) + '%' : '0%';
      document.getElementById(`margeNetCalcule${siteId}`).textContent = marge;
      calcGlobalCalcule();
    }
    
    const AUTO_SAVE_DELAY_MS = 800;
    let autoSaveTimer = null;
    let autoSaveErrorShown = false;
    function scheduleAutoSaveCalcule() {
      if (autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => saveCalculeToStorage(true), AUTO_SAVE_DELAY_MS);
    }
    function calcGlobalCalcule() {
      let totalRevenue = 0;
      let totalCost = 0;
      let totalNet = 0;
      const siteCountCalcule = document.querySelectorAll('#siteTabsCalcule .sub-tab-btn').length;
      for (let i = 1; i <= siteCountCalcule; i++) {
        totalRevenue += parseFloat(document.getElementById(`revenueCalcule${i}`).textContent) || 0;
        totalCost += parseFloat(document.getElementById(`total-cost-site-calcule${i}`).textContent) || 0;
        totalNet += parseFloat(document.getElementById(`totalOperationCalcule${i}`).textContent) || 0;
      }
      document.getElementById('packTotalPrixCalcule').textContent = totalRevenue.toFixed(2);
      const offreRevenueSpan = document.getElementById('offreTotalRevenue');
      if (offreRevenueSpan) offreRevenueSpan.textContent = totalRevenue.toFixed(2);
      document.getElementById('totalChargeCalcule').textContent = totalCost.toFixed(2);
      document.getElementById('totalOperationCalcule').textContent = totalNet.toFixed(2);
      const marge = totalRevenue > 0 ? ((totalNet / totalRevenue) * 100).toFixed(2) + '%' : '0%';
      document.getElementById('margeNetCalcule').textContent = marge;
      if (typeof renderReconciliationView === 'function') renderReconciliationView();
      if (siteCountCalcule > 0 && document.getElementById('packInputCalcule')?.value.trim()) {
        scheduleAutoSaveCalcule();
      }
    }
    function saveCalculeToStorage(autoSave = false) {
      console.log('saveCalculeToStorage called');
      
      // Check permission first (treat undefined as true - permission granted by default)
      const hasPerm = hasPermission('ajouter');
      console.log('hasPermission result:', hasPerm);
      if (hasPerm === false) {  // Only block if explicitly false
        console.log('Permission denied for action: ajouter');
        showAlert('Action "ajouter" non autorisée pour cet utilisateur', 'error', 'calculeError');
        return;
      }
      console.log('Permission check passed (or not defined)');
      
      const packInputEl = document.getElementById('packInputCalcule');
      const packValue = packInputEl.value.trim();
      console.log('packValue:', packValue);
      const parts = packValue.split(' - ');
      let packSelect = parts[0] ? parseInt(parts[0].trim()) : NaN;
      // Fallback: try to resolve the code from the datalist even if the user typed only the name
      if (isNaN(packSelect) && packValue) {
        const options = Array.from(document.getElementById('packListCalcule').options || []);
        const opt = options.find(o => o.value.toLowerCase() === packValue.toLowerCase() || o.value.toLowerCase().endsWith(`- ${packValue.toLowerCase()}`));
        if (opt) {
          const p = opt.value.split(' - ');
          packSelect = p[0] ? parseInt(p[0].trim()) : NaN;
          packInputEl.value = opt.value; // normalize input to the canonical "code - name" format
        }
      }
      console.log('packSelect:', packSelect);
      if (isNaN(packSelect)) {
        const msg = 'Onglet Pack non chargé : rouvrez l’onglet Pack puis réessayez.';
        if (autoSave) {
          if (!autoSaveErrorShown) {
            showAlert(msg, 'error', 'calculeError');
            autoSaveErrorShown = true;
          }
        } else {
          showAlert(msg, 'error', 'calculeError');
        }
        return;
      }
      autoSaveErrorShown = false;
      const siteCountCalcule = document.querySelectorAll('#siteTabsCalcule .sub-tab-btn').length;
      let distanceMedecin = 0;
      let distanceInfirmier = 0;
      let distanceTechRadio = 0;
      let distanceMateriel = 0;
      let dureeMed = 0;
      let dureeInf = 0;
      let dureeTech = 0;
      let dureeLog = 0;
      let frais = 0;
      let chargeSupp = 0;
      let hebergement = 'non';
      let materiels = [];
      let nbrMedecin = 0;
      let medecins = [];
      let nbrInfirmier = 0;
      let infirmiers = [];
      let nbrTechRadio = 0;
      let techRadio = [];
      let medTaux = 0;
      let infTaux = 0;
      let techTaux = 0;
      for (let i = 1; i <= siteCountCalcule; i++) {
        // Utiliser les nouveaux champs de Charge Logistique
        const distMedEl = document.getElementById(`distance-medecin-calcule${i}`);
        const distInfEl = document.getElementById(`distance-infirmier-calcule${i}`);
        const distTechEl = document.getElementById(`distance-tech-radio-calcule${i}`);
        const dureeMedEl = document.getElementById(`duree-med-calcule${i}`);
        const dureeInfEl = document.getElementById(`duree-inf-calcule${i}`);
        const dureeTechEl = document.getElementById(`duree-tech-calcule${i}`);
        const fraisMedEl = document.getElementById(`frais-med-calcule${i}`);
        const fraisInfEl = document.getElementById(`frais-inf-calcule${i}`);
        const fraisTechEl = document.getElementById(`frais-tech-calcule${i}`);
        const chargeSuppEl = document.getElementById(`charge-supp-calcule${i}`);
        const hebergementEl = document.getElementById(`hebergement-calcule${i}`);
        
        distanceMedecin += distMedEl ? parseFloat(distMedEl.value || 0) : 0;
        distanceInfirmier += distInfEl ? parseFloat(distInfEl.value || 0) : 0;
        distanceTechRadio += distTechEl ? parseFloat(distTechEl.value || 0) : 0;
        dureeMed += dureeMedEl ? parseInt(dureeMedEl.value) || 0 : 0;
        dureeInf += dureeInfEl ? parseInt(dureeInfEl.value) || 0 : 0;
        dureeTech += dureeTechEl ? parseInt(dureeTechEl.value) || 0 : 0;
        dureeLog += dureeMed + dureeInf + dureeTech;
        frais += fraisMedEl ? parseFloat(fraisMedEl.value) || 0 : 0;
        frais += fraisInfEl ? parseFloat(fraisInfEl.value) || 0 : 0;
        frais += fraisTechEl ? parseFloat(fraisTechEl.value) || 0 : 0;
        chargeSupp += chargeSuppEl ? parseFloat(chargeSuppEl.value) || 0 : 0;
        if (hebergementEl && hebergementEl.value === 'oui') hebergement = 'oui';
        nbrMedecin += document.querySelectorAll(`#siteContentCalcule-${i} .remun-section-medecin .taux-container .personnel-row`).length;
        medecins.push(...Array.from(document.querySelectorAll(`#siteContentCalcule-${i} .remun-section-medecin .taux-container .personnel-row`)).map(row => row.querySelector('.name-input').value.trim()));
        nbrInfirmier += document.querySelectorAll(`#siteContentCalcule-${i} .remun-section-infirmier .taux-container .personnel-row`).length;
        infirmiers.push(...Array.from(document.querySelectorAll(`#siteContentCalcule-${i} .remun-section-infirmier .taux-container .personnel-row`)).map(row => row.querySelector('.name-input').value.trim()));
        nbrTechRadio += document.querySelectorAll(`#siteContentCalcule-${i} .remun-section-tech-radio .taux-container .personnel-row`).length;
        techRadio.push(...Array.from(document.querySelectorAll(`#siteContentCalcule-${i} .remun-section-tech-radio .taux-container .personnel-row`)).map(row => row.querySelector('.name-input').value.trim()));
        medTaux += parseFloat(document.getElementById(`remun-medecin-calcule${i}`).textContent) || 0;
        infTaux += parseFloat(document.getElementById(`remun-infirmier-calcule${i}`).textContent) || 0;
        techTaux += parseFloat(document.getElementById(`remun-tech-radio-calcule${i}`).textContent) || 0;
      }
      const statut = document.getElementById('statutCalcule') ? document.getElementById('statutCalcule').value : 'à calculer';
      const nbrJours = parseInt(document.getElementById('nbrJoursCalcule')?.value) || 0;
      const dateFin = document.getElementById('dateFinCalcule')?.value || '';
      const totalRevenue = parseFloat(document.getElementById('packTotalPrixCalcule').textContent) || 0;
      const totalCost = parseFloat(document.getElementById('totalChargeCalcule').textContent) || 0;
      const totalNet = parseFloat(document.getElementById('totalOperationCalcule').textContent) || 0;
      console.log('Financial totals - Revenue:', totalRevenue, 'Cost:', totalCost, 'Net:', totalNet);
      const data = {
        packSelect,
        entreprise: document.getElementById('entrepriseCalcule').value.trim(),
        wilayaDepartMedecin: '',
        wilayaDepartInfirmier: '',
        wilayaDepartTechRadio: '',
        distanceMedecin,
        distanceInfirmier,
        distanceTechRadio,
        materiels: materiels.join(','),
        distanceMateriel,
        nbrInfirmier,
        infirmiers: infirmiers.join(','),
        medecins: medecins.join(','),
        nbrMedecin,
        techRadio: techRadio.join(','),
        nbrTechRadio,
        hebergement,
        dureeMed,
        dureeInf,
        dureeTech,
        dureeLog,
        frais,
        chargeSupp,
        statut,
        nbrJours,
        dateFin,
        medTaux,
        infTaux,
        techTaux,
        totalRevenue,
        totalCost,
        totalNet
      };
      localStorage.setItem('calculeData', JSON.stringify(data));
      console.log('Data saved to localStorage:', data);
      
      // Construire un récapitulatif détaillé pour la feuille Data Calcule
      const packName = parts.slice(1).join(' - ').trim();
      const totalEmployes = parseInt(document.getElementById('nbrEmployeCalcule').value) || 0;
      const totalParametres = Array.from(document.querySelectorAll('[id^="recap-param-site-"]')).reduce((sum, el) => sum + (parseFloat(el.textContent) || 0), 0);
      const totalRemuneration = medTaux + infTaux + techTaux;
      const totalChargeLogistique = Array.from(document.querySelectorAll('[id^="total-charge-logistique-calcule"]')).reduce((sum, el) => sum + (parseFloat(el.textContent) || 0), 0);
      const totalYalidine = Array.from(document.querySelectorAll('[id^="total-yalidine-calcule"]')).reduce((sum, el) => sum + (parseFloat(el.textContent) || 0), 0);
      const prixVisiteLieux = parseFloat(document.getElementById('prixVisiteLieux')?.value) || 0;
      const totalCharges = totalParametres + totalRemuneration + totalChargeLogistique + totalYalidine + chargeSupp + (frais || 0) + prixVisiteLieux;
      const parametres = Array.from(document.querySelectorAll('#siteContentsCalcule p')).filter(p => p.textContent.trim().startsWith('Acte')).map(p => p.textContent.replace(/^Acte:\s*/i, '').split(',')[0].trim());
      let detailsJson = '';
      try {
        detailsJson = JSON.stringify({
          entreprise: data.entreprise,
          packName,
          packCode: data.packSelect,
          totalEmployes,
          parametres,
          totalRevenue,
          totalParametres,
          totalRemuneration,
          totalChargeLogistique,
          totalYalidine,
          prixVisiteLieux,
          chargeSupp,
          frais,
          totalCharges,
          totalNet,
          marge: totalRevenue > 0 ? ((totalNet / totalRevenue) * 100) : 0,
          medecins,
          infirmiers,
          techRadio
        });
      } catch (e) {
        console.warn('Impossible de sérialiser les détails, utilisation d\'une chaîne vide', e);
      }
      
      // Calculate margin percentage
      const marge = totalRevenue > 0 ? ((totalNet / totalRevenue) * 100) : 0;
      console.log('Margin calculated:', marge.toFixed(2) + '%');
      
      // Get validation threshold (default 70% if not set)
      const validationThreshold = parseFloat(localStorage.getItem('marginValidationThreshold') || '70');
      console.log('Validation threshold:', validationThreshold + '%');
      
      const requiresFinance = marge < validationThreshold;
      if (requiresFinance && !autoSave) {
        const confirmFinance = confirm(`Attention: La marge est de ${marge.toFixed(2)}%, inférieure au seuil de ${validationThreshold}%.\n\nCette offre nécessite une validation du service Finance avant de continuer.\n\nVoulez-vous marquer cette offre comme "en attente de validation Finance" ?`);
        if (!confirmFinance) {
          console.log('Finance validation cancelled by user');
          showAlert('Sauvegarde annulée. La validation Finance est obligatoire pour cette marge.', 'error', 'calculeError');
          return;
        }
      }
      
      data.statut = requiresFinance ? 'attente validation finance' : 'calculer';
      
      // Try to serialize data to check if it's valid
      try {
        const serialized = JSON.stringify(data);
        console.log('Data serialization successful, length:', serialized.length);
      } catch (e) {
        console.error('Data serialization failed:', e);
        showAlert('Erreur: Les données ne peuvent pas être sérialisées. ' + e.message, 'error', 'calculeError');
        return;
      }
      
      const statusLabel = requiresFinance ? 'en attente de validation Finance' : 'calculer';
      const successMessage = autoSave
        ? `Sauvegarde automatique (${statusLabel}) effectuée. Marge: ${marge.toFixed(2)}%`
        : `Sauvegarde effectuée (${statusLabel}). Marge: ${marge.toFixed(2)}%`;
      
      console.log('Calling google.script.run.saveCalculToDataCalculeSimple');
      console.log('Parameters: packSelect=' + data.packSelect + ', entreprise=' + data.entreprise);
      
      google.script.run
        .withSuccessHandler((result) => {
          console.log('saveCalculToDataCalculeSimple result:', result);
          if (result && result.success) {
            autoSaveErrorShown = false;
            if (!autoSave) showTab('offreTab');
            showAlert(successMessage, 'success', 'calculeError');
          } else {
            console.error('Save failed:', result);
            showAlert('Erreur: ' + (result ? result.message : 'Erreur inconnue'), 'error', 'calculeError');
          }
        })
        .withFailureHandler((error) => {
          console.error('saveCalculToDataCalculeSimple failed:', error);
          console.error('Error type:', typeof error);
          console.error('Error details:', error);
          showAlert('Erreur lors de la sauvegarde: ' + (error ? error.message || error : 'Erreur inconnue'), 'error', 'calculeError');
        })
        .saveCalculToDataCalculeSimple(
          data.packSelect,
          data.entreprise,
          data.distanceMedecin,
          data.distanceInfirmier,
          data.distanceTechRadio,
          data.nbrMedecin,
          data.nbrInfirmier,
          data.nbrTechRadio,
          data.medecins,
          data.infirmiers,
          data.techRadio,
          data.medTaux,
          data.infTaux,
          data.techTaux,
          data.hebergement,
          data.dureeMed,
          data.dureeInf,
          data.dureeTech,
          data.frais,
          data.chargeSupp,
          data.nbrJours,
          data.dateFin,
          data.totalRevenue,
          data.totalCost,
          data.totalNet,
          data.statut,
          detailsJson
        );
    }
    
    // ============================================================
    // SCÉNARIO 3 - Collecte des données granulaires par personne
    // ============================================================
    function collectPersonnelGranular() {
      const personnelGranular = {
        medecins: [],
        infirmiers: [],
        techRadios: []
      };
      
      // Parcourir tous les personnel (nouveau format accordion + ancien format compatible)
      const personnelRows = document.querySelectorAll('.personnel-row-accordion, .personnel-row');
      
      personnelRows.forEach(row => {
        // Déterminer le type de personnel (med/inf/tech)
        let typePersonnel = '';
        const rowParent = row.closest('.site-section-remu') || row.closest('[class*="medecin"], [class*="infirmier"], [class*="techRadio"]');
        if (rowParent) {
          const siteId = rowParent.id || rowParent.className;
          if (siteId.includes('medecin')) typePersonnel = 'med';
          else if (siteId.includes('infirmier')) typePersonnel = 'inf';
          else if (siteId.includes('techRadio') || siteId.includes('tech-radio')) typePersonnel = 'tech';
        }
        
        // Extraire données de la row (compatible avec 2 formats)
        const nomInput = row.querySelector('.name-input') || 
                        row.querySelector('input[placeholder*="Nom"]') || 
                        row.querySelector('input[type="text"]:first-of-type');
        const distanceInput = row.querySelector('.distance-input');
        const tauxInput = row.querySelector('.taux-input');
        const nbrJourInput = row.querySelector('.nbr-jours-input') || 
                            row.querySelector('.nbr-jour-input') || 
                            row.closest('.site-section-remu')?.querySelector('.nbr-jour-input');
        
        // Chercher les coûts (peuvent être dans des spans ou divs selon le format)
        const deplCostSpan = row.querySelector('.depl-cost') || 
                            row.querySelector('[class*="depl-cost"]');
        const hebergCostSpan = row.querySelector('.heberg-cost') || 
                              row.querySelector('[class*="heberg-cost"]');
        const finalAmountSpan = row.querySelector('.final-amount') || 
                               row.querySelector('[class*="final-amount"]');
        
        // Construire objet personnel
        if (nomInput && nomInput.value && nomInput.value.trim()) {
          const personnel = {
            nom: nomInput.value.trim(),
            distance: parseFloat((distanceInput?.value || '0').replace(',', '.')) || 0,
            deplacement: parseFloat(deplCostSpan?.textContent || 0) || 0,
            hebergement: parseFloat(hebergCostSpan?.textContent || 0) || 0,
            taux: parseFloat(tauxInput?.value || 0) || 0,
            jours: parseInt(nbrJourInput?.value || 0) || 0
          };
          
          // Ajouter au tableau approprié
          if (typePersonnel === 'med') {
            personnelGranular.medecins.push(personnel);
          } else if (typePersonnel === 'inf') {
            personnelGranular.infirmiers.push(personnel);
          } else if (typePersonnel === 'tech') {
            personnelGranular.techRadios.push(personnel);
          }
        }
      });
      
      return personnelGranular;
    }
    
    // Function to update Financial Summary Table in Offre tab
    function updateFinancialSummaryTable() {
      const stored = localStorage.getItem('calculeData');
      if (!stored) {
        // No calculation data available
        document.getElementById('summaryRevenu').textContent = '0.00';
        document.getElementById('summaryRemuneration').textContent = '0.00';
        document.getElementById('summaryChargeLogistique').textContent = '0.00';
        document.getElementById('summaryYalidine').textContent = '0.00';
        document.getElementById('summaryCoutParametres').textContent = '0.00';
        document.getElementById('summaryChargeSupp').textContent = '0.00';
        document.getElementById('summaryPrixVisite').textContent = '0.00';
        document.getElementById('summaryTotalCharge').textContent = '0.00';
        document.getElementById('summaryNet').textContent = '0.00';
        document.getElementById('summaryMarge').textContent = '0.00';
        return;
      }
      
      const data = JSON.parse(stored);
      
      // Calculate from stored data
      const totalRevenu = data.totalRevenue || 0;
      const remuneration = (data.medTaux || 0) + (data.infTaux || 0) + (data.techTaux || 0);
      
      // Calculate charge logistique from distances and hébergement
      const tarifKm = getCalculationParam('tarifKm') || 15;
      const chargeLogistique = ((data.distanceMedecin || 0) + (data.distanceInfirmier || 0) + (data.distanceTechRadio || 0)) * tarifKm + (data.frais || 0);
      
      // Get Yalidine - need to calculate from data
      const yalidine = 0; // Will be calculated from nbr jour infirmier * tarif yalidine if needed
      
      // Coût paramètres - already in totalCost 
      const coutParametres = 0; // This should come from the acts majoration
      
      const chargeSupp = data.chargeSupp || 0;
      const prixVisite = parseFloat(document.getElementById('prixVisiteLieux')?.value) || 30000;
      
      // Calculate totals
      const totalCharge = remuneration + chargeLogistique + yalidine + coutParametres + chargeSupp + prixVisite;
      const net = totalRevenu - totalCharge;
      const marge = totalRevenu > 0 ? ((net / totalRevenu) * 100) : 0;
      
      // Update table
      document.getElementById('summaryRevenu').textContent = totalRevenu.toFixed(2);
      document.getElementById('summaryRemuneration').textContent = remuneration.toFixed(2);
      document.getElementById('summaryChargeLogistique').textContent = chargeLogistique.toFixed(2);
      document.getElementById('summaryYalidine').textContent = yalidine.toFixed(2);
      document.getElementById('summaryCoutParametres').textContent = coutParametres.toFixed(2);
      document.getElementById('summaryChargeSupp').textContent = chargeSupp.toFixed(2);
      document.getElementById('summaryPrixVisite').textContent = prixVisite.toFixed(2);
      document.getElementById('summaryTotalCharge').textContent = totalCharge.toFixed(2);
      document.getElementById('summaryNet').textContent = net.toFixed(2);
      document.getElementById('summaryMarge').textContent = marge.toFixed(2);
    }
    
    function createOffre() {
      try {
        const stored = localStorage.getItem('calculeData');
        if (!stored) {
          showAlert('Effectuez le calcul d\'abord dans l\'onglet Calcule d\'Offre.', 'error', 'offreError');
          return;
        }
        const data = JSON.parse(stored);
        const packValue = document.getElementById('packInput').value.trim();
        const parts = packValue.split(' - ');
        const packSelect = parts[0] ? parseInt(parts[0].trim()) : NaN;
        const entrepriseOffre = document.getElementById('entrepriseOffre').value.trim();
        if (data.packSelect !== packSelect || data.entreprise !== entrepriseOffre) {
          showAlert('Le pack ou l\'entreprise ne correspond pas au calcul sauvegardé.', 'error', 'offreError');
          return;
        }
        const coordination = document.getElementById('coordination').value.trim();
        const dateOperation = document.getElementById('dateOperation').value;
        const dateEnreg = document.getElementById('dateEnreg').value;
        const lieuEntreprise = document.getElementById('lieuEntreprise').value.trim();
        const deplacement = document.getElementById('deplacement').value;
        const nbrJours = parseInt(document.getElementById('nbrJoursOffre').value) || 0;
        const dateFin = document.getElementById('dateFinOffre').value;
        const observation = document.getElementById('observation').value.trim() || '';
        const statut = document.getElementById('statut').value;
        const prixVisiteLieux = parseFloat(document.getElementById('prixVisiteLieux').value) || 30000;
        const chargeSupp = parseFloat(document.getElementById('chargeSupplementaire').value) || 0;
        
        if (!coordination || !dateOperation || !dateEnreg || !lieuEntreprise || !deplacement || nbrJours <= 0 || !dateFin) {
          showAlert('Tous les champs obligatoires doivent être remplis.', 'error', 'offreError');
          return;
        }
        // Collecter les données granulaires du Scénario 3 (données individuelles par personne)
        const personnelGranular = collectPersonnelGranular();
        
        // Update data with new fields
        data.prixVisiteLieux = prixVisiteLieux;
        data.chargeSupp = chargeSupp;
        
        showLoader(true);
        google.script.run.withSuccessHandler(function(message) { 
          showLoader(false);
          onSuccess(message); 
          clearOffreForm(); 
          localStorage.removeItem('calculeData'); 
          loadOptions(); 
        }).withFailureHandler(err => {
          showLoader(false);
          showAlert('Erreur lors de la sauvegarde de l’offre: ' + (err && err.message ? err.message : 'Erreur inconnue'), 'error', 'offreError');
          console.error('Erreur saveOffre:', err);
        })
          .saveOffreModified(coordination, dateOperation, entrepriseOffre, packSelect, dateEnreg, lieuEntreprise, deplacement, data.wilayaDepartMedecin, data.wilayaDepartInfirmier, data.wilayaDepartTechRadio, data.distanceMedecin, data.distanceInfirmier, data.distanceTechRadio, data.materiels, data.distanceMateriel, data.nbrInfirmier, data.infirmiers, data.medecins, data.nbrMedecin, data.techRadio, data.nbrTechRadio, data.hebergement, data.dureeMed, data.dureeInf, data.dureeTech, data.dureeLog, data.frais, chargeSupp, observation, statut, nbrJours, dateFin, data.medTaux, data.infTaux, data.techTaux, personnelGranular, prixVisiteLieux);
      } catch (e) {
        showLoader(false);
        showAlert('Erreur interne avant sauvegarde offre: ' + e, 'error', 'offreError');
        console.error('Erreur createOffre:', e);
      }
    }
    
    // Function to check and update Prix Visite permissions
    function updatePrixVisitePermissions() {
      const prixVisiteField = document.getElementById('prixVisiteLieux');
      if (!prixVisiteField) return;
      
      // Allow admin and users with 'modifier' role to edit
      if (currentUser.role === 'admin' || currentUser.role === 'modifier') {
        prixVisiteField.readOnly = false;
        prixVisiteField.style.backgroundColor = 'white';
        prixVisiteField.style.cursor = 'text';
        prixVisiteField.title = 'Vous pouvez modifier ce champ';
      } else {
        prixVisiteField.readOnly = true;
        prixVisiteField.style.backgroundColor = '#f0f0f0';
        prixVisiteField.style.cursor = 'not-allowed';
        prixVisiteField.title = 'Ce champ ne peut être modifié que par l\'administrateur';
      }
    }
    
    function clearOffreForm() {
      document.getElementById('coordination').value = '';
      document.getElementById('dateOperation').value = '';
      document.getElementById('entrepriseOffre').value = '';
      document.getElementById('packInput').value = '';
      document.getElementById('dateEnreg').value = new Date().toISOString().split('T')[0];
      document.getElementById('lieuEntreprise').value = '';
      document.getElementById('deplacement').value = '';
      document.getElementById('nbrJoursOffre').value = '';
      document.getElementById('dateFinOffre').value = '';
      document.getElementById('observation').value = '';
      document.getElementById('statut').value = 'offre en traitement';
      document.getElementById('packTotalPrix').textContent = '0.00';
      document.getElementById('totalCharge').textContent = '0.00';
      document.getElementById('totalOperation').textContent = '0.00';
      document.getElementById('totalOperation').className = '';
    }
    function updateDateFinOffre() {
      const dateDepart = document.getElementById('dateOperation').value;
      const nbrJours = parseInt(document.getElementById('nbrJoursOffre').value) || 0;
      if (dateDepart && nbrJours > 0) {
        const startDate = new Date(dateDepart);
        startDate.setDate(startDate.getDate() + nbrJours);
        document.getElementById('dateFinOffre').value = startDate.toISOString().split('T')[0];
      }
    }
    function updateNbrJoursOffre() {
      const dateDepart = document.getElementById('dateOperation').value;
      const dateFin = document.getElementById('dateFinOffre').value;
      if (dateDepart && dateFin) {
        const start = new Date(dateDepart);
        const end = new Date(dateFin);
        const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        document.getElementById('nbrJoursOffre').value = diff > 0 ? diff : 0;
      }
    }
    function addMedecin() {
      console.log('addMedecin() called');
      const nom = document.getElementById('newMedNom').value.trim();
      const prenom = document.getElementById('newMedPrenom').value.trim();
      const tel = document.getElementById('newMedTel').value.trim();
      const wilaya = document.getElementById('newMedWilaya').value.trim();
      console.log('Values:', { nom, prenom, tel, wilaya });
      if (!nom || !prenom || !tel || !wilaya) {
        console.log('Validation failed');
        showAlert('Tous les champs sont obligatoires.', 'error', 'medError');
        return;
      }
      console.log('Calling addToSheet with:', ['Médecin', [nom, prenom, tel, wilaya]]);
      google.script.run.withSuccessHandler(function(message) { 
        console.log('Success:', message);
        onSuccess(message); 
        clearAddForm('med'); 
        loadOptions(); 
        loadMedecinsTable(); 
      }).withFailureHandler(function(error) {
        console.error('Error:', error);
        onFailure(error);
      }).addToSheet('Médecin', [nom, prenom, tel, wilaya]);
    }
    function addInfirmier() {
      const nom = document.getElementById('newInfNom').value.trim();
      const prenom = document.getElementById('newInfPrenom').value.trim();
      const tel = document.getElementById('newInfTel').value.trim();
      const wilaya = document.getElementById('newInfWilaya').value.trim();
      if (!nom || !prenom || !tel || !wilaya) {
        showAlert('Tous les champs sont obligatoires.', 'error', 'infError');
        return;
      }
      google.script.run.withSuccessHandler(function(message) { onSuccess(message); clearAddForm('inf'); loadOptions(); loadInfirmiersTable(); }).withFailureHandler(onFailure).addToSheet('Infirmier', [nom, prenom, tel, wilaya]);
    }
    function addTechRadio() {
      const nom = document.getElementById('newTechNom').value.trim();
      const prenom = document.getElementById('newTechPrenom').value.trim();
      const tel = document.getElementById('newTechTel').value.trim();
      const wilaya = document.getElementById('newTechWilaya').value.trim();
      if (!nom || !prenom || !tel || !wilaya) {
        showAlert('Tous les champs sont obligatoires.', 'error', 'techError');
        return;
      }
      google.script.run.withSuccessHandler(function(message) { onSuccess(message); clearAddForm('tech'); loadOptions(); loadTechRadiosTable(); }).withFailureHandler(onFailure).addToSheet('Tech Radio', [nom, prenom, tel, wilaya]);
    }
    function addCoordinateur() {
      const coordinateur = document.getElementById('newCoordinateur').value.trim();
      if (!coordinateur) {
        showAlert('Entrez un nom de coordinateur.', 'error', 'coordError');
        return;
      }
      google.script.run.withSuccessHandler(function(message) { onSuccess(message); clearAddForm('newCoordinateur'); loadOptions(); loadCoordinateursTable(); }).withFailureHandler(onFailure).addToSheet('Coordination', coordinateur);
    }
    function addMateriel() {
      const materiel = document.getElementById('newMateriel').value.trim();
      if (!materiel) {
        showAlert('Entrez un nom de matériel.', 'error', 'matError');
        return;
      }
      google.script.run.withSuccessHandler(function(message) { onSuccess(message); clearAddForm('newMateriel'); loadOptions(); loadMaterielsTable(); }).withFailureHandler(onFailure).addToSheet('Materiel', materiel);
    }
    function addEntreprise() {
      const entreprise = document.getElementById('newEntreprise').value.trim();
      if (!entreprise) {
        showAlert('Entrez un nom d\'entreprise.', 'error', 'entError');
        return;
      }
      google.script.run.withSuccessHandler(function(message) { onSuccess(message); clearAddForm('newEntreprise'); loadOptions(); loadEntreprisesTable(); }).withFailureHandler(onFailure).addToSheet('Entreprise', entreprise);
    }
    function addCommercial() {
      const nom = document.getElementById('newCommercialNom').value.trim();
      const prenom = document.getElementById('newCommercialPrenom').value.trim();
      const email = document.getElementById('newCommercialEmail').value.trim();
      if (!nom || !prenom || !email) {
        showAlert('Tous les champs sont obligatoires.', 'error', 'commercialError');
        return;
      }
      if (!email.includes('@')) {
        showAlert('Email invalide.', 'error', 'commercialError');
        return;
      }
      google.script.run.withSuccessHandler(function(message) { 
        onSuccess(message); 
        document.getElementById('newCommercialNom').value = '';
        document.getElementById('newCommercialPrenom').value = '';
        document.getElementById('newCommercialEmail').value = '';
        loadCommerciauxTable(); 
      }).withFailureHandler(onFailure).addCommercial(nom, prenom, email);
    }
    function loadCommerciauxTable() {
      google.script.run.withSuccessHandler(displayCommercialTable).getCommerciauxFull();
    }
    function displayCommercialTable(data) {
      const body = document.getElementById('commercialBody');
      body.innerHTML = '';
      data.forEach(comm => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${comm.code}</td>
          <td><input type="text" value="${comm.nom}"></td>
          <td><input type="text" value="${comm.prenom}"></td>
          <td><input type="text" value="${comm.email}"></td>
          <td>${comm.entreprises || '-'}</td>
          <td>
            <button class="btn-primary btn-small" onclick="saveCommercialEdit(this, ${comm.code})"><span class="material-icons">save</span> Sauvegarder</button>
            <button class="btn-danger btn-small" onclick="deleteCommercial(${comm.code})"><span class="material-icons">delete</span> Supprimer</button>
          </td>
        `;
        body.appendChild(row);
      });
    }
    function saveCommercialEdit(button, code) {
      const row = button.closest('tr');
      const inputs = row.querySelectorAll('input');
      const nom = inputs[0].value.trim();
      const prenom = inputs[1].value.trim();
      const email = inputs[2].value.trim();
      if (!nom || !prenom || !email) {
        showAlert('Tous les champs sont obligatoires.', 'error');
        return;
      }
      google.script.run.withSuccessHandler(() => onSuccess('Mis à jour.')).withFailureHandler(onFailure).updateCommercial(code, nom, prenom, email);
    }
    function deleteCommercial(code) {
      if (confirm('Supprimer ce commercial ?')) {
        google.script.run.withSuccessHandler(() => { onSuccess('Supprimé.'); loadCommerciauxTable(); }).withFailureHandler(onFailure).deleteItem('Commercial', code);
      }
    }
    function filterCommerciaux() {
      const nom = document.getElementById('filterCommercialNom').value.toLowerCase();
      const rows = document.querySelectorAll('#commercialBody tr');
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const match = !nom || inputs[0].value.toLowerCase().includes(nom) || inputs[1].value.toLowerCase().includes(nom);
        row.style.display = match ? '' : 'none';
      });
    }
    function checkEntrepriseCommercial() {
      const entreprise = document.getElementById('entreprise').value.trim();
      const commercial = document.getElementById('commercialPack').value.trim();
      const alertDiv = document.getElementById('entrepriseAlert');
      
      if (!entreprise || !commercial) {
        alertDiv.style.display = 'none';
        return;
      }
      
      google.script.run.withSuccessHandler(function(result) {
        if (result && result.fullName !== commercial) {
          alertDiv.className = 'alert alert-error';
          alertDiv.textContent = `L'entreprise ${entreprise} est déjà créée par le commercial "${result.fullName}". Vous ne pouvez pas créer une offre pour cette entreprise.`;
          alertDiv.style.display = 'block';
          document.getElementById('entreprise').value = '';
        } else {
          alertDiv.style.display = 'none';
        }
      }).withFailureHandler(onFailure).getCommercialForEntreprise(entreprise);
    }
    function clearAddForm(prefix) {
      if (prefix === 'med') {
        document.getElementById('newMedNom').value = '';
        document.getElementById('newMedPrenom').value = '';
        document.getElementById('newMedTel').value = '';
        document.getElementById('newMedWilaya').value = '';
      } else if (prefix === 'inf') {
        document.getElementById('newInfNom').value = '';
        document.getElementById('newInfPrenom').value = '';
        document.getElementById('newInfTel').value = '';
        document.getElementById('newInfWilaya').value = '';
      } else if (prefix === 'tech') {
        document.getElementById('newTechNom').value = '';
        document.getElementById('newTechPrenom').value = '';
        document.getElementById('newTechTel').value = '';
        document.getElementById('newTechWilaya').value = '';
      } else {
        document.getElementById(prefix).value = '';
      }
    }
    function loadOptions() {
      showLoader(true);
      google.script.run.withSuccessHandler(populateOptions).getOptions();
      google.script.run.withSuccessHandler(populatePacks).getPacks();
      google.script.run.withSuccessHandler(populateCommerciaux).getCommerciauxList();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateEnreg').value = today;
      showLoader(false);
    }
    function populateCommerciaux(commerciaux) {
      const list = document.getElementById('commercialList');
      if (list) {
        list.innerHTML = '';
        commerciaux.forEach(comm => {
          const opt = document.createElement('option');
          opt.value = comm;
          list.appendChild(opt);
        });
      }
    }
    function populateOptions(options) {
      populateDataList('coordList', options.coordinations);
      populateDataList('medList', options.medecins);
      populateDataList('infList', options.infirmiers);
      populateDataList('techList', options.techRadios);
      populateDataList('entrepriseList', options.entreprises);
      availableEntreprises = options.entreprises;
      populateDataList('wilayaList', options.wilayas);
      populateSelect('deplacement', options.deplacements, false);
      populateDataList('matList', options.materiels); // Pour filtre matériel dans suivi
      populateSelect('editDeplacement', options.deplacements, false);
    }
    function populatePacks(packs) {
      const list = document.getElementById('packList');
      if (list) {
        list.innerHTML = '';
        packs.forEach(pack => {
          const opt = document.createElement('option');
          opt.value = `${pack.codePack} - ${pack.packName}`;
          list.appendChild(opt);
        });
      }
    }
    function populatePacksForOffre(packs) {
      const list = document.getElementById('packList');
      list.innerHTML = '';
      packs.forEach(pack => {
        const opt = document.createElement('option');
        opt.value = `${pack.codePack} - ${pack.packName}`;
        list.appendChild(opt);
      });
    }
    function populateDataList(id, items) {
      const list = document.getElementById(id);
      list.innerHTML = '';
      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        list.appendChild(opt);
      });
    }
    function populateSelect(id, items, multiple) {
      const select = document.getElementById(id);
      select.innerHTML = '';
      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        select.appendChild(opt);
      });
      if (multiple) select.multiple = true;
    }
    function populateMaterielCheckboxes(containerId, items) {
      const container = document.getElementById(containerId);
      if (container) {
        container.innerHTML = '';
        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'materiel-item';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = item;
          cb.onchange = function() { if (containerId === 'editMaterielContainer') updateEditCalcule(); };
          div.appendChild(cb);
          const label = document.createElement('label');
          label.textContent = item;
          div.appendChild(label);
          container.appendChild(div);
        });
      }
    }
    function toggleFullScreen() {
      var elem = document.documentElement;
      if (!document.fullscreenElement) {
        elem.requestFullscreen().catch(err => {
          alert(`Erreur lors de la tentative de passage en mode plein écran: ${err.message} (${err.name})`);
        });
      } else {
        document.exitFullscreen();
      }
    }
    // Fonctions pour Rémunération
    function loadRemunerations() {
      const month = parseInt(document.getElementById('remunMonth').value);
      const year = parseInt(document.getElementById('remunYear').value);
      google.script.run.withSuccessHandler(data => {
        allRemunData = data;
        applyRemunFilters();
      }).withFailureHandler(onFailure).getRemunerationsData(month, year);
    }
    function loadPaidRemunerations() {
      const month = parseInt(document.getElementById('paiementsMonth').value);
      const year = parseInt(document.getElementById('paiementsYear').value);
      google.script.run.withSuccessHandler(data => {
        allPaidRemunData = data;
        applyPaiementsFilters();
      }).withFailureHandler(onFailure).getPaidRemunerationsData(month, year);
    }
    function applyRemunFilters() {
      const nom = document.getElementById('filterRemunNom').value.toLowerCase().trim();
      const prenom = document.getElementById('filterRemunPrenom').value.toLowerCase().trim();
      const wilaya = document.getElementById('filterRemunWilaya').value.toLowerCase().trim();
      const codeOpe = document.getElementById('filterRemunCodeOpe').value.toLowerCase().trim();
      const dateStart = document.getElementById('filterRemunDateStart').value;
      const dateEnd = document.getElementById('filterRemunDateEnd').value;
      const entreprise = document.getElementById('filterRemunEntreprise').value.toLowerCase().trim();
      const typeFilter = document.getElementById('filterRemunType').value;
      const filtered = allRemunData.filter(person => {
        let match = true;
        if (nom && !person.nom.toLowerCase().includes(nom)) match = false;
        if (prenom && !person.prenom.toLowerCase().includes(prenom)) match = false;
        if (wilaya && !person.wilaya.toLowerCase().includes(wilaya)) match = false;
        if (typeFilter && person.type !== typeFilter) match = false;
        let missionMatch = person.missions.some(mission => {
          let mMatch = true;
          if (codeOpe && !mission.codeOpe.toString().includes(codeOpe)) mMatch = false;
          if (dateStart && mission.dateOperation < dateStart) mMatch = false;
          if (dateEnd && mission.dateOperation > dateEnd) mMatch = false;
          if (entreprise && !mission.entreprise.toLowerCase().includes(entreprise)) mMatch = false;
          return mMatch;
        });
        if (codeOpe || dateStart || dateEnd || entreprise) {
          match = match && missionMatch;
        }
        return match;
      });
      displayRemunTable('remun', filtered, 1);
    }
    function applyPaiementsFilters() {
      const nom = document.getElementById('filterPaiementsNom').value.toLowerCase().trim();
      const prenom = document.getElementById('filterPaiementsPrenom').value.toLowerCase().trim();
      const wilaya = document.getElementById('filterPaiementsWilaya').value.toLowerCase().trim();
      const codeOpe = document.getElementById('filterPaiementsCodeOpe').value.toLowerCase().trim();
      const dateStart = document.getElementById('filterPaiementsDateStart').value;
      const dateEnd = document.getElementById('filterPaiementsDateEnd').value;
      const entreprise = document.getElementById('filterPaiementsEntreprise').value.toLowerCase().trim();
      const typeFilter = document.getElementById('filterPaiementsType').value;
      const filtered = allPaidRemunData.filter(person => {
        let match = true;
        if (nom && !person.nom.toLowerCase().includes(nom)) match = false;
        if (prenom && !person.prenom.toLowerCase().includes(prenom)) match = false;
        if (wilaya && !person.wilaya.toLowerCase().includes(wilaya)) match = false;
        if (typeFilter && person.type !== typeFilter) match = false;
        let missionMatch = person.missions.some(mission => {
          let mMatch = true;
          if (codeOpe && !mission.codeOpe.toString().includes(codeOpe)) mMatch = false;
          if (dateStart && mission.dateOperation < dateStart) mMatch = false;
          if (dateEnd && mission.dateOperation > dateEnd) mMatch = false;
          if (entreprise && !mission.entreprise.toLowerCase().includes(entreprise)) mMatch = false;
          return mMatch;
        });
        if (codeOpe || dateStart || dateEnd || entreprise) {
          match = match && missionMatch;
        }
        return match;
      });
      displayRemunTable('paiements', filtered, 1);
    }
    function displayRemunTable(type, data, page) {
      const bodyId = type + 'Body';
      const paginationId = type + 'Pagination';
      const body = document.getElementById(bodyId);
      body.innerHTML = '';
      const pageSize = 10;
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const paginated = data.slice(start, end);
      paginated.forEach(person => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${person.type.toUpperCase()}</td>
          <td>${person.fullName}</td>
          <td>${person.nom}</td>
          <td>${person.prenom}</td>
          <td>${person.tel}</td>
          <td>${person.wilaya}</td>
          <td><span class="total-mois">${person.totalMois.toFixed(2)}</span></td>
          <td>${type === 'remun' ? `<button class="btn-primary" onclick="markPaid('${person.fullName}'); event.stopPropagation();">Marquer Payé</button>` : ''}</td>
        `;
        row.onclick = () => toggleMissions(row, person.missions, person.fullName);
        body.appendChild(row);
        const missionsRow = document.createElement('tr');
        missionsRow.className = 'remun-missions';
        missionsRow.style.display = 'none';
        missionsRow.innerHTML = '<td colspan="8"></td>';
        body.appendChild(missionsRow);
      });
      const totalPages = Math.ceil(data.length / pageSize);
      const pagination = document.getElementById(paginationId);
      pagination.innerHTML = '';
      const prevBtn = document.createElement('button');
      prevBtn.textContent = 'Précédent';
      prevBtn.onclick = () => displayRemunTable(type, data, page - 1);
      if (page === 1) prevBtn.disabled = true;
      pagination.appendChild(prevBtn);
      for (let i = 1; i <= totalPages; i++) {
        const pageSpan = document.createElement('span');
        pageSpan.textContent = i;
        pageSpan.classList.toggle('active-page', i === page);
        pageSpan.onclick = () => displayRemunTable(type, data, i);
        pagination.appendChild(pageSpan);
      }
      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Suivant';
      nextBtn.onclick = () => displayRemunTable(type, data, page + 1);
      if (page === totalPages) nextBtn.disabled = true;
      pagination.appendChild(nextBtn);
    }
    function toggleMissions(div, missions, personnel) {
      const missionsTd = div.nextElementSibling.querySelector('td');
      const missionsTr = div.nextElementSibling;
      if (missionsTr.style.display === 'table-row') {
        missionsTr.style.display = 'none';
      } else {
        let missionsHtml = '<table><thead><tr><th>Op</th><th>Date</th><th>Jours</th><th>Taux/Jour</th><th>Total Op</th><th>Entreprise</th><th>Date Début</th><th>Date Fin</th><th>Site</th><th>Statut</th></tr></thead><tbody>';
        missions.forEach(mission => {
          missionsHtml += `
            <tr>
              <td>${mission.codeOpe}</td>
              <td>${mission.dateOperation}</td>
              <td>${mission.nbrJours}</td>
              <td><input type="number" class="taux-jour" value="${mission.tauxParJour}" oninput="calcTotalOp(this, '${personnel}', '${mission.codeOpe}')" ${mission.paid ? 'disabled' : ''}></td>
              <td><span class="total-op">${mission.totalOp.toFixed(2)}</span></td>
              <td>${mission.entreprise}</td>
              <td>${mission.dateStart}</td>
              <td>${mission.dateEnd}</td>
              <td>${mission.site}</td>
              <td>${mission.paid ? 'Payé' : ''}</td>
            </tr>
          `;
        });
        missionsHtml += '</tbody></table>';
        missionsTd.innerHTML = missionsHtml;
        missionsTr.style.display = 'table-row';
      }
    }
    function calcTotalOp(input, personnel, codeOpe) {
      const row = input.closest('tr');
      const taux = parseFloat(input.value) || 0;
      const nbrJours = parseInt(row.querySelector('td:nth-child(3)').textContent) || 0;
      const totalOp = taux * nbrJours;
      row.querySelector('.total-op').textContent = totalOp.toFixed(2);
      // Mise à jour total mois
      let totalMois = 0;
      row.closest('tbody').querySelectorAll('.total-op').forEach(span => totalMois += parseFloat(span.textContent) || 0);
      row.closest('table').closest('td').closest('tr').previousElementSibling.querySelector('.total-mois').textContent = totalMois.toFixed(2);
      // Sauvegarder
      const update = {personnel, codeOpe, tauxParJour: taux};
      google.script.run.withSuccessHandler(() => {}).withFailureHandler(onFailure).saveRemunerations([update]);
    }
    function markPaid(personnel, month, year) {
      const monthVal = parseInt(document.getElementById('remunMonth').value);
      const yearVal = parseInt(document.getElementById('remunYear').value);
      google.script.run.withSuccessHandler(message => {
        showAlert(message, 'success', 'remunError');
        loadRemunerations();
      }).withFailureHandler(onFailure).markAsPaid(personnel, monthVal, yearVal);
    }
    function clearRemunFilters() {
      document.getElementById('filterRemunNom').value = '';
      document.getElementById('filterRemunPrenom').value = '';
      document.getElementById('filterRemunWilaya').value = '';
      document.getElementById('filterRemunCodeOpe').value = '';
      document.getElementById('filterRemunDateStart').value = '';
      document.getElementById('filterRemunDateEnd').value = '';
      document.getElementById('filterRemunEntreprise').value = '';
      document.getElementById('filterRemunType').value = '';
      applyRemunFilters();
    }
    function clearPaiementsFilters() {
      document.getElementById('filterPaiementsNom').value = '';
      document.getElementById('filterPaiementsPrenom').value = '';
      document.getElementById('filterPaiementsWilaya').value = '';
      document.getElementById('filterPaiementsCodeOpe').value = '';
      document.getElementById('filterPaiementsDateStart').value = '';
      document.getElementById('filterPaiementsDateEnd').value = '';
      document.getElementById('filterPaiementsEntreprise').value = '';
      document.getElementById('filterPaiementsType').value = '';
      applyPaiementsFilters();
    }
    function updateQuickStats() {
      const totalOffres = (allPackData || []).length;
      const revenueTotal = (allPackData || []).reduce((sum, p) => sum + (Number(p.totalRevenue || p.totalPrix || 0) || 0), 0);
      const margins = (allPackData || []).map(p => {
        const rev = Number(p.totalRevenue || p.totalPrix || 0) || 0;
        const net = Number(p.totalNet || p.totalNetPack || 0) || 0;
        return rev ? (net / rev) * 100 : 0;
      }).filter(v => !isNaN(v));
      const margeMoy = margins.length ? (margins.reduce((a, b) => a + b, 0) / margins.length) : 0;
      const setText = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
      };
      setText('stat-total-offres', totalOffres);
      setText('stat-total-revenue', revenueTotal.toFixed(2));
      setText('stat-marge-moy', margeMoy.toFixed(2) + '%');
    }
    // New functions for data tabs
    function updateReconciliationOptions() {
      renderReconciliationView();
    }
    function loadAllPacksData() {
      google.script.run.withSuccessHandler(data => {
        allPackData = data || [];
        applyPackFilters();
        updateReconciliationOptions();
        updateNotificationBadge();
        updateQuickStats();
      }).withFailureHandler(onFailure).getAllPacksData();
    }
    function applyPackFilters(page = 1) {
      const code = document.getElementById('filterPackCode').value.toLowerCase().trim();
      const name = document.getElementById('filterPackName').value.toLowerCase().trim();
      const entreprise = document.getElementById('filterPackEntreprise').value.toLowerCase().trim();
      const status = document.getElementById('filterPackStatus').value;
      const lieu = document.getElementById('filterPackLieu').value.toLowerCase().trim();
      const dateStart = document.getElementById('filterPackDateStart').value;
      const dateEnd = document.getElementById('filterPackDateEnd').value;
      const month = document.getElementById('filterPackMonth').value;

      const filtered = (allPackData || []).filter(pack => {
        const packCode = (pack.codePack || pack.code || '').toString().toLowerCase();
        const packName = (pack.packName || '').toLowerCase();
        const packEntreprise = (pack.entreprise || '').toLowerCase();
        const packLieu = (pack.lieu || '').toLowerCase();
        const packStatus = (pack.status || '').toLowerCase();
        const packDate = pack.dateEnreg || '';
        const packMonth = packDate ? new Date(packDate).getMonth() + 1 : null;
        const passesCode = !code || packCode.includes(code);
        const passesName = !name || packName.includes(name);
        const passesEntreprise = !entreprise || packEntreprise.includes(entreprise);
        const passesStatus = !status || packStatus === status.toLowerCase();
        const passesLieu = !lieu || packLieu.includes(lieu);
        const passesDateStart = !dateStart || (packDate && packDate >= dateStart);
        const passesDateEnd = !dateEnd || (packDate && packDate <= dateEnd);
        const passesMonth = !month || packMonth === Number(month);
        return passesCode && passesName && passesEntreprise && passesStatus && passesLieu && passesDateStart && passesDateEnd && passesMonth;
      });

      const totals = filtered.reduce((acc, pack) => {
        const rev = Number(pack.totalRevenue ?? pack.totalPrix ?? 0) || 0;
        const cost = Number(pack.totalCost ?? pack.totalCharge ?? 0) || 0;
        const net = Number(pack.totalNet ?? (rev - cost)) || 0;
        acc.revenue += rev;
        acc.cost += cost;
        acc.net += net;
        return acc;
      }, {revenue: 0, cost: 0, net: 0});

      displayPackTable(filtered, page, totals);
    }
    function displayPackTable(data, page, totals = {revenue:0, cost:0, net:0}) {
      const body = document.getElementById('dataPackBody');
      body.innerHTML = '';
      const pageSize = 10;
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const paginated = data.slice(start, end);
      paginated.forEach(pack => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${pack.codePack}</td>
          <td>${pack.packName}</td>
          <td>${pack.entreprise}</td>
          <td>${pack.status}</td>
          <td>${pack.nbrEmployes}</td>
          <td>${pack.lieu}</td>
          <td>${pack.totalRevenue ?? pack.totalPrix}</td>
          <td>${pack.totalCost ?? ''}</td>
          <td>${pack.totalNet ?? ''}</td>
          <td>${pack.dateEnreg}</td>
          <td><button class="btn-primary btn-small" onclick="editPack(${pack.codePack})"><span class="material-icons">edit</span> Éditer</button></td>
        `;
        body.appendChild(row);
      });
      const totalRow = document.createElement('tr');
      totalRow.innerHTML = `
        <td><strong>Total</strong></td>
        <td colspan="5"></td>
        <td><strong>${(totals.revenue || 0).toFixed(2)}</strong></td>
        <td><strong>${(totals.cost || 0).toFixed(2)}</strong></td>
        <td><strong>${(totals.net || 0).toFixed(2)}</strong></td>
        <td></td>
        <td></td>
      `;
      body.appendChild(totalRow);
      const totalPages = Math.ceil(data.length / pageSize);
      const pagination = document.getElementById('dataPackPagination');
      pagination.innerHTML = '';
      const prevBtn = document.createElement('button');
      prevBtn.textContent = 'Précédent';
      prevBtn.onclick = () => displayPackTable(data, page - 1, totals);
      if (page === 1) prevBtn.disabled = true;
      pagination.appendChild(prevBtn);
      for (let i = 1; i <= totalPages; i++) {
        const pageSpan = document.createElement('span');
        pageSpan.textContent = i;
        pageSpan.classList.toggle('active-page', i === page);
        pageSpan.onclick = () => displayPackTable(data, i, totals);
        pagination.appendChild(pageSpan);
      }
      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Suivant';
      nextBtn.onclick = () => displayPackTable(data, page + 1, totals);
      if (page === totalPages) nextBtn.disabled = true;
      pagination.appendChild(nextBtn);
    }
    function loadAllCalculeData() {
      google.script.run.withSuccessHandler(data => {
        const sorted = (data || []).slice().sort((a, b) => {
          const da = new Date(a?.dateEnreg || a?.dateOperation || a?.dateCreation || 0);
          const db = new Date(b?.dateEnreg || b?.dateOperation || b?.dateCreation || 0);
          return db - da;
        });
        allCalculeData = sorted;
        allOffreData = sorted; // reuse calcul data for offre view for now
        updateReconciliationOptions();
        renderReconciliationView();
        renderReconciliationTable();
        if (document.getElementById('dataCalculeTab')?.classList.contains('active')) {
          renderDataOffreTable();
        }
        loadNotifications();
        updateNotificationBadge();
      }).withFailureHandler(onFailure).getAllCalculeData();
    }
    function loadNotifications() {
      google.script.run.withSuccessHandler(notifs => {
        document.getElementById('nonCalculeNotif').textContent = `${notifs.nonCalcule} pack non calculé`;
        document.getElementById('calculeNotif').textContent = `${notifs.calcule} pack calculé ce mois`;
      }).withFailureHandler(onFailure).getNotifications();
    }
    function updateNotifications() {
      loadNotifications();
      updateNotificationBadge();
    }
    function getSelectedValues(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return [];
      return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
    }
    function bindSelectAll(containerId, selectAllId) {
      const container = document.getElementById(containerId);
      const selectAll = document.getElementById(selectAllId);
      if (!container || !selectAll) return;
      selectAll.addEventListener('change', () => {
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          if (cb !== selectAll) cb.checked = selectAll.checked;
        });
      });
      container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb === selectAll) return;
        cb.addEventListener('change', () => {
          const allChecked = Array.from(container.querySelectorAll('input[type="checkbox"]')).filter(c => c !== selectAll).every(c => c.checked);
          selectAll.checked = allChecked;
        });
      });
    }
    function loadUsersAdmin() {
      google.script.run.withSuccessHandler(users => {
        usersCache = users || [];
        renderUsersTable();
      }).withFailureHandler(onFailure).getUsers();
    }
    function renderUsersTable() {
      const body = document.getElementById('usersTableBody');
      if (!body) return;
      if (!usersCache || usersCache.length === 0) {
        body.innerHTML = '<tr><td colspan="4" style="text-align:center;">Aucun utilisateur</td></tr>';
        return;
      }
      body.innerHTML = usersCache.map(u => `
        <tr>
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td>${(u.tabs || []).join(', ')}</td>
          <td>${(u.permissions || []).join(', ')}</td>
          <td>
            ${currentUser.role === 'admin' ? `
              <button class="btn-primary btn-small" onclick="editUser('${u.username}')">Modifier</button>
              <button class="btn-danger btn-small" onclick="deleteUser('${u.username}')">Supprimer</button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    }
    function saveAdminUser() {
      const username = document.getElementById('adminUsername').value.trim();
      const password = document.getElementById('adminPassword').value;
      const role = document.getElementById('adminRole').value;
      const tabs = getSelectedValues('adminTabsList');
      const permissions = getSelectedValues('adminPermissionsList');
      if (!username || !password) {
        showAlert('Utilisateur et mot de passe requis.', 'error', 'adminUserMessage');
        return;
      }
      google.script.run.withSuccessHandler(msg => {
        const msgDiv = document.getElementById('adminUserMessage');
        if (msgDiv) {
          msgDiv.className = 'alert alert-success';
          msgDiv.style.display = 'block';
          msgDiv.textContent = msg;
        }
        loadUsersAdmin();
      }).withFailureHandler(err => {
        const msgDiv = document.getElementById('adminUserMessage');
        if (msgDiv) {
          msgDiv.className = 'alert alert-error';
          msgDiv.style.display = 'block';
          msgDiv.textContent = err;
        }
      }).saveUserAccount(username, password, role, tabs, permissions);
    }
    function editUser(username) {
      const user = usersCache.find(u => u.username === username);
      if (!user) return showAlert('Utilisateur introuvable', 'error', 'adminUserMessage');
      document.getElementById('adminUsername').value = user.username;
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminRole').value = user.role || 'admin';
      // Reset selections
      document.querySelectorAll('#adminTabsList input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#adminPermissionsList input[type="checkbox"]').forEach(cb => cb.checked = false);
      (user.tabs || []).forEach(t => {
        const cb = document.querySelector(`#adminTabsList input[value="${t}"]`);
        if (cb) cb.checked = true;
      });
      (user.permissions || []).forEach(p => {
        const cb = document.querySelector(`#adminPermissionsList input[value="${p}"]`);
        if (cb) cb.checked = true;
      });
      document.getElementById('adminUserMessage').style.display = 'none';
      showAlert('Utilisateur chargé pour modification. Saisissez un mot de passe si vous souhaitez le changer.', 'success', 'adminUserMessage');
    }
    function deleteUser(username) {
      if (!confirm(`Supprimer l'utilisateur ${username} ?`)) return;
      google.script.run.withSuccessHandler(msg => {
        showAlert(msg, 'success', 'adminUserMessage');
        loadUsersAdmin();
      }).withFailureHandler(err => {
        showAlert('Erreur suppression: ' + (err && err.message ? err.message : err), 'error', 'adminUserMessage');
      }).deleteUserAccount(username);
    }
    function initAdminSelectAll() {
      bindSelectAll('adminTabsList', 'tabsSelectAll');
      bindSelectAll('adminPermissionsList', 'permsSelectAll');
    }
    function applyCalculeFilters() {
      renderReconciliationView();
    }
    function clearPackFilters() {
      document.getElementById('filterPackName').value = '';
      document.getElementById('filterPackEntreprise').value = '';
      document.getElementById('filterPackCode').value = '';
      document.getElementById('filterPackLieu').value = '';
      document.getElementById('filterPackDateStart').value = '';
      document.getElementById('filterPackDateEnd').value = '';
      document.getElementById('filterPackMonth').value = '';
      document.getElementById('filterPackStatus').value = '';
      applyPackFilters();
    }
    function getActivePackFinancials() {
      let pack = null;
      if (selectedOffreRowId) {
        pack = (allPackData || []).find(p => String(p.codePack) === String(selectedOffreRowId));
      }
      if (!pack) {
        const packName = document.getElementById('packInputCalcule')?.value || '';
        if (packName) {
          pack = (allPackData || []).find(p => (p.packName || '').toLowerCase() === packName.toLowerCase());
        }
      }
      if (!pack && allPackData && allPackData.length) {
        pack = allPackData[0];
      }
      return pack;
    }
    function renderReconciliationView() {
      const body = document.getElementById('financialSummaryBody');
      if (!body) return;
      const pack = getActivePackFinancials();
      if (!pack) {
        body.innerHTML = '<tr><td colspan="2" style="text-align:center;">Aucune donnée disponible.</td></tr>';
        return;
      }
      const revenue = Number(pack.totalRevenue ?? pack.totalPrix ?? 0) || 0;
      const remuneration = Number(pack.totalRemun ?? pack.totalRemunPack ?? 0) || 0;
      const chargeLogistique = Number(pack.chargeLogistique ?? pack.totalTransportPack ?? 0) || 0;
      const coutParam = Number(pack.paramPack ?? 0) || 0;
      const yalidine = Number(pack.yalidinePack ?? 0) || 0;
      const chargeSupp = Number(pack.chargeSupp ?? 0) || 0;
      const prixVisite = Number(getCalculationParam('prixVisiteLieux')) || Number(document.getElementById('paramPrixVisiteLieux')?.value) || 0;
      const totalCharge = remuneration + chargeLogistique + coutParam + yalidine + chargeSupp + prixVisite;
      const net = revenue - totalCharge;
      const marge = revenue ? (net / revenue) * 100 : 0;
      body.innerHTML = `
        <tr><td>Total Revenu</td><td>${formatCurrency(revenue)}</td></tr>
        <tr><td>Rémunération</td><td>${formatCurrency(remuneration)}</td></tr>
        <tr><td>Charge logistique</td><td>${formatCurrency(chargeLogistique)}</td></tr>
        <tr><td>Coût Paramètres</td><td>${formatCurrency(coutParam)}</td></tr>
        <tr><td>Yalidine</td><td>${formatCurrency(yalidine)}</td></tr>
        <tr><td>Charge Supplémentaire</td><td>${formatCurrency(chargeSupp)}</td></tr>
        <tr><td>Prix Visite Lieux</td><td>${formatCurrency(prixVisite)}</td></tr>
        <tr><td><strong>Total Charge</strong></td><td><strong>${formatCurrency(totalCharge)}</strong></td></tr>
        <tr><td><strong>Net</strong></td><td><strong>${formatCurrency(net)}</strong></td></tr>
        <tr><td>Marge nette</td><td>${marge.toFixed(2)}%</td></tr>
      `;
    }
    function formatCurrency(value) {
      return (Number(value) || 0).toFixed(2);
    }
    function renderReconciliationTable() {
      renderReconciliationView();
    }
    function clearReconciliationFilters() {
      ['filterRecEntreprise', 'filterRecPack', 'filterRecSite'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      selectedRecRowIds.clear();
      recTablePage = 1;
      renderReconciliationTable();
    }
    function toggleRecRow(codePack) {
      if (!codePack && codePack !== 0) return;
      if (selectedRecRowIds.has(codePack)) selectedRecRowIds.delete(codePack);
      else selectedRecRowIds.add(codePack);
      renderReconciliationTable(recTablePage);
    }
    function getFilteredOffreRows() {
      const fEnt = (document.getElementById('filterOffreEntreprise')?.value || '').toLowerCase();
      const fPack = (document.getElementById('filterOffrePack')?.value || '').toLowerCase();
      const fDate = document.getElementById('filterOffreDate')?.value || '';

      return (allOffreData || []).filter(r => {
        const ent = (r.entreprise || '').toLowerCase();
        const packName = (r.packName || r.codePack || '').toString().toLowerCase();
        const dateEnreg = r.dateEnreg || '';
        const passEnt = !fEnt || ent.includes(fEnt);
        const passPack = !fPack || packName.includes(fPack);
        const passDate = !fDate || dateEnreg === fDate;
        return passEnt && passPack && passDate;
      });
    }
    function renderDataOffreTable(page = 1) {
      const body = document.getElementById('dataOffreBody');
      if (!body) return;

      const rows = getFilteredOffreRows();
      currentOffreRows = rows;

      const pageSize = 10;
      const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
      const safePage = Math.min(Math.max(page, 1), totalPages);
      const start = (safePage - 1) * pageSize;
      const slice = rows.slice(start, start + pageSize);

      let htmlRows = '';
      slice.forEach(r => {
        const revenue = Number(r.totalRevenue ?? r.totalPrix ?? 0) || 0;
        const cost = Number(r.totalCost ?? r.totalCharge ?? 0) || 0;
        const net = Number(r.totalNet ?? (revenue - cost)) || 0;
        const marge = revenue ? ((net / revenue) * 100).toFixed(2) : '0.00';
        const ecart = revenue - cost;
        htmlRows += `
          <tr onclick="showOffreDetail(this)">
            <td><input type="checkbox" ${selectedOffreRowId === r.codePack ? 'checked' : ''} onclick="event.stopPropagation(); selectOffreRow(${r.codePack}, '${r.entreprise}', '${r.packName}', this)"></td>
            <td>${r.codePack || ''}</td>
            <td>${r.entreprise || ''}</td>
            <td>${r.dateCreation || r.dateOperation || ''}</td>
            <td>${r.dateEnreg || ''}</td>
            <td>${ecart.toFixed(2)}</td>
            <td>${revenue.toFixed(2)}</td>
            <td>${cost.toFixed(2)}</td>
            <td>${net.toFixed(2)}</td>
            <td>${marge}%</td>
            <td>${r.nbrMedecin || r.nbrMed || 0}</td>
            <td>${r.nbrInfirmier || r.nbrInf || 0}</td>
            <td>${r.nbrTechRadio || r.nbrTech || 0}</td>
            <td><button class="btn-primary btn-small" onclick="event.stopPropagation(); showOffreDetail(this.parentElement.parentElement)">Détails</button></td>
          </tr>
        `;
      });

      body.innerHTML = htmlRows || '<tr><td colspan="14" style="text-align:center;">Aucune donnée disponible</td></tr>';

      const pag = document.getElementById('dataOffrePagination');
      if (pag) {
        let pagHtml = `<button ${safePage === 1 ? 'disabled' : ''} onclick="renderDataOffreTable(${safePage - 1})">Précédent</button>`;
        for (let p = 1; p <= totalPages; p++) {
          pagHtml += `<button class="${p === safePage ? 'active' : ''}" onclick="renderDataOffreTable(${p})">${p}</button>`;
        }
        pagHtml += `<button ${safePage === totalPages ? 'disabled' : ''} onclick="renderDataOffreTable(${safePage + 1})">Suivant</button>`;
        pag.innerHTML = pagHtml;
      }
    }
    function selectOffreRow(rowId, entreprise, codePack, checkboxEl) {
      const body = document.getElementById('dataOffreBody');
      if (!body) return;
      body.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb !== checkboxEl) cb.checked = false;
      });
      if (checkboxEl.checked) {
        selectedOffreRowId = rowId;
        const entInput = document.getElementById('filterRecEntreprise');
        if (entInput) entInput.value = entreprise || '';
        const packInput = document.getElementById('filterRecPack');
        if (packInput) packInput.value = codePack || '';
      } else {
        selectedOffreRowId = null;
        const entInput = document.getElementById('filterRecEntreprise');
        if (entInput) entInput.value = '';
        const packInput = document.getElementById('filterRecPack');
        if (packInput) packInput.value = '';
      }
      renderReconciliationTable(1);
      renderReconciliationView();
    }
    function showOffreDetail(row) {
      const cells = row.querySelectorAll('td');
      if (cells.length < 13) return;
      const details = `
Code Pack: ${cells[1].textContent}
Entreprise: ${cells[2].textContent}
Date Création: ${cells[3].textContent}
Date Enregistrement: ${cells[4].textContent}
Écart: ${cells[5].textContent}
Total Revenue: ${cells[6].textContent}
Coût: ${cells[7].textContent}
Total Net: ${cells[8].textContent}
Marge %: ${cells[9].textContent}
Médecins: ${cells[10].textContent}
Infirmiers: ${cells[11].textContent}
Tech Radio: ${cells[12].textContent}
      `;
      alert(details);
      // Ou pour une nouvelle fenêtre:
      // const newWin = window.open('', '_blank', 'width=400,height=300');
      // newWin.document.write('<pre>' + details + '</pre>');
    }
    function exportDataOffreCsv() {
      const rows = getFilteredOffreRows();
      currentOffreRows = rows;
      if (!rows.length) return showAlert('Aucune donnée à exporter', 'error');
      const headers = ['Code Pack','Entreprise','Date Création','Date Enregistrement','Écart','Total Revenue','Coût','Total Net','Marge %','Médecins','Infirmiers','Tech Radio'];
      const csv = [headers.join(',')].concat(rows.map(r => {
        const revenue = Number(r.totalRevenue ?? r.totalPrix ?? 0) || 0;
        const cost = Number(r.totalCost ?? r.totalCharge ?? 0) || 0;
        const net = Number(r.totalNet ?? (revenue - cost)) || 0;
        const marge = revenue ? ((net / revenue) * 100).toFixed(2) : '0.00';
        const ecart = revenue - cost;
        return [
          r.codePack || '',
          (r.entreprise || '').replace(/,/g, ' '),
          r.dateOperation || r.dateCreation || '',
          r.dateEnreg || '',
          ecart.toFixed(2),
          revenue.toFixed(2),
          cost.toFixed(2),
          net.toFixed(2),
          marge,
          r.nbrMedecin || r.nbrMed || 0,
          r.nbrInfirmier || r.nbrInf || 0,
          r.nbrTechRadio || r.nbrTech || 0
        ].join(',');
      })).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'data_offre.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    function renderReconciliationPagination(totalPages) {
      const container = document.getElementById('reconciliationTablePagination');
      if (!container) return;

      const prevDisabled = recTablePage <= 1 ? 'disabled' : '';
      const nextDisabled = recTablePage >= totalPages ? 'disabled' : '';

      let html = `<button ${prevDisabled} onclick="renderReconciliationTable(${recTablePage - 1})">Précédent</button>`;
      for (let p = 1; p <= totalPages; p++) {
        const activeClass = p === recTablePage ? 'active' : '';
        html += `<button class="${activeClass}" onclick="renderReconciliationTable(${p})">${p}</button>`;
      }
      html += `<button ${nextDisabled} onclick="renderReconciliationTable(${recTablePage + 1})">Suivant</button>`;

      container.innerHTML = html;
    }
    // Additional functions for personnel tables
    function loadMedecinsTable() {
      google.script.run.withSuccessHandler(displayPersonnelTable.bind(null, 'med')).getMedecinsFull();
    }
    function loadInfirmiersTable() {
      google.script.run.withSuccessHandler(displayPersonnelTable.bind(null, 'inf')).getInfirmiersFull();
    }
    function loadTechRadiosTable() {
      google.script.run.withSuccessHandler(displayPersonnelTable.bind(null, 'tech')).getTechRadiosFull();
    }
    function loadCoordinateursTable() {
      google.script.run.withSuccessHandler(displayCoordTable).getCoordinateursFull();
    }
    function loadMaterielsTable() {
      google.script.run.withSuccessHandler(displayMatTable).getMaterielsFull();
    }
    function loadEntreprisesTable() {
      google.script.run.withSuccessHandler(displayEntTable).getEntreprisesFull();
    }
    function displayPersonnelTable(type, data) {
      const bodyId = type + 'Body';
      const body = document.getElementById(bodyId);
      body.innerHTML = '';
      data.forEach(person => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${person.code}</td>
          <td><input type="text" value="${person.nom}"></td>
          <td><input type="text" value="${person.prenom}"></td>
          <td><input type="text" value="${person.tel}"></td>
          <td><input type="text" value="${person.wilaya}"></td>
          <td>
            <button class="btn-primary btn-small" onclick="savePersonnelEdit('${type}', this)"><span class="material-icons">save</span> Sauvegarder</button>
            <button class="btn-danger btn-small" onclick="deletePersonnel('${type}', ${person.code})"><span class="material-icons">delete</span> Supprimer</button>
          </td>
        `;
        body.appendChild(row);
      });
    }
    function displayCoordTable(data) {
      const body = document.getElementById('coordBody');
      body.innerHTML = '';
      data.forEach(coord => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${coord.code}</td>
          <td><input type="text" value="${coord.nom}"></td>
          <td>
            <button class="btn-primary btn-small" onclick="saveItemEdit('Coordination', this, ${coord.code})"><span class="material-icons">save</span> Sauvegarder</button>
            <button class="btn-danger btn-small" onclick="deleteItem('Coordination', ${coord.code})"><span class="material-icons">delete</span> Supprimer</button>
          </td>
        `;
        body.appendChild(row);
      });
    }
    function displayMatTable(data) {
      const body = document.getElementById('matBody');
      body.innerHTML = '';
      data.forEach(mat => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${mat.code}</td>
          <td><input type="text" value="${mat.nom}"></td>
          <td>
            <button class="btn-primary btn-small" onclick="saveItemEdit('Materiel', this, ${mat.code})"><span class="material-icons">save</span> Sauvegarder</button>
            <button class="btn-danger btn-small" onclick="deleteItem('Materiel', ${mat.code})"><span class="material-icons">delete</span> Supprimer</button>
          </td>
        `;
        body.appendChild(row);
      });
    }
    function displayEntTable(data) {
      const body = document.getElementById('entBody');
      body.innerHTML = '';
      data.forEach(ent => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${ent.code}</td>
          <td><input type="text" value="${ent.nom}"></td>
          <td>
            <button class="btn-primary btn-small" onclick="saveItemEdit('Entreprise', this, ${ent.code})"><span class="material-icons">save</span> Sauvegarder</button>
            <button class="btn-danger btn-small" onclick="deleteItem('Entreprise', ${ent.code})"><span class="material-icons">delete</span> Supprimer</button>
          </td>
        `;
        body.appendChild(row);
      });
    }
    function savePersonnelEdit(type, button) {
      const row = button.closest('tr');
      const inputs = row.querySelectorAll('input');
      const nom = inputs[0].value.trim();
      const prenom = inputs[1].value.trim();
      const tel = inputs[2].value.trim();
      const wilaya = inputs[3].value.trim();
      const code = row.cells[0].textContent;
      if (!nom || !prenom || !tel || !wilaya) {
        showAlert('Tous les champs sont obligatoires.', 'error');
        return;
      }
      google.script.run.withSuccessHandler(() => onSuccess('Mis à jour.')).withFailureHandler(onFailure).updatePersonnel(getSheetName(type), code, nom, prenom, tel, wilaya);
    }
    function deletePersonnel(type, code) {
      if (confirm('Supprimer cet élément ?')) {
        google.script.run.withSuccessHandler(() => onSuccess('Supprimé.')).withFailureHandler(onFailure).deleteItem(getSheetName(type), code);
      }
    }
    function getSheetName(type) {
      switch(type) {
        case 'med': return "Médecin";
        case 'inf': return 'Infirmier';
        case 'tech': return 'Tech Radio';
      }
    }
    function saveItemEdit(sheetName, button, code) {
      const row = button.closest('tr');
      const input = row.querySelector('input');
      const value = input.value.trim();
      if (!value) {
        showAlert('Valeur obligatoire.', 'error');
        return;
      }
      google.script.run.withSuccessHandler(() => onSuccess('Mis à jour.')).withFailureHandler(onFailure).updateItem(sheetName, code, value);
    }
    function deleteItem(sheetName, code) {
      if (confirm('Supprimer cet élément ?')) {
        google.script.run.withSuccessHandler(() => onSuccess('Supprimé.')).withFailureHandler(onFailure).deleteItem(sheetName, code);
      }
    }
    function filterMedecins() {
      const nom = document.getElementById('filterMedNom').value.toLowerCase();
      const prenom = document.getElementById('filterMedPrenom').value.toLowerCase();
      const tel = document.getElementById('filterMedTel').value.toLowerCase();
      const wilaya = document.getElementById('filterMedWilaya').value.toLowerCase();
      const rows = document.querySelectorAll('#medBody tr');
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const match = (!nom || inputs[0].value.toLowerCase().includes(nom)) &&
                      (!prenom || inputs[1].value.toLowerCase().includes(prenom)) &&
                      (!tel || inputs[2].value.toLowerCase().includes(tel)) &&
                      (!wilaya || inputs[3].value.toLowerCase().includes(wilaya));
        row.style.display = match ? '' : 'none';
      });
    }
    // Similar for other filters
    function filterInfirmiers() {
      const nom = document.getElementById('filterInfNom').value.toLowerCase();
      const prenom = document.getElementById('filterInfPrenom').value.toLowerCase();
      const tel = document.getElementById('filterInfTel').value.toLowerCase();
      const wilaya = document.getElementById('filterInfWilaya').value.toLowerCase();
      const rows = document.querySelectorAll('#infBody tr');
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const match = (!nom || inputs[0].value.toLowerCase().includes(nom)) &&
                      (!prenom || inputs[1].value.toLowerCase().includes(prenom)) &&
                      (!tel || inputs[2].value.toLowerCase().includes(tel)) &&
                      (!wilaya || inputs[3].value.toLowerCase().includes(wilaya));
        row.style.display = match ? '' : 'none';
      });
    }
    function filterTechRadios() {
      const nom = document.getElementById('filterTechNom').value.toLowerCase();
      const prenom = document.getElementById('filterTechPrenom').value.toLowerCase();
      const tel = document.getElementById('filterTechTel').value.toLowerCase();
      const wilaya = document.getElementById('filterTechWilaya').value.toLowerCase();
      const rows = document.querySelectorAll('#techBody tr');
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const match = (!nom || inputs[0].value.toLowerCase().includes(nom)) &&
                      (!prenom || inputs[1].value.toLowerCase().includes(prenom)) &&
                      (!tel || inputs[2].value.toLowerCase().includes(tel)) &&
                      (!wilaya || inputs[3].value.toLowerCase().includes(wilaya));
        row.style.display = match ? '' : 'none';
      });
    }
    function filterCoordinateurs() {
      const nom = document.getElementById('filterCoordNom').value.toLowerCase();
      const rows = document.querySelectorAll('#coordBody tr');
      rows.forEach(row => {
        const input = row.querySelector('input');
        const match = !nom || input.value.toLowerCase().includes(nom);
        row.style.display = match ? '' : 'none';
      });
    }
    function filterMateriels() {
      const nom = document.getElementById('filterMatNom').value.toLowerCase();
      const rows = document.querySelectorAll('#matBody tr');
      rows.forEach(row => {
        const input = row.querySelector('input');
        const match = !nom || input.value.toLowerCase().includes(nom);
        row.style.display = match ? '' : 'none';
      });
    }
    function filterEntreprises() {
      const nom = document.getElementById('filterEntNom').value.toLowerCase();
      const rows = document.querySelectorAll('#entBody tr');
      rows.forEach(row => {
        const input = row.querySelector('input');
        const match = !nom || input.value.toLowerCase().includes(nom);
        row.style.display = match ? '' : 'none';
      });
    }
    function showLoader(show) {
      document.getElementById('loader').style.display = show ? 'block' : 'none';
    }
    function loadWilayaForPersonnel(input, type) {
      const name = input.value.trim();
      if (name) {
        let sheetName;
        if (type === 'medecin') sheetName = 'Médecin';
        else if (type === 'infirmier') sheetName = 'Infirmier';
        else if (type === 'tech-radio') sheetName = 'Tech Radio';
        else sheetName = 'Logistique';

        if (sheetName) {
          google.script.run
            .withSuccessHandler(wilaya => {
              // Support nouveau format accordion et ancien format
              let wilayaInput = input.closest('.personnel-row-accordion')?.querySelector('.wilaya-input');
              if (!wilayaInput) {
                wilayaInput = input.closest('.personnel-row')?.querySelector('.wilaya-input');
              }
              if (wilayaInput) {
                wilayaInput.value = wilaya || '';
              } else {
                console.error('Champ wilaya-input non trouvé dans la ligne.');
              }
            })
            .withFailureHandler(error => {
              console.error('Erreur lors du chargement de la wilaya :', error);
              onFailure(error);
            })
            .getWilayaForPersonnel(sheetName, name);
        } else {
          console.warn(`Type non reconnu: ${type}`);
        }
      }
    }
    // === SETTINGS FUNCTIONS ===
    function saveMarginThreshold() {
      const threshold = parseFloat(document.getElementById('marginThreshold').value);
      if (isNaN(threshold) || threshold < 0 || threshold > 100) {
        showAlert('Veuillez entrer un seuil valide entre 0 et 100', 'error');
        return;
      }
      localStorage.setItem('marginValidationThreshold', threshold.toString());
      const successDiv = document.getElementById('settingsSuccess');
      successDiv.textContent = `Seuil de validation sauvegardé: ${threshold}%`;
      successDiv.style.display = 'block';
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 3000);
      
      // Log audit
      logAudit('Modification Paramètres', `Seuil de validation changé à ${threshold}%`);
    }
    function loadMarginThreshold() {
      const threshold = localStorage.getItem('marginValidationThreshold') || '70';
      const input = document.getElementById('marginThreshold');
      if (input) {
        input.value = threshold;
      }
    }
    
    // Functions for Calculation Parameters
    function saveCalculationParameters() {
      const params = {
        calculeJourMedecin: parseFloat(document.getElementById('paramCalculeJourMedecin').value) || 20,
        calculeJourInfirmier: parseFloat(document.getElementById('paramCalculeJourInfirmier').value) || 30,
        calculeJourTechRadio: parseFloat(document.getElementById('paramCalculeJourTechRadio').value) || 30,
        tauxJourMedecin: parseFloat(document.getElementById('paramTauxJourMedecin').value) || 5000,
        tauxJourInfirmier: parseFloat(document.getElementById('paramTauxJourInfirmier').value) || 4000,
        tauxJourTechRadio: parseFloat(document.getElementById('paramTauxJourTechRadio').value) || 4000,
        tarifKm: parseFloat(document.getElementById('paramTarifKm').value) || 15,
        tarifKmMateriel: parseFloat(document.getElementById('paramTarifKmMateriel').value) || 25,
        tarifAvion: parseFloat(document.getElementById('paramTarifAvion').value) || 13500,
        tarifNuitMedecin: parseFloat(document.getElementById('paramTarifNuitMedecin').value) || 5000,
        tarifNuitInfirmier: parseFloat(document.getElementById('paramTarifNuitInfirmier').value) || 4000,
        tarifNuitTechRadio: parseFloat(document.getElementById('paramTarifNuitTechRadio').value) || 4000,
        tarifYalidine: parseFloat(document.getElementById('paramTarifYalidine').value) || 950,
        prixVisiteLieux: parseFloat(document.getElementById('paramPrixVisiteLieux').value) || 30000,
        deplacementLogistique: parseFloat(document.getElementById('paramDeplacementLogistique').value) || 1500
      };
      
      localStorage.setItem('calculationParameters', JSON.stringify(params));
      
      // Update global calculation inputs if they exist
      const globalCalcMed = document.getElementById('global-calcule-jour-medecin');
      const globalCalcInf = document.getElementById('global-calcule-jour-infirmier');
      const globalCalcTech = document.getElementById('global-calcule-jour-tech-radio');
      if (globalCalcMed) globalCalcMed.value = params.calculeJourMedecin;
      if (globalCalcInf) globalCalcInf.value = params.calculeJourInfirmier;
      if (globalCalcTech) globalCalcTech.value = params.calculeJourTechRadio;
      
      // Update R-H tab global calculations
      const globalCalcMedCalcule = document.getElementById('global-calcule-jour-medecin-calcule');
      const globalCalcInfCalcule = document.getElementById('global-calcule-jour-infirmier-calcule');
      const globalCalcTechCalcule = document.getElementById('global-calcule-jour-tech-radio-calcule');
      if (globalCalcMedCalcule) globalCalcMedCalcule.value = params.calculeJourMedecin;
      if (globalCalcInfCalcule) globalCalcInfCalcule.value = params.calculeJourInfirmier;
      if (globalCalcTechCalcule) globalCalcTechCalcule.value = params.calculeJourTechRadio;
      
      const successDiv = document.getElementById('calcParamSuccess');
      successDiv.textContent = 'Paramètres de calcul sauvegardés avec succès!';
      successDiv.style.display = 'block';
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 3000);
      
      logAudit('Modification Paramètres', 'Paramètres de calcul mis à jour');
    }
    
    function loadCalculationParameters() {
      const saved = localStorage.getItem('calculationParameters');
      const params = saved ? JSON.parse(saved) : {
        calculeJourMedecin: 20,
        calculeJourInfirmier: 30,
        calculeJourTechRadio: 30,
        tauxJourMedecin: 5000,
        tauxJourInfirmier: 4000,
        tauxJourTechRadio: 4000,
        tarifKm: 15,
        tarifKmMateriel: 25,
        tarifAvion: 13500,
        tarifNuitMedecin: 5000,
        tarifNuitInfirmier: 4000,
        tarifNuitTechRadio: 4000,
        tarifYalidine: 950,
        prixVisiteLieux: 30000,
        deplacementLogistique: 1500
      };
      
      // Load into settings form
      const setIfExists = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      };
      
      setIfExists('paramCalculeJourMedecin', params.calculeJourMedecin);
      setIfExists('paramCalculeJourInfirmier', params.calculeJourInfirmier);
      setIfExists('paramCalculeJourTechRadio', params.calculeJourTechRadio);
      setIfExists('paramTauxJourMedecin', params.tauxJourMedecin);
      setIfExists('paramTauxJourInfirmier', params.tauxJourInfirmier);
      setIfExists('paramTauxJourTechRadio', params.tauxJourTechRadio);
      setIfExists('paramTarifKm', params.tarifKm);
      setIfExists('paramTarifKmMateriel', params.tarifKmMateriel);
      setIfExists('paramTarifAvion', params.tarifAvion);
      setIfExists('paramTarifNuitMedecin', params.tarifNuitMedecin);
      setIfExists('paramTarifNuitInfirmier', params.tarifNuitInfirmier);
      setIfExists('paramTarifNuitTechRadio', params.tarifNuitTechRadio);
      setIfExists('paramTarifYalidine', params.tarifYalidine);
      setIfExists('paramPrixVisiteLieux', params.prixVisiteLieux);
      setIfExists('paramDeplacementLogistique', params.deplacementLogistique);
      
      // Apply to Pack tab global calculations
      setIfExists('global-calcule-jour-medecin', params.calculeJourMedecin);
      setIfExists('global-calcule-jour-infirmier', params.calculeJourInfirmier);
      setIfExists('global-calcule-jour-tech-radio', params.calculeJourTechRadio);
      
      // Apply to R-H tab global calculations
      setIfExists('global-calcule-jour-medecin-calcule', params.calculeJourMedecin);
      setIfExists('global-calcule-jour-infirmier-calcule', params.calculeJourInfirmier);
      setIfExists('global-calcule-jour-tech-radio-calcule', params.calculeJourTechRadio);
      
      // Apply Prix Visite Lieux to offer form
      setIfExists('prixVisiteLieux', params.prixVisiteLieux);
      
      return params;
    }
    
    // Helper function to get calculation parameters
    function getCalculationParam(paramName) {
      const saved = localStorage.getItem('calculationParameters');
      if (!saved) return null;
      const params = JSON.parse(saved);
      return params[paramName];
    }
    
    // === AUDIT TRAIL FUNCTIONS ===
    function loadAuditLogs() {
      const limit = parseInt(document.getElementById('auditLimit').value) || 100;
      const tbody = document.getElementById('auditTableBody');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Chargement...</td></tr>';
      
      google.script.run
        .withSuccessHandler(displayAuditLogs)
        .withFailureHandler(err => {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">Erreur: ${err}</td></tr>`;
        })
        .getAuditLogs(limit);
    }
    
    function displayAuditLogs(logs) {
      const tbody = document.getElementById('auditTableBody');
      
      if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Aucune entrée d\'audit trouvée</td></tr>';
        return;
      }
      
      let html = '';
      logs.forEach(log => {
        const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('fr-FR') : '';
        html += `
          <tr>
            <td>${timestamp}</td>
            <td>${log.user || ''}</td>
            <td><span style="background: #1e3d7d; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${log.role || ''}</span></td>
            <td><strong>${log.action || ''}</strong></td>
            <td>${log.details || ''}</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }
    
    // === FINANCE TAB FUNCTIONS ===
    function loadFinanceTab() {
      if (!allPackData || allPackData.length === 0) {
        loadAllPacksData();
      }
      if (!allCalculeData || allCalculeData.length === 0) {
        loadAllCalculeData();
      }
      
      // Get margin threshold from settings
      const marginThreshold = parseFloat(localStorage.getItem('marginValidationThreshold') || '70');
      
      // Calculate statistics
      let validated = 0;
      let pending = 0;
      let rejected = 0;
      let renewals = 0;
      
      allPackData.forEach(p => {
        const revenue = Number(p.totalRevenue || p.totalPrix || 0);
        const cost = Number(p.totalCost || 0);
        const net = Number(p.totalNet || (revenue - cost));
        const marge = revenue > 0 ? ((net / revenue) * 100) : 0;
        
        if (p.status === 'validé' || (p.status === 'calculé' && marge >= marginThreshold)) {
          validated++;
        } else if (p.status === 'calculé' && marge < marginThreshold) {
          pending++;
        } else if (p.status === 'non validé') {
          rejected++;
        }
      });
      
      document.getElementById('finance-validated').textContent = validated;
      document.getElementById('finance-pending').textContent = pending;
      document.getElementById('finance-rejected').textContent = rejected;
      document.getElementById('finance-renewals').textContent = renewals;
      
      renderFinanceTable();
    }
    
    function applyFinanceFilters() {
      renderFinanceTable();
    }
    
    function clearFinanceFilters() {
      document.getElementById('filterFinanceEntreprise').value = '';
      document.getElementById('filterFinanceCommercial').value = '';
      document.getElementById('filterFinanceCoordination').value = '';
      document.getElementById('filterFinanceStatus').value = '';
      renderFinanceTable();
    }
    
    function renderFinanceTable(page = 1) {
      const tbody = document.getElementById('financeTableBody');
      if (!tbody) return;
      
      const marginThreshold = parseFloat(localStorage.getItem('marginValidationThreshold') || '70');
      
      // Apply filters
      const filterEnt = document.getElementById('filterFinanceEntreprise')?.value.toLowerCase() || '';
      const filterComm = document.getElementById('filterFinanceCommercial')?.value.toLowerCase() || '';
      const filterCoord = document.getElementById('filterFinanceCoordination')?.value.toLowerCase() || '';
      const filterStatus = document.getElementById('filterFinanceStatus')?.value || '';
      
      const filtered = (allPackData || []).filter(p => {
        const passEnt = !filterEnt || (p.entreprise || '').toLowerCase().includes(filterEnt);
        const passComm = !filterComm || (p.commercial || '').toLowerCase().includes(filterComm);
        const passCoord = !filterCoord || (p.coordination || '').toLowerCase().includes(filterCoord);
        
        // Calculate finance status
        const revenue = Number(p.totalRevenue || p.totalPrix || 0);
        const cost = Number(p.totalCost || 0);
        const net = Number(p.totalNet || (revenue - cost));
        const marge = revenue > 0 ? ((net / revenue) * 100) : 0;
        let financeStatus = 'validé';
        if (p.status === 'non validé') {
          financeStatus = 'non validé';
        } else if (p.status === 'calculé' && marge < marginThreshold) {
          financeStatus = 'attente validation';
        }
        
        const passStatus = !filterStatus || financeStatus === filterStatus;
        
        return passEnt && passComm && passCoord && passStatus;
      });
      
      const pageSize = 10;
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      const safePage = Math.min(Math.max(page, 1), totalPages);
      const start = (safePage - 1) * pageSize;
      const slice = filtered.slice(start, start + pageSize);
      
      let htmlRows = '';
      slice.forEach(p => {
        const revenue = Number(p.totalRevenue || p.totalPrix || 0);
        const cost = Number(p.totalCost || 0);
        const net = Number(p.totalNet || (revenue - cost));
        const marge = revenue > 0 ? ((net / revenue) * 100) : 0;
        
        let financeStatus = 'validé';
        let statusClass = 'success';
        if (p.status === 'non validé') {
          financeStatus = 'non validé';
          statusClass = 'danger';
        } else if (p.status === 'calculé' && marge < marginThreshold) {
          financeStatus = 'attente validation';
          statusClass = 'warning';
        }
        
        htmlRows += `
          <tr>
            <td>${p.codePack || ''}</td>
            <td>${p.entreprise || ''}</td>
            <td>${p.commercial || ''}</td>
            <td>${p.coordination || ''}</td>
            <td>${p.dateEnreg || ''}</td>
            <td>${revenue.toFixed(2)}</td>
            <td>${cost.toFixed(2)}</td>
            <td>${net.toFixed(2)}</td>
            <td style="color: ${marge < marginThreshold ? '#dc3545' : '#28a745'}; font-weight: bold;">${marge.toFixed(2)}%</td>
            <td><span class="badge badge-${statusClass}">${financeStatus}</span></td>
            <td>
              <button class="btn-primary btn-small" onclick="showOfferValidation(${p.codePack})"><span class="material-icons">visibility</span> Voir</button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = htmlRows || '<tr><td colspan="11" style="text-align:center;">Aucune donnée disponible</td></tr>';
      
      const pag = document.getElementById('financePagination');
      if (pag) {
        let pagHtml = `<button ${safePage === 1 ? 'disabled' : ''} onclick="renderFinanceTable(${safePage - 1})">Précédent</button>`;
        for (let p = 1; p <= totalPages; p++) {
          pagHtml += `<button class="${p === safePage ? 'active' : ''}" onclick="renderFinanceTable(${p})">${p}</button>`;
        }
        pagHtml += `<button ${safePage === totalPages ? 'disabled' : ''} onclick="renderFinanceTable(${safePage + 1})">Suivant</button>`;
        pag.innerHTML = pagHtml;
      }
    }
    
    function showOfferValidation(codePack) {
      google.script.run.withSuccessHandler(details => {
        const panel = document.getElementById('financeValidationPanel');
        if (!panel) return;
        
        const revenue = Number(details.totalRevenue || details.totalPrix || 0);
        const cost = Number(details.totalCost || 0);
        const net = Number(details.totalNet || (revenue - cost));
        const marge = revenue > 0 ? ((net / revenue) * 100) : 0;
        const marginThreshold = parseFloat(localStorage.getItem('marginValidationThreshold') || '70');
        
        const detailsDiv = document.getElementById('financeOffreDetails');
        detailsDiv.innerHTML = `
          <div class="form-row">
            <div class="form-group">
              <strong>Code Pack:</strong> ${details.codePack}
            </div>
            <div class="form-group">
              <strong>Entreprise:</strong> ${details.entreprise}
            </div>
            <div class="form-group">
              <strong>Nom Pack:</strong> ${details.packName}
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <strong>Revenu Total:</strong> ${revenue.toFixed(2)} DA
            </div>
            <div class="form-group">
              <strong>Charges Totales:</strong> ${cost.toFixed(2)} DA
            </div>
            <div class="form-group">
              <strong>Net:</strong> ${net.toFixed(2)} DA
            </div>
            <div class="form-group">
              <strong>Marge:</strong> <span style="color: ${marge < marginThreshold ? '#dc3545' : '#28a745'}; font-weight: bold;">${marge.toFixed(2)}%</span>
              ${marge < marginThreshold ? '<br><span style="color: #dc3545; font-size: 0.9rem;">⚠️ Marge inférieure au seuil (' + marginThreshold + '%)</span>' : ''}
            </div>
          </div>
        `;
        
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth' });
        
        // Store current pack code for validation actions
        window.currentValidationPackCode = codePack;
      }).withFailureHandler(onFailure).getPackDetails(codePack);
    }
    
    function validateOffer() {
      if (!window.currentValidationPackCode) return;
      const comment = document.getElementById('financeComment').value;
      
      // Recommend but don't require comment for validation (unlike rejection)
      if (!comment) {
        if (!confirm('Valider sans commentaire ? Il est recommandé d\'ajouter un commentaire pour l\'audit trail.')) {
          return;
        }
      }
      
      google.script.run
        .withSuccessHandler(() => {
          showAlert('Offre validée avec succès', 'success');
          document.getElementById('financeValidationPanel').style.display = 'none';
          loadFinanceTab();
        })
        .withFailureHandler(onFailure)
        .validateOfferFinance(window.currentValidationPackCode, comment, currentUser.name, currentUser.role);
    }
    
    function rejectOffer() {
      if (!window.currentValidationPackCode) return;
      const comment = document.getElementById('financeComment').value;
      
      // Comment required for rejection for audit purposes
      if (!comment) {
        showAlert('Veuillez ajouter un commentaire pour le rejet (requis pour l\'audit)', 'error');
        return;
      }
      
      google.script.run
        .withSuccessHandler(() => {
          showAlert('Offre rejetée', 'success');
          document.getElementById('financeValidationPanel').style.display = 'none';
          loadFinanceTab();
        })
        .withFailureHandler(onFailure)
        .rejectOfferFinance(window.currentValidationPackCode, comment, currentUser.name, currentUser.role);
    }
    
    function reviewOffer() {
      if (!window.currentValidationPackCode) return;
      // Load pack details and switch to Pack tab for review
      google.script.run.withSuccessHandler(details => {
        // Switch to calcule tab to review
        showTab('calculeTab');
        // Pre-load the pack in calcule tab
        document.getElementById('entrepriseCalcule').value = details.entreprise;
        document.getElementById('packInputCalcule').value = details.packName;
        updateFromPackCalcule();
      }).withFailureHandler(onFailure).getPackDetails(window.currentValidationPackCode);
    }
    
    // === DASHBOARD FUNCTIONS ===
    function loadDashboard() {
      if (!allPackData || allPackData.length === 0) {
        loadAllPacksData();
      }
      
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Offres du mois et année
      const offresMois = allPackData.filter(p => {
        const d = new Date(p.dateEnreg);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      }).length;
      
      const offresAnnee = allPackData.filter(p => {
        const d = new Date(p.dateEnreg);
        return d.getFullYear() === currentYear;
      }).length;
      
      // Marge moyenne
      const calculated = allPackData.filter(p => p.status === 'calculé' || p.status === 'validé');
      let margeMoyenne = 0;
      if (calculated.length > 0) {
        const totalMarge = calculated.reduce((sum, p) => {
          const marge = p.totalRevenue > 0 ? ((p.totalNet / p.totalRevenue) * 100) : 0;
          return sum + marge;
        }, 0);
        margeMoyenne = (totalMarge / calculated.length).toFixed(1);
      }
      
      // Alertes 24h
      const uncalculated = allPackData.filter(p => p.status === 'à calculer');
      let alerte24h = 0;
      let alertePlus24h = 0;
      
      uncalculated.forEach(p => {
        const dateEnreg = new Date(p.dateEnreg);
        const hoursSince = (now - dateEnreg) / (1000 * 60 * 60);
        if (hoursSince <= 24) {
          alerte24h++;
        } else {
          alertePlus24h++;
        }
      });
      
      // Renouvellements (simulation - à implémenter avec data réelle)
      const renouvellements = 0;
      
      // Update dashboard
      document.getElementById('dash-offres-mois').textContent = offresMois;
      document.getElementById('dash-offres-annee').textContent = offresAnnee;
      document.getElementById('dash-marge-moyenne').textContent = margeMoyenne + '%';
      document.getElementById('dash-alerte-24h').textContent = alerte24h;
      document.getElementById('dash-alerte-plus24h').textContent = alertePlus24h;
      document.getElementById('dash-renouvellements').textContent = renouvellements;
      
      // Top entreprises
      loadTopEntreprises();
      loadTopCommerciaux();
      loadTopCoordinateurs();
    }
    
    function loadTopEntreprises() {
      if (!allPackData || allPackData.length === 0) return;
      
      // Calculer marge par entreprise
      const entrepriseMarges = {};
      allPackData.forEach(p => {
        if (p.status === 'calculé' && p.totalRevenue > 0) {
          const marge = ((p.totalNet / p.totalRevenue) * 100);
          if (!entrepriseMarges[p.entreprise]) {
            entrepriseMarges[p.entreprise] = { total: 0, count: 0 };
          }
          entrepriseMarges[p.entreprise].total += marge;
          entrepriseMarges[p.entreprise].count += 1;
        }
      });
      
      // Calculer moyennes et trier
      const entreprises = Object.keys(entrepriseMarges).map(name => ({
        name,
        marge: (entrepriseMarges[name].total / entrepriseMarges[name].count).toFixed(1)
      }));
      
      const sortedHigh = entreprises.sort((a, b) => b.marge - a.marge).slice(0, 10);
      const sortedLow = entreprises.sort((a, b) => a.marge - b.marge).slice(0, 5);
      
      // Afficher top 10
      const highList = document.getElementById('top-entreprises-high');
      highList.innerHTML = sortedHigh.map((e, i) => `
        <li class="top-list-item">
          <span class="rank">#${i+1}</span>
          <span class="name">${e.name}</span>
          <span class="value">${e.marge}%</span>
        </li>
      `).join('');
      
      // Afficher bottom 5
      const lowList = document.getElementById('top-entreprises-low');
      lowList.innerHTML = sortedLow.map((e, i) => `
        <li class="top-list-item">
          <span class="rank">#${i+1}</span>
          <span class="name">${e.name}</span>
          <span class="value" style="color: #f44336;">${e.marge}%</span>
        </li>
      `).join('');
    }
    
    function loadTopCommerciaux() {
      // Simulation - à implémenter avec data réelle de Commercial sheet
      const topList = document.getElementById('top-commerciaux');
      topList.innerHTML = `
        <li class="top-list-item">
          <span class="rank">#1</span>
          <span class="name">À implémenter</span>
          <span class="value">-</span>
        </li>
      `;
    }
    
    function loadTopCoordinateurs() {
      // Compter missions par coordinateur
      const coordCounts = {};
      if (allMissions && allMissions.length > 0) {
        allMissions.forEach(m => {
          if (m.coordination) {
            coordCounts[m.coordination] = (coordCounts[m.coordination] || 0) + 1;
          }
        });
      }
      
      const sorted = Object.keys(coordCounts)
        .map(name => ({ name, count: coordCounts[name] }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);
      
      const topList = document.getElementById('top-coordinateurs');
      if (sorted.length === 0) {
        topList.innerHTML = '<li class="top-list-item"><span class="name">Aucune donnée</span></li>';
      } else {
        topList.innerHTML = sorted.map((c, i) => `
          <li class="top-list-item">
            <span class="rank">#${i+1}</span>
            <span class="name">${c.name}</span>
            <span class="value">${c.count} missions</span>
          </li>
        `).join('');
      }
    }
    
    // === PROGRAMMATION PERSONNEL ===
    function loadProgPersonnel() {
      google.script.run.withSuccessHandler(data => {
        const tbody = document.getElementById('progPersonnelBody');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8">Aucune programmation trouvée</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.map(p => `
          <tr>
            <td>${p.nom}</td>
            <td>${p.type}</td>
            <td>${p.codeOpe}</td>
            <td>${p.entreprise}</td>
            <td>${p.site}</td>
            <td>${p.dateDebut}</td>
            <td>${p.dateFin}</td>
            <td><span class="badge ${p.statut === 'en cours' ? 'badge-success' : 'badge-info'}">${p.statut}</span></td>
          </tr>
        `).join('');
      }).withFailureHandler(onFailure).getProgPersonnel();
    }
    
    // === PROGRAMMATION MATERIEL ===
    function loadProgMateriel() {
      google.script.run.withSuccessHandler(data => {
        const tbody = document.getElementById('progMaterielBody');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7">Aucune programmation trouvée</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.map(m => `
          <tr>
            <td>${m.nom}</td>
            <td>${m.codeOpe}</td>
            <td>${m.entreprise}</td>
            <td>${m.site}</td>
            <td>${m.dateDebut}</td>
            <td>${m.dateFin}</td>
            <td><span class="badge ${m.statut === 'en cours' ? 'badge-success' : 'badge-info'}">${m.statut}</span></td>
          </tr>
        `).join('');
      }).withFailureHandler(onFailure).getProgMateriel();
    }
    
    // === RENOUVELLEMENT ===
    function loadOffresForRenewal() {
      const entreprise = document.getElementById('renouvelEntreprise').value.trim();
      if (!entreprise) {
        document.getElementById('renouvelOffre').innerHTML = '<option value="">-- Sélectionner une entreprise d\'abord --</option>';
        return;
      }
      
      google.script.run.withSuccessHandler(packs => {
        const select = document.getElementById('renouvelOffre');
        if (!packs || packs.length === 0) {
          select.innerHTML = '<option value="">Aucune offre trouvée</option>';
          return;
        }
        
        select.innerHTML = '<option value="">-- Sélectionner une offre --</option>' +
          packs.map(p => `<option value="${p.codePack}">${p.codePack} - ${p.packName}</option>`).join('');
      }).withFailureHandler(onFailure).getPacksByEntreprise(entreprise);
    }
    
    function loadOffreDetailsForRenewal() {
      const codePack = document.getElementById('renouvelOffre').value;
      if (!codePack) {
        document.getElementById('renouvelOffreDetails').style.display = 'none';
        return;
      }
      
      google.script.run.withSuccessHandler(details => {
        const infoDiv = document.getElementById('renouvelOffreInfo');
        infoDiv.innerHTML = `
          <p><strong>Code Pack:</strong> ${details.codePack}</p>
          <p><strong>Nom:</strong> ${details.packName}</p>
          <p><strong>Entreprise:</strong> ${details.entreprise}</p>
          <p><strong>Lieu:</strong> ${details.lieuEntreprise}</p>
          <p><strong>Nombre d'employés:</strong> ${details.totalEmployes}</p>
          <p><strong>Prix total:</strong> ${details.totalPrix} DA</p>
        `;
        document.getElementById('renouvelOffreDetails').style.display = 'block';
        
        // Set default dates (today + 1 year)
        const today = new Date();
        const nextYear = new Date(today.setFullYear(today.getFullYear() + 1));
        document.getElementById('renouvelNewDateDebut').value = new Date().toISOString().split('T')[0];
        document.getElementById('renouvelNewDateFin').value = nextYear.toISOString().split('T')[0];
      }).withFailureHandler(onFailure).getPackDetails(codePack);
    }
    
    function processRenewal(withModification) {
      const codePack = document.getElementById('renouvelOffre').value;
      const newDateDebut = document.getElementById('renouvelNewDateDebut').value;
      const newDateFin = document.getElementById('renouvelNewDateFin').value;
      
      if (!codePack || !newDateDebut || !newDateFin) {
        showAlert('Veuillez remplir tous les champs', 'error', 'renouvelError');
        return;
      }
      
      if (withModification) {
        // Load full pack details and pre-fill Pack tab with all data
        showAlert('Chargement de l\'offre pour modification...', 'success');
        
        google.script.run.withSuccessHandler(details => {
          // Switch to Pack tab
          showTab('packTab');
          
          // Pre-fill all fields from original offer
          document.getElementById('packName').value = details.packName + ' (Renouvellement)';
          document.getElementById('commercialPack').value = details.commercial || '';
          document.getElementById('entreprise').value = details.entreprise;
          document.getElementById('nbrEmployePack').value = details.totalEmployes;
          
          // Pre-fill calculation days
          document.getElementById('global-calcule-jour-medecin').value = details.calculeJourMedecin || 20;
          document.getElementById('global-calcule-jour-infirmier').value = details.calculeJourInfirmier || 30;
          document.getElementById('global-calcule-jour-tech-radio').value = details.calculeJourTechRadio || 30;
          
          // Pre-fill acts - this requires re-loading the acts and checking the appropriate ones
          if (details.acts && details.acts.length > 0) {
            // Clear existing sites first
            document.getElementById('siteContentsPack').innerHTML = '';
            document.getElementById('siteTabsPack').innerHTML = '';
            
            // Add first site and pre-fill with acts
            addSitePanel();
            
            // Delay to ensure DOM is ready, then pre-fill acts
            const PRE_FILL_DELAY = 500; // Configurable delay constant
            setTimeout(() => {
              const firstSite = document.querySelector('#siteContentsPack .site-panel');
              if (firstSite) {
                // Pre-fill site details
                const lieuInput = firstSite.querySelector('[id^="lieu-site-"]');
                if (lieuInput) lieuInput.value = details.lieuEntreprise || '';
                
                // Pre-check acts - iterate through all checkboxes and match by label text
                const actRows = firstSite.querySelectorAll('.act-row');
                details.acts.forEach(act => {
                  actRows.forEach(row => {
                    const label = row.querySelector('label');
                    if (label && label.textContent.trim().includes(act.acte)) {
                      const checkbox = row.querySelector('input[type="checkbox"]');
                      if (checkbox) {
                        checkbox.checked = true;
                        // Find and fill the quantity input
                        const qtyInput = row.querySelector('input[type="number"]');
                        if (qtyInput) qtyInput.value = act.nbrEmploye || 1;
                      }
                    }
                  });
                });
                
                // Pre-fill number of personnel
                const nbrMedInput = firstSite.querySelector('[id^="nbr-med-site-"]');
                const nbrInfInput = firstSite.querySelector('[id^="nbr-inf-site-"]');
                const nbrTechInput = firstSite.querySelector('[id^="nbr-tech-site-"]');
                if (nbrMedInput) nbrMedInput.value = details.nbrMed || 1;
                if (nbrInfInput) nbrInfInput.value = details.nbrInf || 1;
                if (nbrTechInput) nbrTechInput.value = details.nbrTech || 0;
              }
              
              // Recalculate totals
              recalcSite(0);
              recalcGlobalTotals();
            }, PRE_FILL_DELAY);
          }
          
          showAlert('Offre chargée pour modification. Modifiez les champs nécessaires puis enregistrez.', 'success');
        }).withFailureHandler(onFailure).getPackDetails(codePack);
        
      } else {
        // Renew directly without modification
        google.script.run.withSuccessHandler(message => {
          showAlert(message, 'success');
          document.getElementById('renouvelEntreprise').value = '';
          document.getElementById('renouvelOffre').innerHTML = '<option value="">-- Sélectionner une offre --</option>';
          document.getElementById('renouvelOffreDetails').style.display = 'none';
          // Mark as à calculer and notify R-H
          showAlert('Offre renouvelée avec succès. Elle est maintenant "à calculer" dans l\'onglet R-H.', 'success');
        }).withFailureHandler(onFailure).renewPack(codePack, newDateDebut, newDateFin);
      }
    }
    
    // === NOTIFICATION SYSTEM ===
    function toggleNotificationPanel() {
      const panel = document.getElementById('notificationPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      if (panel.style.display === 'block') {
        loadNotificationsPanel();
      }
    }
    function loadNotificationsPanel() {
      const list = document.getElementById('notificationList');
      const notifications = getNotifications();
      
      if (notifications.length === 0) {
        list.innerHTML = '<p style="color: #999; text-align: center;">Aucune notification</p>';
        return;
      }
      
      list.innerHTML = notifications.map((notif, index) => `
        <div class="notification-item ${notif.urgent ? 'urgent' : 'unread'}" onclick="handleNotificationClick(${index})">
          <strong>${notif.title}</strong>
          <p style="margin: 5px 0; font-size: 0.9rem;">${notif.message}</p>
          <div class="notification-time">${notif.time}</div>
        </div>
      `).join('');
    }
    function getNotifications() {
      const notifications = [];
      const now = new Date();
      const marginThreshold = parseFloat(localStorage.getItem('marginValidationThreshold') || '70');
      
      // Check for uncalculated offers
      if (allPackData && allPackData.length > 0) {
        const uncalculated = allPackData.filter(pack => pack.status === 'à calculer');
        
        uncalculated.forEach(pack => {
          const dateEnreg = new Date(pack.dateEnreg);
          const hoursSince = (now - dateEnreg) / (1000 * 60 * 60);
          
          if (hoursSince > 24) {
            notifications.push({
              title: '⚠️ Offre non calculée',
              message: `Pack "${pack.packName}" pour ${pack.entreprise} en attente depuis ${Math.floor(hoursSince)}h`,
              time: `Créé le ${pack.dateEnreg}`,
              urgent: true,
              action: () => showTab('calculeTab')
            });
          }
        });
      }
      
      // Check for finance validation needed (marge < threshold)
      if (allPackData && allPackData.length > 0) {
        allPackData.forEach(pack => {
          const revenue = Number(pack.totalRevenue || pack.totalPrix || 0);
          const cost = Number(pack.totalCost || 0);
          const net = Number(pack.totalNet || (revenue - cost));
          const marge = revenue > 0 ? ((net / revenue) * 100) : 0;
          
          if (pack.status === 'calculé' && marge < marginThreshold) {
            notifications.push({
              title: '💰 Validation Finance requise',
              message: `Pack "${pack.packName}" pour ${pack.entreprise} - Marge ${marge.toFixed(1)}% < ${marginThreshold}%`,
              time: 'En attente',
              urgent: false,
              action: () => {
                showTab('financeTab');
                showOfferValidation(pack.codePack);
              }
            });
          }
        });
        
        // Check for explicitly rejected offers
        const needsFinance = allPackData.filter(pack => pack.status === 'attente validation finance');
        
        needsFinance.forEach(pack => {
          notifications.push({
            title: '💰 Validation Finance requise',
            message: `Pack "${pack.packName}" pour ${pack.entreprise} nécessite validation Finance`,
            time: 'En attente',
            urgent: false,
            action: () => showTab('calculeTab')
          });
        });
      }
      
      return notifications;
    }
    function handleNotificationClick(index) {
      const notifications = getNotifications();
      if (notifications[index] && notifications[index].action) {
        notifications[index].action();
        toggleNotificationPanel();
      }
    }
    function updateNotificationBadge() {
      const notifications = getNotifications();
      const badge = document.getElementById('notificationBadge');
      const count = notifications.length;
      
      if (count > 0) {
        badge.textContent = count > 9 ? '9+' : count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    // === OPERATION MODIFICATION TRACKING ===
    function saveEditedMission() {
      const codeOpe = parseInt(document.getElementById('editCodeOpe').value);
      if (!codeOpe || isNaN(codeOpe)) {
        showAlert('Code opération invalide', 'error');
        return;
      }
      
      const updatedData = {
        codeOpe,
        coordination: document.getElementById('editCoordination').value,
        dateOperation: document.getElementById('editDateOperation').value,
        nbrEmployes: parseInt(document.getElementById('editNbrEmployes').value) || 0,
        lieu: document.getElementById('editLieu').value,
        deplacement: document.getElementById('editDeplacement').value,
        wilayaDepartMedecin: document.getElementById('editWilayaDepartMedecin').value,
        wilayaDepartInfirmier: document.getElementById('editWilayaDepartInfirmier').value,
        wilayaDepartTechRadio: document.getElementById('editWilayaDepartTechRadio').value,
        distanceMedecin: parseFloat(document.getElementById('editDistanceMedecin').value) || 0,
        distanceInfirmier: parseFloat(document.getElementById('editDistanceInfirmier').value) || 0,
        distanceTechRadio: parseFloat(document.getElementById('editDistanceTechRadio').value) || 0,
        materiels: Array.from(document.querySelectorAll('#editMateriels input:checked')).map(cb => cb.value).join(','),
        distanceMateriel: parseFloat(document.getElementById('editDistanceMateriel').value) || 0,
        nbrInfirmier: parseInt(document.getElementById('editNbrInfirmier').value) || 0,
        infirmiers: document.getElementById('editInfirmiers').value,
        medecins: document.getElementById('editMedecins').value,
        nbrMedecin: parseInt(document.getElementById('editNbrMedecin').value) || 0,
        techRadio: document.getElementById('editTechRadio').value,
        nbrTechRadio: parseInt(document.getElementById('editNbrTechRadio').value) || 0,
        hebergement: document.getElementById('editHebergement').value,
        dureeMed: parseInt(document.getElementById('editDureeMed').value) || 0,
        dureeInf: parseInt(document.getElementById('editDureeInf').value) || 0,
        dureeTech: parseInt(document.getElementById('editDureeTech').value) || 0,
        dureeLog: parseInt(document.getElementById('editDureeLog').value) || 0,
        frais: parseFloat(document.getElementById('editFrais').value) || 0,
        chargeSupp: parseFloat(document.getElementById('editChargeSupp').value) || 0,
        observation: document.getElementById('editObservation').value,
        dureeMission: parseInt(document.getElementById('editNbrJours').value) || 0,
        dateFin: document.getElementById('editDateFin').value,
        pack: document.getElementById('editPack').value,
        nbrLogistique: 1 // Default value
      };
      
      // Log the modification attempt
      logAudit('Tentative Modification Opération', `Début modification opération ${codeOpe} par ${currentUser.name}`);
      
      google.script.run
        .withSuccessHandler((result) => {
          showAlert(result, 'success');
          // Log successful modification
          logAudit('Modification Opération Réussie', `Opération ${codeOpe} modifiée avec succès`);
          // Reload missions
          loadMissions();
          // Clear form
          document.getElementById('editCodeOpe').value = '';
        })
        .withFailureHandler((error) => {
          showAlert('Erreur lors de la modification: ' + error, 'error');
          logAudit('Échec Modification Opération', `Échec modification opération ${codeOpe}: ${error}`);
        })
        .updateMissionWithUser(updatedData, currentUser.name, currentUser.role);
    }
    
  </script>
</body>
</html>
